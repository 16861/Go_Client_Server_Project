{"Command":"SaveFile","Payload":{"Hash":"Cv6nzy4_s_xCcjtmYPiQWoFSV0OdS5rZSup6xe9wKk0=","Data":"LyoKICBUaGlzIGZpbGUgaXMgcGFydCBvZiBEZWFkYmVlZiBQbGF5ZXIgc291cmNlIGNvZGUKICBodHRwOi8vZGVhZGJlZWYuc291cmNlZm9yZ2UubmV0CgogIHN0cmVhbWVyIGltcGxlbWVudGF0aW9uCgogIENvcHlyaWdodCAoQykgMjAwOS0yMDEzIEFsZXhleSBZYWtvdmVua28KCiAgVGhpcyBzb2Z0d2FyZSBpcyBwcm92aWRlZCAnYXMtaXMnLCB3aXRob3V0IGFueSBleHByZXNzIG9yIGltcGxpZWQKICB3YXJyYW50eS4gIEluIG5vIGV2ZW50IHdpbGwgdGhlIGF1dGhvcnMgYmUgaGVsZCBsaWFibGUgZm9yIGFueSBkYW1hZ2VzCiAgYXJpc2luZyBmcm9tIHRoZSB1c2Ugb2YgdGhpcyBzb2Z0d2FyZS4KCiAgUGVybWlzc2lvbiBpcyBncmFudGVkIHRvIGFueW9uZSB0byB1c2UgdGhpcyBzb2Z0d2FyZSBmb3IgYW55IHB1cnBvc2UsCiAgaW5jbHVkaW5nIGNvbW1lcmNpYWwgYXBwbGljYXRpb25zLCBhbmQgdG8gYWx0ZXIgaXQgYW5kIHJlZGlzdHJpYnV0ZSBpdAogIGZyZWVseSwgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIHJlc3RyaWN0aW9uczoKCiAgMS4gVGhlIG9yaWdpbiBvZiB0aGlzIHNvZnR3YXJlIG11c3Qgbm90IGJlIG1pc3JlcHJlc2VudGVkOyB5b3UgbXVzdCBub3QKICAgICBjbGFpbSB0aGF0IHlvdSB3cm90ZSB0aGUgb3JpZ2luYWwgc29mdHdhcmUuIElmIHlvdSB1c2UgdGhpcyBzb2Z0d2FyZQogICAgIGluIGEgcHJvZHVjdCwgYW4gYWNrbm93bGVkZ21lbnQgaW4gdGhlIHByb2R1Y3QgZG9jdW1lbnRhdGlvbiB3b3VsZCBiZQogICAgIGFwcHJlY2lhdGVkIGJ1dCBpcyBub3QgcmVxdWlyZWQuCiAgMi4gQWx0ZXJlZCBzb3VyY2UgdmVyc2lvbnMgbXVzdCBiZSBwbGFpbmx5IG1hcmtlZCBhcyBzdWNoLCBhbmQgbXVzdCBub3QgYmUKICAgICBtaXNyZXByZXNlbnRlZCBhcyBiZWluZyB0aGUgb3JpZ2luYWwgc29mdHdhcmUuCiAgMy4gVGhpcyBub3RpY2UgbWF5IG5vdCBiZSByZW1vdmVkIG9yIGFsdGVyZWQgZnJvbSBhbnkgc291cmNlIGRpc3RyaWJ1dGlvbi4KCiAgQWxleGV5IFlha292ZW5rbyB3YWtlckB1c2Vycy5zb3VyY2Vmb3JnZS5uZXQKKi8KI2luY2x1ZGUgPHN0ZGxpYi5oPgojaW5jbHVkZSA8c3RyaW5nLmg-CiNpbmNsdWRlIDxzdGRpby5oPgojaW5jbHVkZSA8YXNzZXJ0Lmg-CiNpbmNsdWRlIDx1bmlzdGQuaD4KI2lmZGVmIF9fbGludXhfXwojaW5jbHVkZSA8c3lzL3ByY3RsLmg-CiNlbmRpZgojaW5jbHVkZSA8c3lzL3RpbWUuaD4KI2luY2x1ZGUgPGVycm5vLmg-CiNpbmNsdWRlICJ0aHJlYWRpbmcuaCIKI2luY2x1ZGUgInBsYXlsaXN0LmgiCiNpbmNsdWRlICJjb21tb24uaCIKI2luY2x1ZGUgInN0cmVhbWVyLmgiCiNpbmNsdWRlICJtZXNzYWdlcHVtcC5oIgojaW5jbHVkZSAiY29uZi5oIgojaW5jbHVkZSAicGx1Z2lucy5oIgojaW5jbHVkZSAiZmFzdGZ0b2kuaCIKI2luY2x1ZGUgInZvbHVtZS5oIgojaW5jbHVkZSAidmZzLmgiCiNpbmNsdWRlICJwcmVtaXguaCIKI2luY2x1ZGUgInJpbmdidWYuaCIKI2luY2x1ZGUgInJlcGxheWdhaW4uaCIKI2luY2x1ZGUgImZmdC5oIgojaW5jbHVkZSAiaGFuZGxlci5oIgojaW5jbHVkZSAicGx1Z2lucy9saWJwYXJzZXIvcGFyc2VyLmgiCiNpbmNsdWRlICJzdHJkdXBhLmgiCiNpbmNsdWRlICJwbGF5cXVldWUuaCIKCi8vI2RlZmluZSB0cmFjZSguLi4pIHsgZnByaW50ZihzdGRlcnIsIF9fVkFfQVJHU19fKTsgfQojZGVmaW5lIHRyYWNlKGZtdCwuLi4pCgovLyNkZWZpbmUgV1JJVEVfRFVNUCAxCi8vI2RlZmluZSBERVRFQ1RfUExfTE9DS19SQyAxCgojaWYgV1JJVEVfRFVNUApGSUxFICpvdXQ7CiNlbmRpZgoKI2RlZmluZSBNQVhfUExBWUxJU1RfRE9XTkxPQURfU0laRSAyNTAwMAojZGVmaW5lIFNUUkVBTUVSX0hJTlRTIChEREJfREVDT0RFUl9ISU5UX05FRURfQklUUkFURXxEREJfREVDT0RFUl9ISU5UX0NBTl9MT09QKQoKc3RhdGljIGludApzdHJlYW1lcl9yZWFkX2FzeW5jIChjaGFyICpieXRlcywgaW50IHNpemUpOwoKc3RhdGljIGludApzdHJlYW1lcl9zZXRfb3V0cHV0X2Zvcm1hdCAodm9pZCk7CgpzdGF0aWMgaW50cHRyX3Qgc3RyZWFtZXJfdGlkOwpzdGF0aWMgZGRiX2RzcF9jb250ZXh0X3QgKmRzcF9jaGFpbjsKc3RhdGljIGZsb2F0IGRzcF9yYXRpbyA9IDE7CgpzdGF0aWMgREJfZHNwX3QgKmVxcGx1ZzsKc3RhdGljIGRkYl9kc3BfY29udGV4dF90ICplcTsKCnN0YXRpYyBpbnQgZHNwX29uID0gMDsKCnN0YXRpYyBjaGFyICpkc3BfaW5wdXRfYnVmZmVyOwpzdGF0aWMgaW50IGRzcF9pbnB1dF9idWZmZXJfc2l6ZTsKCnN0YXRpYyBjaGFyICpkc3BfdGVtcF9idWZmZXI7CnN0YXRpYyBpbnQgZHNwX3RlbXBfYnVmZmVyX3NpemU7CgpzdGF0aWMgaW50IGF1dG9jb252XzhfdG9fMTYgPSAxOwoKc3RhdGljIGludCBhdXRvY29udl8xNl90b18yNCA9IDA7CgpzdGF0aWMgaW50IHRyYWNlX2J1ZmZlcmZpbGwgPSAwOwoKc3RhdGljIGludCBzdG9wX2FmdGVyX2N1cnJlbnQgPSAwOwpzdGF0aWMgaW50IHN0b3BfYWZ0ZXJfYWxidW0gPSAwOwoKc3RhdGljIGludCBjb25mX3N0cmVhbWVyX25vc2xlZXAgPSAwOwoKc3RhdGljIGludCBzdHJlYW1pbmdfdGVybWluYXRlOwoKLy8gYnVmZmVyIHVwIHRvIDMgc2Vjb25kcyBhdCA0NDEwMEh6IHN0ZXJlbwojZGVmaW5lIFNUUkVBTV9CVUZGRVJfU0laRSAweDgwMDAwIC8vIHNsaWdodGx5IG1vcmUgdGhhbiAzIHNlY29uZHMgb2YgNDQxMDAgc3RlcmVvCgovLyBob3cgbXVjaCBiaWdnZXIgc2hvdWxkIHJlYWQtYnVmZmVyIGJlIHRvIGFsbG93IHVwc2FtcGxpbmcuCi8vIGUuZy4gODAwMEh6IC0-IDE5MjAwMEh6IHVwc2FtcGxpbmcgcmVxdWlyZXMgMjR4IGJ1ZmZlciBzaXplLAovLyBzbyBpZiB3ZSBvcmlnaW5hbGx5IHJlcXVlc3QgNDA5NiBieXRlcyBibG9ja3MgLQovLyB0aGF0IHdpbGwgcmVxdWlyZSAyNHggYnVmZmVyIHNpemUsIHdoaWNoIGlzIDk4MzA0IGJ5dGVzIGJ1ZmZlcgojZGVmaW5lIE1BWF9EU1BfUkFUSU8gMjQKCiNkZWZpbmUgTUlOX0JMT0NLX1NJWkUgNDA5NgojZGVmaW5lIE1BWF9CTE9DS19TSVpFIDE2Mzg0CiNkZWZpbmUgUkVBREJVRkZFUl9TSVpFIChNQVhfQkxPQ0tfU0laRSAqIE1BWF9EU1BfUkFUSU8pCnN0YXRpYyBjaGFyIHJlYWRidWZmZXJbUkVBREJVRkZFUl9TSVpFXTsKCnN0YXRpYyByaW5nYnVmX3Qgc3RyZWFtZXJfcmluZ2J1ZjsKc3RhdGljIGNoYXIgc3RyZWFtYnVmZmVyW1NUUkVBTV9CVUZGRVJfU0laRV07CgpzdGF0aWMgaW50IGJ5dGVzX3VudGlsX25leHRfc29uZyA9IDA7CnN0YXRpYyB1aW50cHRyX3QgbXV0ZXg7CnN0YXRpYyB1aW50cHRyX3QgY3VycnRyYWNrX211dGV4OwpzdGF0aWMgdWludHB0cl90IHdkbF9tdXRleDsgLy8gd2F2ZWRhdGEgbGlzdGVuZXIKCnN0YXRpYyBpbnQgbmV4dHNvbmcgPSAtMTsKc3RhdGljIGludCBuZXh0c29uZ19wc3RhdGUgPSAtMTsKc3RhdGljIGludCBiYWRzb25nID0gLTE7CgpzdGF0aWMgZmxvYXQgbGFzdF9zZWVrcG9zID0gLTE7CgpzdGF0aWMgZmxvYXQgcGxheXBvcyA9IDA7IC8vIHBsYXkgcG9zaXRpb24gb2YgY3VycmVudCBzb25nCnN0YXRpYyBpbnQgYXZnX2JpdHJhdGUgPSAtMTsgLy8gYXZnIGJpdHJhdGUgb2YgY3VycmVudCBzb25nCnN0YXRpYyBpbnQgbGFzdF9iaXRyYXRlID0gLTE7IC8vIGxhc3QgYml0cmF0ZSBvZiBjdXJyZW50IHNvbmcKCnN0YXRpYyBwbGF5bGlzdF90ICpzdHJlYW1lcl9wbGF5bGlzdDsKc3RhdGljIHBsYXlJdGVtX3QgKnBsYXlpbmdfdHJhY2s7CnN0YXRpYyBmbG9hdCBwbGF5dGltZTsgLy8gdG90YWwgcGxheXRpbWUgb2YgcGxheWluZyB0cmFjawpzdGF0aWMgdGltZV90IHN0YXJ0ZWRfdGltZXN0YW1wOyAvLyByZXN1bHQgb2YgY2FsbGluZyB0aW1lKE5VTEwpCnN0YXRpYyBwbGF5SXRlbV90ICpzdHJlYW1pbmdfdHJhY2s7CnN0YXRpYyBwbGF5SXRlbV90ICpwbGF5bGlzdF90cmFjazsKCnN0YXRpYyBkZGJfd2F2ZWZvcm1hdF90IG91dHB1dF9mb3JtYXQ7IC8vIGZvcm1hdCB0aGF0IHdhcyByZXF1ZXN0ZWQgYWZ0ZXIgRFNQCnN0YXRpYyBkZGJfd2F2ZWZvcm1hdF90IG9yaWdfb3V0cHV0X2Zvcm1hdDsgLy8gZm9ybWF0IHRoYXQgd2FzIHJlcXVlc3RlZCBiZWZvcmUgRFNQCnN0YXRpYyBpbnQgZm9ybWF0Y2hhbmdlZDsKCnN0YXRpYyBEQl9maWxlaW5mb190ICpmaWxlaW5mbzsKc3RhdGljIERCX0ZJTEUgKmZpbGVpbmZvX2ZpbGU7CnN0YXRpYyBEQl9maWxlaW5mb190ICpuZXdfZmlsZWluZm87CnN0YXRpYyBEQl9GSUxFICpuZXdfZmlsZWluZm9fZmlsZTsKCnN0YXRpYyBpbnQgc3RyZWFtZXJfYnVmZmVyaW5nOwoKLy8gdG8gYWxsb3cgaW50ZXJydXB0aW9uIG9mIHN0YWxsIGZpbGUgcmVxdWVzdHMKc3RhdGljIERCX0ZJTEUgKnN0cmVhbWVyX2ZpbGU7CgovLyBmb3IgdmlzIHBsdWdpbnMKc3RhdGljIGZsb2F0IGZyZXFfZGF0YVtEREJfRlJFUV9CQU5EUyAqIEREQl9GUkVRX01BWF9DSEFOTkVMU107CnN0YXRpYyBmbG9hdCBhdWRpb19kYXRhW0REQl9GUkVRX0JBTkRTICogMiAqIEREQl9GUkVRX01BWF9DSEFOTkVMU107CnN0YXRpYyBpbnQgYXVkaW9fZGF0YV9maWxsID0gMDsKc3RhdGljIGludCBhdWRpb19kYXRhX2NoYW5uZWxzID0gMDsKCi8vIG1lc3NhZ2UgcXVldWUKc3RhdGljIHN0cnVjdCBoYW5kbGVyX3MgKmhhbmRsZXI7CgovLyB2aXN1YWxpemF0aW9uIHN0dWZmCnR5cGVkZWYgc3RydWN0IHdhdmVkYXRhX2xpc3RlbmVyX3MgewogICAgdm9pZCAqY3R4OwogICAgdm9pZCAoKmNhbGxiYWNrKSh2b2lkICpjdHgsIGRkYl9hdWRpb19kYXRhX3QgKmRhdGEpOwogICAgc3RydWN0IHdhdmVkYXRhX2xpc3RlbmVyX3MgKm5leHQ7Cn0gd2F2ZWRhdGFfbGlzdGVuZXJfdDsKCnN0YXRpYyB3YXZlZGF0YV9saXN0ZW5lcl90ICp3YXZlZm9ybV9saXN0ZW5lcnM7CnN0YXRpYyB3YXZlZGF0YV9saXN0ZW5lcl90ICpzcGVjdHJ1bV9saXN0ZW5lcnM7CgojaWYgREVURUNUX1BMX0xPQ0tfUkMKdm9sYXRpbGUgcHRocmVhZF90IHN0cmVhbWVyX2xvY2tfdGlkID0gMDsKI2VuZGlmCnZvaWQKc3RyZWFtZXJfbG9jayAodm9pZCkgewojaWYgREVURUNUX1BMX0xPQ0tfUkMKICAgIGV4dGVybiBwdGhyZWFkX3QgcGxfbG9ja190aWQ7CiAgICBhc3NlcnQgKHBsX2xvY2tfdGlkICE9IHB0aHJlYWRfc2VsZigpKTsgLy8gbm90IHBlcm1pdHRlZCB0byBsb2NrIHN0cmVhbWVyIGZyb20gaW5zaWRlIG9mIHBsX2xvY2sKI2VuZGlmCiAgICBtdXRleF9sb2NrIChtdXRleCk7CiNpZiBERVRFQ1RfUExfTE9DS19SQwogICAgc3RyZWFtZXJfbG9ja190aWQgPSBwdGhyZWFkX3NlbGYoKTsKI2VuZGlmCn0KCnZvaWQKc3RyZWFtZXJfdW5sb2NrICh2b2lkKSB7CiNpZiBERVRFQ1RfUExfTE9DS19SQwogICAgc3RyZWFtZXJfbG9ja190aWQgPSAwOwojZW5kaWYKICAgIG11dGV4X3VubG9jayAobXV0ZXgpOwp9CgpzdGF0aWMgdm9pZApzdHJlYW1lcl9zZXRfbmV4dHNvbmdfcmVhbCAoaW50IHNvbmcsIGludCBwc3RhdGUpOwoKc3RhdGljIGludApzdHJlYW1lcl9tb3ZlX3RvX25leHRzb25nX3JlYWwgKGludCByKTsKCnN0YXRpYyBpbnQKc3RyZWFtZXJfbW92ZV90b19wcmV2c29uZ19yZWFsIChpbnQgcik7CgpzdGF0aWMgaW50CnN0cmVhbWVyX21vdmVfdG9fcmFuZG9tc29uZ19yZWFsIChpbnQgcik7CgpzdGF0aWMgdm9pZApzdHJlYW1lcl9wbGF5X2N1cnJlbnRfdHJhY2tfcmVhbCAodm9pZCk7CgpzdGF0aWMgdm9pZApzdHJlYW1lcl9zZXRfY3VycmVudF9wbGF5bGlzdF9yZWFsIChpbnQgcGx0KTsKCgpzdGF0aWMgdm9pZApzdHJlYW1lcl9hYm9ydF9maWxlcyAodm9pZCkgewogICAgREJfRklMRSAqZmlsZSA9IGZpbGVpbmZvX2ZpbGU7CiAgICBEQl9GSUxFICpuZXdmaWxlID0gbmV3X2ZpbGVpbmZvX2ZpbGU7CiAgICBEQl9GSUxFICpzdHJmaWxlID0gc3RyZWFtZXJfZmlsZTsKICAgIHRyYWNlICgiXDAzM1swOzMzbXN0cmVhbWVyX2Fib3J0X2ZpbGVzXDAzM1szNzswbVxuIik7CiAgICB0cmFjZSAoIiVwICVwICVwXG4iLCBmaWxlLCBuZXdmaWxlLCBzdHJmaWxlKTsKCiAgICBpZiAoZmlsZSkgewogICAgICAgIGRlYWRiZWVmLT5mYWJvcnQgKGZpbGUpOwogICAgfQogICAgaWYgKG5ld2ZpbGUpIHsKICAgICAgICBkZWFkYmVlZi0-ZmFib3J0IChuZXdmaWxlKTsKICAgIH0KICAgIGlmIChzdHJmaWxlKSB7CiAgICAgICAgZGVhZGJlZWYtPmZhYm9ydCAoc3RyZmlsZSk7CiAgICB9Cgp9CgpzdGF0aWMgdm9pZApzdHJlYW1lcl9zZXRfcmVwbGF5Z2FpbiAocGxheUl0ZW1fdCAqaXQpIHsKICAgIC8vIHNldHVwIHJlcGxheWdhaW4KICAgIHBsX2xvY2sgKCk7CiAgICBjb25zdCBjaGFyICpnYWluOwogICAgZ2FpbiA9IHBsX2ZpbmRfbWV0YSAoaXQsICI6UkVQTEFZR0FJTl9BTEJVTUdBSU4iKTsKICAgIGZsb2F0IGFsYnVtZ2FpbiA9IGdhaW4gPyBhdG9mIChnYWluKSA6IDEwMDA7CiAgICBmbG9hdCBhbGJ1bXBlYWsgPSBwbF9nZXRfaXRlbV9yZXBsYXlnYWluIChpdCwgRERCX1JFUExBWUdBSU5fQUxCVU1QRUFLKTsKCiAgICBnYWluID0gcGxfZmluZF9tZXRhIChpdCwgIjpSRVBMQVlHQUlOX1RSQUNLR0FJTiIpOwogICAgZmxvYXQgdHJhY2tnYWluID0gZ2FpbiA_IGF0b2YgKGdhaW4pIDogMTAwMDsKICAgIGZsb2F0IHRyYWNrcGVhayA9IHBsX2dldF9pdGVtX3JlcGxheWdhaW4gKGl0LCBEREJfUkVQTEFZR0FJTl9UUkFDS1BFQUspOwogICAgcGxfdW5sb2NrICgpOwogICAgcmVwbGF5Z2Fpbl9zZXRfdmFsdWVzIChhbGJ1bWdhaW4sIGFsYnVtcGVhaywgdHJhY2tnYWluLCB0cmFja3BlYWspOwp9CgpzdGF0aWMgdm9pZApzZW5kX3NvbmdzdGFydGVkIChwbGF5SXRlbV90ICp0cmspIHsKICAgIGRkYl9ldmVudF90cmFja190ICpwZXYgPSAoZGRiX2V2ZW50X3RyYWNrX3QgKiltZXNzYWdlcHVtcF9ldmVudF9hbGxvYyAoREJfRVZfU09OR1NUQVJURUQpOwogICAgcGV2LT50cmFjayA9IERCX1BMQVlJVEVNICh0cmspOwogICAgcGxfaXRlbV9yZWYgKHRyayk7CiAgICBwZXYtPnBsYXl0aW1lID0gMDsKICAgIHBldi0-c3RhcnRlZF90aW1lc3RhbXAgPSB0aW1lKE5VTEwpOwogICAgbWVzc2FnZXB1bXBfcHVzaF9ldmVudCAoKGRkYl9ldmVudF90KilwZXYsIDAsIDApOwp9CgpzdGF0aWMgdm9pZApzZW5kX3NvbmdmaW5pc2hlZCAocGxheUl0ZW1fdCAqdHJrKSB7CiAgICBkZGJfZXZlbnRfdHJhY2tfdCAqcGV2ID0gKGRkYl9ldmVudF90cmFja190ICopbWVzc2FnZXB1bXBfZXZlbnRfYWxsb2MgKERCX0VWX1NPTkdGSU5JU0hFRCk7CiAgICBwZXYtPnRyYWNrID0gREJfUExBWUlURU0gKHRyayk7CiAgICBwbF9pdGVtX3JlZiAodHJrKTsKICAgIHBldi0-cGxheXRpbWUgPSBwbGF5dGltZTsKICAgIHBldi0-c3RhcnRlZF90aW1lc3RhbXAgPSBzdGFydGVkX3RpbWVzdGFtcDsKICAgIG1lc3NhZ2VwdW1wX3B1c2hfZXZlbnQgKChkZGJfZXZlbnRfdCopcGV2LCAwLCAwKTsKfQoKc3RhdGljIHZvaWQKc2VuZF90cmFja2NoYW5nZWQgKHBsYXlJdGVtX3QgKmZyb20sIHBsYXlJdGVtX3QgKnRvKSB7CiAgICBkZGJfZXZlbnRfdHJhY2tjaGFuZ2VfdCAqZXZlbnQgPSAoZGRiX2V2ZW50X3RyYWNrY2hhbmdlX3QgKiltZXNzYWdlcHVtcF9ldmVudF9hbGxvYyAoREJfRVZfU09OR0NIQU5HRUQpOwogICAgZXZlbnQtPnBsYXl0aW1lID0gcGxheXRpbWU7CiAgICBldmVudC0-c3RhcnRlZF90aW1lc3RhbXAgPSBzdGFydGVkX3RpbWVzdGFtcDsKICAgIGlmIChmcm9tKSB7CiAgICAgICAgcGxfaXRlbV9yZWYgKGZyb20pOwogICAgfQogICAgaWYgKHRvKSB7CiAgICAgICAgcGxfaXRlbV9yZWYgKHRvKTsKICAgIH0KICAgIGV2ZW50LT5mcm9tID0gKERCX3BsYXlJdGVtX3QgKilmcm9tOwogICAgZXZlbnQtPnRvID0gKERCX3BsYXlJdGVtX3QgKil0bzsKICAgIG1lc3NhZ2VwdW1wX3B1c2hfZXZlbnQgKChkZGJfZXZlbnRfdCAqKWV2ZW50LCAwLCAwKTsKfQoKc3RhdGljIHZvaWQKc3RyZWFtZXJfc3RhcnRfcGxheWJhY2sgKHBsYXlJdGVtX3QgKmZyb20sIHBsYXlJdGVtX3QgKml0KSB7CiAgICBpZiAoZnJvbSkgewogICAgICAgIHBsX2l0ZW1fcmVmIChmcm9tKTsKICAgIH0KICAgIGlmIChpdCkgewogICAgICAgIHBsX2l0ZW1fcmVmIChpdCk7CiAgICB9CiAgICAvLyBmcmVlIG9sZCBjb3B5IG9mIHBsYXlpbmcKICAgIGlmIChwbGF5aW5nX3RyYWNrKSB7CiAgICAgICAgcGxfaXRlbV91bnJlZiAocGxheWluZ190cmFjayk7CiAgICAgICAgcGxheWluZ190cmFjayA9IE5VTEw7CiAgICB9CiAgICBwbF9sb2NrICgpOwogICAgcGxheWxpc3RfdHJhY2sgPSBpdDsKICAgIHBsX3VubG9jayAoKTsKICAgIC8vIGFzc2lnbiBuZXcKICAgIHBsYXlpbmdfdHJhY2sgPSBpdDsKICAgIGlmIChwbGF5aW5nX3RyYWNrKSB7CiAgICAgICAgcGxfaXRlbV9yZWYgKHBsYXlpbmdfdHJhY2spOwoKICAgICAgICBwbGF5aW5nX3RyYWNrLT5wbGF5ZWQgPSAxOwogICAgICAgIHRyYWNlICgiZnJvbT0lcCAoJXMpLCB0bz0lcCAoJXMpIFsyXVxuIiwgZnJvbSwgZnJvbSA_IHBsX2ZpbmRfbWV0YSAoZnJvbSwgIjpVUkkiKSA6ICJudWxsIiwgaXQsIGl0ID8gcGxfZmluZF9tZXRhIChpdCwgIjpVUkkiKSA6ICJudWxsIik7CiAgICAgICAgc2VuZF90cmFja2NoYW5nZWQgKGZyb20sIGl0KTsKICAgICAgICBzdGFydGVkX3RpbWVzdGFtcCA9IHRpbWUgKE5VTEwpOwogICAgfQogICAgaWYgKGZyb20pIHsKICAgICAgICBwbF9pdGVtX3VucmVmIChmcm9tKTsKICAgIH0KICAgIGlmIChpdCkgewogICAgICAgIHBsX2l0ZW1fdW5yZWYgKGl0KTsKICAgIH0KICAgIHRyYWNlICgic3RyZWFtZXJfc3RhcnRfcGxheWJhY2sgJXNcbiIsIHBsYXlpbmdfdHJhY2sgPyBwbF9maW5kX21ldGEgKHBsYXlpbmdfdHJhY2ssICI6VVJJIikgOiAibnVsbCIpOwp9CgpwbGF5SXRlbV90ICoKc3RyZWFtZXJfZ2V0X3N0cmVhbWluZ190cmFjayAodm9pZCkgewogICAgaWYgKHN0cmVhbWluZ190cmFjaykgewogICAgICAgIHBsX2l0ZW1fcmVmIChzdHJlYW1pbmdfdHJhY2spOwogICAgfQogICAgcmV0dXJuIHN0cmVhbWluZ190cmFjazsKfQoKcGxheUl0ZW1fdCAqCnN0cmVhbWVyX2dldF9wbGF5aW5nX3RyYWNrICh2b2lkKSB7CiAgICBwbGF5SXRlbV90ICppdCA9IHBsYXlpbmdfdHJhY2s7Ly8gPyBwbGF5aW5nX3RyYWNrIDogcGxheWxpc3RfdHJhY2s7CiAgICBpZiAoaXQpIHsKICAgICAgICBwbF9pdGVtX3JlZiAoaXQpOwogICAgfQogICAgcmV0dXJuIGl0Owp9CgppbnQKc3RyX2dldF9pZHhfb2YgKHBsYXlJdGVtX3QgKml0KSB7CiAgICBwbF9sb2NrICgpOwogICAgaWYgKCFzdHJlYW1lcl9wbGF5bGlzdCkgewogICAgICAgIHN0cmVhbWVyX3BsYXlsaXN0ID0gcGx0X2dldF9jdXJyICgpOwogICAgfQogICAgcGxheUl0ZW1fdCAqYyA9IHN0cmVhbWVyX3BsYXlsaXN0LT5oZWFkW1BMX01BSU5dOwogICAgaW50IGlkeCA9IDA7CiAgICB3aGlsZSAoYyAmJiBjICE9IGl0KSB7CiAgICAgICAgYyA9IGMtPm5leHRbUExfTUFJTl07CiAgICAgICAgaWR4Kys7CiAgICB9CiAgICBpZiAoIWMpIHsKICAgICAgICBwbF91bmxvY2sgKCk7CiAgICAgICAgcmV0dXJuIC0xOwogICAgfQogICAgcGxfdW5sb2NrICgpOwogICAgcmV0dXJuIGlkeDsKfQoKcGxheUl0ZW1fdCAqCnN0cl9nZXRfZm9yX2lkeCAoaW50IGlkeCkgewogICAgcGxfbG9jayAoKTsKICAgIGlmICghc3RyZWFtZXJfcGxheWxpc3QpIHsKICAgICAgICBzdHJlYW1lcl9wbGF5bGlzdCA9IHBsdF9nZXRfY3VyciAoKTsKICAgIH0KICAgIHBsYXlJdGVtX3QgKml0ID0gc3RyZWFtZXJfcGxheWxpc3QtPmhlYWRbUExfTUFJTl07CiAgICB3aGlsZSAoaWR4LS0pIHsKICAgICAgICBpZiAoIWl0KSB7CiAgICAgICAgICAgIHBsX3VubG9jayAoKTsKICAgICAgICAgICAgcmV0dXJuIE5VTEw7CiAgICAgICAgfQogICAgICAgIGl0ID0gaXQtPm5leHRbUExfTUFJTl07CiAgICB9CiAgICBpZiAoaXQpIHsKICAgICAgICBwbF9pdGVtX3JlZiAoaXQpOwogICAgfQogICAgcGxfdW5sb2NrICgpOwogICAgcmV0dXJuIGl0Owp9CgpzdGF0aWMgaW50CnN0b3BfYWZ0ZXJfYWxidW1fY2hlY2sgKHBsYXlJdGVtX3QgKmN1ciwgcGxheUl0ZW1fdCAqbmV4dCkgewogICAgaWYgKCFzdG9wX2FmdGVyX2FsYnVtKSB7CiAgICAgICAgcmV0dXJuIDA7CiAgICB9CgogICAgaWYgKCFjdXIpIHsKICAgICAgICByZXR1cm4gMDsKICAgIH0KCiAgICBpZiAoIW5leHQpIHsKICAgICAgICBzdHJlYW1lcl9idWZmZXJpbmcgPSAwOwogICAgICAgIHN0cmVhbWVyX3NldF9uZXh0c29uZ19yZWFsICgtMiwgLTIpOwogICAgICAgIGlmIChjb25mX2dldF9pbnQgKCJwbGF5bGlzdC5zdG9wX2FmdGVyX2FsYnVtX3Jlc2V0IiwgMCkpIHsKICAgICAgICAgICAgY29uZl9zZXRfaW50ICgicGxheWxpc3Quc3RvcF9hZnRlcl9hbGJ1bSIsIDApOwogICAgICAgICAgICBzdG9wX2FmdGVyX2FsYnVtID0gMDsKICAgICAgICAgICAgZGVhZGJlZWYtPnNlbmRtZXNzYWdlIChEQl9FVl9DT05GSUdDSEFOR0VELCAwLCAwLCAwKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIDE7CiAgICB9CgogICAgY29uc3QgY2hhciAqY3VyX2FsYnVtID0gcGxfZmluZF9tZXRhX3JhdyAoY3VyLCAiYWxidW0iKTsKICAgIGNvbnN0IGNoYXIgKm5leHRfYWxidW0gPSBwbF9maW5kX21ldGFfcmF3IChuZXh0LCAiYWxidW0iKTsKCiAgICBjb25zdCBjaGFyICprZXlzW10gPSB7CiAgICAgICAgImJhbmQiLAogICAgICAgICJhbGJ1bSBhcnRpc3QiLAogICAgICAgICJhbGJ1bWFydGlzdCIsCiAgICAgICAgImFydGlzdCIsCiAgICAgICAgTlVMTAogICAgfTsKCiAgICBjb25zdCBjaGFyICpjdXJfYXJ0aXN0ID0gTlVMTDsKICAgIGNvbnN0IGNoYXIgKm5leHRfYXJ0aXN0ID0gTlVMTDsKICAgIGZvciAoaW50IGkgPSAwOyBrZXlzW2ldOyBpKyspIHsKICAgICAgICBpZiAoIWN1cl9hcnRpc3QpIHsKICAgICAgICAgICAgY3VyX2FydGlzdCA9IHBsX2ZpbmRfbWV0YV9yYXcgKGN1ciwga2V5c1tpXSk7CiAgICAgICAgfQogICAgICAgIGlmICghbmV4dF9hcnRpc3QpIHsKICAgICAgICAgICAgbmV4dF9hcnRpc3QgPSBwbF9maW5kX21ldGFfcmF3IChuZXh0LCBrZXlzW2ldKTsKICAgICAgICB9CiAgICAgICAgaWYgKGN1cl9hcnRpc3QgJiYgbmV4dF9hcnRpc3QpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgfQoKICAgIGlmIChjdXJfYXJ0aXN0ID09IG5leHRfYXJ0aXN0ICYmIGN1cl9hbGJ1bSA9PSBuZXh0X2FsYnVtKSB7CiAgICAgICAgcmV0dXJuIDA7CiAgICB9CgogICAgc3RyZWFtZXJfYnVmZmVyaW5nID0gMDsKICAgIHN0cmVhbWVyX3NldF9uZXh0c29uZ19yZWFsICgtMiwgLTIpOwogICAgaWYgKGNvbmZfZ2V0X2ludCAoInBsYXlsaXN0LnN0b3BfYWZ0ZXJfYWxidW1fcmVzZXQiLCAwKSkgewogICAgICAgIGNvbmZfc2V0X2ludCAoInBsYXlsaXN0LnN0b3BfYWZ0ZXJfYWxidW0iLCAwKTsKICAgICAgICBzdG9wX2FmdGVyX2FsYnVtID0gMDsKICAgICAgICBkZWFkYmVlZi0-c2VuZG1lc3NhZ2UgKERCX0VWX0NPTkZJR0NIQU5HRUQsIDAsIDAsIDApOwogICAgfQoKICAgIHJldHVybiAxOwp9CgpzdGF0aWMgaW50CnN0cmVhbWVyX21vdmVfdG9fbmV4dHNvbmdfcmVhbCAoaW50IHJlYXNvbikgewogICAgaWYgKHJlYXNvbikgewogICAgICAgIHBsdWdfZ2V0X291dHB1dCAoKS0-c3RvcCAoKTsKICAgIH0KICAgIHRyYWNlICgic3RyZWFtZXJfbW92ZV90b19uZXh0c29uZyAoJWQpXG4iLCByZWFzb24pOwogICAgcGxfbG9jayAoKTsKICAgIGlmICghc3RyZWFtZXJfcGxheWxpc3QpIHsKICAgICAgICBzdHJlYW1lcl9wbGF5bGlzdCA9IHBsdF9nZXRfY3VyciAoKTsKICAgIH0KCiAgICBwbGF5SXRlbV90ICpjdXJyID0gcGxheWxpc3RfdHJhY2s7CgogICAgd2hpbGUgKHBsYXlxdWV1ZV9nZXRjb3VudCAoKSkgewogICAgICAgIHRyYWNlICgicGxheXF1ZXVlX2dldG5leHRcbiIpOwogICAgICAgIHBsYXlJdGVtX3QgKml0ID0gcGxheXF1ZXVlX2dldG5leHQgKCk7CiAgICAgICAgaWYgKGl0KSB7CiAgICAgICAgICAgIGlmIChzdG9wX2FmdGVyX2FsYnVtX2NoZWNrKGN1cnIsIGl0KSkgewogICAgICAgICAgICAgICAgcGxfdW5sb2NrICgpOwogICAgICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgICAgICB9CgogICAgICAgICAgICBwbGF5cXVldWVfcG9wICgpOwogICAgICAgICAgICBpbnQgciA9IHN0cl9nZXRfaWR4X29mIChpdCk7CiAgICAgICAgICAgIGlmIChyID49IDApIHsKICAgICAgICAgICAgICAgIHBsX2l0ZW1fdW5yZWYgKGl0KTsKICAgICAgICAgICAgICAgIHBsX3VubG9jayAoKTsKICAgICAgICAgICAgICAgIHN0cmVhbWVyX3NldF9uZXh0c29uZ19yZWFsIChyLCAxKTsKICAgICAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgdHJhY2UgKCIlcyBub3QgZm91bmQgaW4gY3VycmVudCBzdHJlYW1pbmcgcGxheWxpc3RcbiIsIHBsX2ZpbmRfbWV0YSAoaXQsICI6VVJJIikpOwoKICAgICAgICAgICAgICAgIHBsYXlsaXN0X3QgKnAgPSBwbF9nZXRfcGxheWxpc3QgKGl0KTsKICAgICAgICAgICAgICAgIGlmIChwKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0cmVhbWVyX3BsYXlsaXN0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHBsdF91bnJlZiAoc3RyZWFtZXJfcGxheWxpc3QpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBzdHJlYW1lcl9wbGF5bGlzdCA9IHA7CiAgICAgICAgICAgICAgICAgICAgaW50IHIgPSBzdHJfZ2V0X2lkeF9vZiAoaXQpOwogICAgICAgICAgICAgICAgICAgIGlmIChyID49IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGxfaXRlbV91bnJlZiAoaXQpOwogICAgICAgICAgICAgICAgICAgICAgICBwbF91bmxvY2sgKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0cmVhbWVyX3NldF9uZXh0c29uZ19yZWFsIChyLCAzKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdHJhY2UgKCIlcyBub3QgZm91bmQgaW4gYW55IHBsYXlsaXN0c1xuIiwgcGxfZmluZF9tZXRhIChpdCwgIjpVUkkiKSk7CiAgICAgICAgICAgICAgICBwbF9pdGVtX3VucmVmIChpdCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgaWYgKHJlYXNvbiA9PSAxKSB7CiAgICAgICAgaWYgKHN0cmVhbWVyX3BsYXlsaXN0KSB7CiAgICAgICAgICAgIHBsdF91bnJlZiAoc3RyZWFtZXJfcGxheWxpc3QpOwogICAgICAgIH0KICAgICAgICBzdHJlYW1lcl9wbGF5bGlzdCA9IHBsdF9nZXRfY3VyciAoKTsKICAgICAgICAvLyBjaGVjayBpZiBwcmV2IHNvbmcgaXMgaW4gdGhpcyBwbGF5bGlzdAogICAgICAgIGlmICgtMSA9PSBzdHJfZ2V0X2lkeF9vZiAoY3VycikpIHsKICAgICAgICAgICAgY3VyciA9IE5VTEw7CiAgICAgICAgfQogICAgfQoKICAgIHBsYXlsaXN0X3QgKnBsdCA9IHN0cmVhbWVyX3BsYXlsaXN0OwogICAgaWYgKCFwbHQtPmhlYWRbUExfTUFJTl0pIHsKICAgICAgICBwbF91bmxvY2sgKCk7CiAgICAgICAgc3RyZWFtZXJfc2V0X25leHRzb25nX3JlYWwgKC0yLCAxKTsKICAgICAgICByZXR1cm4gMDsKICAgIH0KICAgIGludCBwbF9vcmRlciA9IHBsX2dldF9vcmRlciAoKTsKCiAgICBpbnQgcGxfbG9vcF9tb2RlID0gY29uZl9nZXRfaW50ICgicGxheWJhY2subG9vcCIsIDApOwoKICAgIGlmIChyZWFzb24gPT0gMCAmJiBwbF9sb29wX21vZGUgPT0gUExBWUJBQ0tfTU9ERV9MT09QX1NJTkdMRSkgeyAvLyBzb25nIGZpbmlzaGVkLCBsb29wIG1vZGUgaXMgImxvb3AgMSB0cmFjayIKICAgICAgICBpbnQgciA9IHN0cl9nZXRfaWR4X29mIChwbGF5aW5nX3RyYWNrKTsKICAgICAgICBwbF91bmxvY2sgKCk7CiAgICAgICAgaWYgKHIgPT0gLTEpIHsKICAgICAgICAgICAgc3RyZWFtZXJfc2V0X25leHRzb25nX3JlYWwgKC0yLCAxKTsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHN0cmVhbWVyX3NldF9uZXh0c29uZ19yZWFsIChyLCAxKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIDA7CiAgICB9CgogICAgaWYgKHBsX29yZGVyID09IFBMQVlCQUNLX09SREVSX1NIVUZGTEVfVFJBQ0tTIHx8IHBsX29yZGVyID09IFBMQVlCQUNLX09SREVSX1NIVUZGTEVfQUxCVU1TKSB7IC8vIHNodWZmbGUKICAgICAgICBpZiAoIWN1cnIgfHwgcGxfb3JkZXIgPT0gUExBWUJBQ0tfT1JERVJfU0hVRkZMRV9UUkFDS1MpIHsKICAgICAgICAgICAgLy8gZmluZCBtaW5pbWFsIG5vdHBsYXllZAogICAgICAgICAgICBwbGF5SXRlbV90ICpwbWluID0gTlVMTDsgLy8gbm90cGxheWVkIG1pbmltdW0KICAgICAgICAgICAgZm9yIChwbGF5SXRlbV90ICppID0gcGx0LT5oZWFkW1BMX01BSU5dOyBpOyBpID0gaS0-bmV4dFtQTF9NQUlOXSkgewogICAgICAgICAgICAgICAgaWYgKGktPnBsYXllZCkgewogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCFwbWluIHx8IGktPnNodWZmbGVyYXRpbmcgPCBwbWluLT5zaHVmZmxlcmF0aW5nKSB7CiAgICAgICAgICAgICAgICAgICAgcG1pbiA9IGk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcGxheUl0ZW1fdCAqaXQgPSBwbWluOwogICAgICAgICAgICAvLyBhbHRob3VnaCBpdCBpcyBwb3NzaWJsZSB0aGF0LCBhbHRob3VnaCBpdCA9PSBOVUxMLCByZXNodWZmbGluZyB0aGUgcGxheWxpc3QKICAgICAgICAgICAgLy8gd2lsbCByZXN1bHQgaW4gdGhlIG5leHQgdHJhY2sgYmVsb25naW5nIHRvIHRoZSBzYW1lIGFsYnVtIGFzIHRoaXMgb25lLCB0aGlzCiAgICAgICAgICAgIC8vIGlzIG1vc3QgbGlrZWx5IG5vdCB3aGF0IHRoZSB1c2VyIHdhbnRzLgogICAgICAgICAgICBpZiAoc3RvcF9hZnRlcl9hbGJ1bV9jaGVjayhjdXJyLCBpdCkpIHsKICAgICAgICAgICAgICAgIHBsX3VubG9jayAoKTsKICAgICAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWl0KSB7CiAgICAgICAgICAgICAgICAvLyBhbGwgc29uZ3MgcGxheWVkLCByZXNodWZmbGUgYW5kIHRyeSBhZ2FpbgogICAgICAgICAgICAgICAgaWYgKHBsX2xvb3BfbW9kZSA9PSBQTEFZQkFDS19NT0RFX0xPT1BfQUxMKSB7IC8vIGxvb3AKICAgICAgICAgICAgICAgICAgICBwbHRfcmVzaHVmZmxlIChzdHJlYW1lcl9wbGF5bGlzdCwgJml0LCBOVUxMKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWl0KSB7CiAgICAgICAgICAgICAgICBzdHJlYW1lcl9idWZmZXJpbmcgPSAwOwogICAgICAgICAgICAgICAgc2VuZF90cmFja2luZm9jaGFuZ2VkIChzdHJlYW1pbmdfdHJhY2spOwogICAgICAgICAgICAgICAgcGxheUl0ZW1fdCAqdGVtcDsKICAgICAgICAgICAgICAgIHBsdF9yZXNodWZmbGUgKHN0cmVhbWVyX3BsYXlsaXN0LCAmdGVtcCwgTlVMTCk7CiAgICAgICAgICAgICAgICBwbF91bmxvY2sgKCk7CiAgICAgICAgICAgICAgICBzdHJlYW1lcl9zZXRfbmV4dHNvbmdfcmVhbCAoLTIsIC0yKTsKICAgICAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbnQgciA9IHN0cl9nZXRfaWR4X29mIChpdCk7CiAgICAgICAgICAgIHBsX3VubG9jayAoKTsKICAgICAgICAgICAgc3RyZWFtZXJfc2V0X25leHRzb25nX3JlYWwgKHIsIDEpOwogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIHRyYWNlICgicGxfbmV4dF9zb25nOiByZWFzb249JWQsIGxvb3A9JWRcbiIsIHJlYXNvbiwgcGxfbG9vcF9tb2RlKTsKICAgICAgICAgICAgLy8gZmluZCBtaW5pbWFsIG5vdHBsYXllZCBhYm92ZSBjdXJyZW50CiAgICAgICAgICAgIGludCByYXRpbmcgPSBjdXJyLT5zaHVmZmxlcmF0aW5nOwogICAgICAgICAgICBwbGF5SXRlbV90ICpwbWluID0gTlVMTDsgLy8gbm90cGxheWVkIG1pbmltdW0KICAgICAgICAgICAgZm9yIChwbGF5SXRlbV90ICppID0gcGx0LT5oZWFkW1BMX01BSU5dOyBpOyBpID0gaS0-bmV4dFtQTF9NQUlOXSkgewogICAgICAgICAgICAgICAgaWYgKGktPnBsYXllZCB8fCBpLT5zaHVmZmxlcmF0aW5nIDwgcmF0aW5nKSB7CiAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoIXBtaW4gfHwgaS0-c2h1ZmZsZXJhdGluZyA8IHBtaW4tPnNodWZmbGVyYXRpbmcpIHsKICAgICAgICAgICAgICAgICAgICBwbWluID0gaTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBwbGF5SXRlbV90ICppdCA9IHBtaW47CiAgICAgICAgICAgIGlmIChzdG9wX2FmdGVyX2FsYnVtX2NoZWNrKGN1cnIsIGl0KSkgewogICAgICAgICAgICAgICAgcGxfdW5sb2NrICgpOwogICAgICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghaXQpIHsKICAgICAgICAgICAgICAgIC8vIGFsbCBzb25ncyBwbGF5ZWQsIHJlc2h1ZmZsZSBhbmQgdHJ5IGFnYWluCiAgICAgICAgICAgICAgICBpZiAocGxfbG9vcF9tb2RlID09IFBMQVlCQUNLX01PREVfTE9PUF9BTEwgfHwgcmVhc29uID09IDEpIHsgLy8gbG9vcAogICAgICAgICAgICAgICAgICAgIHRyYWNlICgiYWxsIHNvbmdzIHBsYXllZCEgcmVzaHVmZmxlXG4iKTsKICAgICAgICAgICAgICAgICAgICBwbHRfcmVzaHVmZmxlIChzdHJlYW1lcl9wbGF5bGlzdCwgJml0LCBOVUxMKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWl0KSB7CiAgICAgICAgICAgICAgICBzdHJlYW1lcl9idWZmZXJpbmcgPSAwOwogICAgICAgICAgICAgICAgc2VuZF90cmFja2luZm9jaGFuZ2VkIChzdHJlYW1pbmdfdHJhY2spOwogICAgICAgICAgICAgICAgcGxheUl0ZW1fdCAqdGVtcDsKICAgICAgICAgICAgICAgIHBsdF9yZXNodWZmbGUgKHN0cmVhbWVyX3BsYXlsaXN0LCAmdGVtcCwgTlVMTCk7CiAgICAgICAgICAgICAgICBwbF91bmxvY2sgKCk7CiAgICAgICAgICAgICAgICBzdHJlYW1lcl9zZXRfbmV4dHNvbmdfcmVhbCAoLTIsIC0yKTsKICAgICAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbnQgciA9IHN0cl9nZXRfaWR4X29mIChpdCk7CiAgICAgICAgICAgIHBsX3VubG9jayAoKTsKICAgICAgICAgICAgc3RyZWFtZXJfc2V0X25leHRzb25nX3JlYWwgKHIsIDEpOwogICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CiAgICB9CiAgICBlbHNlIGlmIChwbF9vcmRlciA9PSBQTEFZQkFDS19PUkRFUl9MSU5FQVIpIHsgLy8gbGluZWFyCiAgICAgICAgREJfb3V0cHV0X3QgKm91dHB1dCA9IHBsdWdfZ2V0X291dHB1dCAoKTsKICAgICAgICBwbGF5SXRlbV90ICppdCA9IE5VTEw7CiAgICAgICAgaWYgKCFjdXJyICYmIG91dHB1dC0-c3RhdGUgKCkgPT0gT1VUUFVUX1NUQVRFX1NUT1BQRUQpIHsKICAgICAgICAgICAgaW50IGN1ciA9IHBsdF9nZXRfY3Vyc29yIChzdHJlYW1lcl9wbGF5bGlzdCwgUExfTUFJTik7CiAgICAgICAgICAgIGlmIChjdXIgIT0gLTEpIHsKICAgICAgICAgICAgICAgIGN1cnIgPSBwbHRfZ2V0X2l0ZW1fZm9yX2lkeCAoc3RyZWFtZXJfcGxheWxpc3QsIGN1ciwgUExfTUFJTik7CiAgICAgICAgICAgICAgICBwbF9pdGVtX3VucmVmIChjdXJyKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoY3VycikgewogICAgICAgICAgICBpdCA9IGN1cnItPm5leHRbUExfTUFJTl07CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICBpdCA9IHN0cmVhbWVyX3BsYXlsaXN0LT5oZWFkW1BMX01BSU5dOwogICAgICAgIH0KICAgICAgICBpZiAoc3RvcF9hZnRlcl9hbGJ1bV9jaGVjayhjdXJyLCBpdCkpIHsKICAgICAgICAgICAgcGxfdW5sb2NrICgpOwogICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgfQogICAgICAgIGlmICghaXQpIHsKICAgICAgICAgICAgdHJhY2UgKCJzdHJlYW1lcl9tb3ZlX25leHRzb25nOiB3YXMgbGFzdCB0cmFja1xuIik7CiAgICAgICAgICAgIGlmIChwbF9sb29wX21vZGUgPT0gUExBWUJBQ0tfTU9ERV9MT09QX0FMTCkgewogICAgICAgICAgICAgICAgaXQgPSBwbHQtPmhlYWRbUExfTUFJTl07CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBzdHJlYW1lcl9idWZmZXJpbmcgPSAwOwogICAgICAgICAgICAgICAgc2VuZF90cmFja2luZm9jaGFuZ2VkIChzdHJlYW1pbmdfdHJhY2spOwogICAgICAgICAgICAgICAgYmFkc29uZyA9IC0xOwogICAgICAgICAgICAgICAgcGxfdW5sb2NrICgpOwogICAgICAgICAgICAgICAgc3RyZWFtZXJfc2V0X25leHRzb25nX3JlYWwgKC0yLCAtMik7CiAgICAgICAgICAgICAgICByZXR1cm4gMDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIWl0KSB7CiAgICAgICAgICAgIHBsX3VubG9jayAoKTsKICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgIH0KICAgICAgICBpbnQgciA9IHN0cl9nZXRfaWR4X29mIChpdCk7CiAgICAgICAgcGxfdW5sb2NrICgpOwogICAgICAgIHN0cmVhbWVyX3NldF9uZXh0c29uZ19yZWFsIChyLCAxKTsKICAgICAgICByZXR1cm4gMDsKICAgIH0KICAgIGVsc2UgaWYgKHBsX29yZGVyID09IFBMQVlCQUNLX09SREVSX1JBTkRPTSkgeyAvLyByYW5kb20KICAgICAgICBwbF91bmxvY2sgKCk7CiAgICAgICAgaW50IHJlcyA9IHN0cmVhbWVyX21vdmVfdG9fcmFuZG9tc29uZ19yZWFsICgwKTsKICAgICAgICBpZiAocmVzID09IC0xKSB7CiAgICAgICAgICAgIHRyYWNlICgic3RyZWFtZXJfbW92ZV90b19yYW5kb21zb25nIGVycm9yXG4iKTsKICAgICAgICAgICAgc3RyZWFtZXJfc2V0X25leHRzb25nX3JlYWwgKC0yLCAxKTsKICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgIH0KICAgICAgICByZXR1cm4gMDsKICAgIH0KICAgIHBsX3VubG9jayAoKTsKICAgIHJldHVybiAtMTsKfQoKc3RhdGljIGludApzdHJlYW1lcl9tb3ZlX3RvX3ByZXZzb25nX3JlYWwgKGludCByKSB7CiAgICBpZiAocikgewogICAgICAgIHBsdWdfZ2V0X291dHB1dCAoKS0-c3RvcCAoKTsKICAgIH0KICAgIHBsX2xvY2sgKCk7CiAgICBpZiAoc3RyZWFtZXJfcGxheWxpc3QpIHsKICAgICAgICBwbHRfdW5yZWYgKHN0cmVhbWVyX3BsYXlsaXN0KTsKICAgIH0KICAgIHN0cmVhbWVyX3BsYXlsaXN0ID0gcGx0X2dldF9jdXJyICgpOwogICAgLy8gY2hlY2sgaWYgcHJldiBzb25nIGlzIGluIHRoaXMgcGxheWxpc3QKICAgIGlmICgtMSA9PSBzdHJfZ2V0X2lkeF9vZiAocGxheWxpc3RfdHJhY2spKSB7CiAgICAgICAgcGxheWxpc3RfdHJhY2sgPSBOVUxMOwogICAgfQoKICAgIHBsYXlsaXN0X3QgKnBsdCA9IHN0cmVhbWVyX3BsYXlsaXN0OwogICAgcGxheXF1ZXVlX2NsZWFyICgpOwogICAgaWYgKCFwbHQtPmhlYWRbUExfTUFJTl0pIHsKICAgICAgICBwbF91bmxvY2sgKCk7CiAgICAgICAgc3RyZWFtZXJfc2V0X25leHRzb25nX3JlYWwgKC0yLCAxKTsKICAgICAgICByZXR1cm4gMDsKICAgIH0KICAgIGludCBwbF9vcmRlciA9IGNvbmZfZ2V0X2ludCAoInBsYXliYWNrLm9yZGVyIiwgMCk7CiAgICBpbnQgcGxfbG9vcF9tb2RlID0gY29uZl9nZXRfaW50ICgicGxheWJhY2subG9vcCIsIDApOwogICAgaWYgKHBsX29yZGVyID09IFBMQVlCQUNLX09SREVSX1NIVUZGTEVfVFJBQ0tTIHx8IHBsX29yZGVyID09IFBMQVlCQUNLX09SREVSX1NIVUZGTEVfQUxCVU1TKSB7IC8vIHNodWZmbGUKICAgICAgICBpZiAoIXBsYXlsaXN0X3RyYWNrKSB7CiAgICAgICAgICAgIHBsX3VubG9jayAoKTsKICAgICAgICAgICAgcmV0dXJuIHN0cmVhbWVyX21vdmVfdG9fbmV4dHNvbmdfcmVhbCAoMCk7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICBwbGF5bGlzdF90cmFjay0-cGxheWVkID0gMDsKICAgICAgICAgICAgLy8gZmluZCBhbHJlYWR5IHBsYXllZCBzb25nIHdpdGggbWF4aW11bSBzaHVmZmxlIHJhdGluZyBiZWxvdyBwcmV2IHNvbmcKICAgICAgICAgICAgaW50IHJhdGluZyA9IHBsYXlsaXN0X3RyYWNrLT5zaHVmZmxlcmF0aW5nOwogICAgICAgICAgICBwbGF5SXRlbV90ICpwbWF4ID0gTlVMTDsgLy8gcGxheWVkIG1heGltdW0KICAgICAgICAgICAgcGxheUl0ZW1fdCAqYW1heCA9IE5VTEw7IC8vIGFic29sdXRlIG1heGltdW0KICAgICAgICAgICAgZm9yIChwbGF5SXRlbV90ICppID0gcGx0LT5oZWFkW1BMX01BSU5dOyBpOyBpID0gaS0-bmV4dFtQTF9NQUlOXSkgewogICAgICAgICAgICAgICAgaWYgKGkgIT0gcGxheWxpc3RfdHJhY2sgJiYgaS0-cGxheWVkICYmICghYW1heCB8fCBpLT5zaHVmZmxlcmF0aW5nID4gYW1heC0-c2h1ZmZsZXJhdGluZykpIHsKICAgICAgICAgICAgICAgICAgICBhbWF4ID0gaTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChpID09IHBsYXlsaXN0X3RyYWNrIHx8IGktPnNodWZmbGVyYXRpbmcgPiByYXRpbmcgfHwgIWktPnBsYXllZCkgewogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCFwbWF4IHx8IGktPnNodWZmbGVyYXRpbmcgPiBwbWF4LT5zaHVmZmxlcmF0aW5nKSB7CiAgICAgICAgICAgICAgICAgICAgcG1heCA9IGk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChwbWF4ICYmIHBsX29yZGVyID09IFBMQVlCQUNLX09SREVSX1NIVUZGTEVfQUxCVU1TKSB7CiAgICAgICAgICAgICAgICB3aGlsZSAocG1heCAmJiBwbWF4LT5uZXh0W1BMX01BSU5dICYmIHBtYXgtPm5leHRbUExfTUFJTl0tPnBsYXllZCAmJiBwbWF4LT5zaHVmZmxlcmF0aW5nID09IHBtYXgtPm5leHRbUExfTUFJTl0tPnNodWZmbGVyYXRpbmcpIHsKICAgICAgICAgICAgICAgICAgICBwbWF4ID0gcG1heC0-bmV4dFtQTF9NQUlOXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgcGxheUl0ZW1fdCAqaXQgPSBwbWF4OwogICAgICAgICAgICBpZiAoIWl0KSB7CiAgICAgICAgICAgICAgICAvLyB0aGF0IG1lYW5zIDFzdCBpbiBwbGF5bGlzdCwgdGFrZSBhbWF4CiAgICAgICAgICAgICAgICBpZiAocGxfbG9vcF9tb2RlID09IFBMQVlCQUNLX01PREVfTE9PUF9BTEwpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIWFtYXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGx0X3Jlc2h1ZmZsZSAoc3RyZWFtZXJfcGxheWxpc3QsIE5VTEwsICZhbWF4KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaXQgPSBhbWF4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoIWl0KSB7CiAgICAgICAgICAgICAgICBwbF91bmxvY2sgKCk7CiAgICAgICAgICAgICAgICBzdHJlYW1lcl9zZXRfbmV4dHNvbmdfcmVhbCAoLTIsIDEpOwogICAgICAgICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGludCByID0gc3RyX2dldF9pZHhfb2YgKGl0KTsKICAgICAgICAgICAgcGxfdW5sb2NrICgpOwogICAgICAgICAgICBzdHJlYW1lcl9zZXRfbmV4dHNvbmdfcmVhbCAociwgMSk7CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH0KICAgIH0KICAgIGVsc2UgaWYgKHBsX29yZGVyID09IFBMQVlCQUNLX09SREVSX0xJTkVBUikgeyAvLyBsaW5lYXIKICAgICAgICBEQl9vdXRwdXRfdCAqb3V0cHV0ID0gcGx1Z19nZXRfb3V0cHV0ICgpOwogICAgICAgIHBsYXlJdGVtX3QgKml0ID0gTlVMTDsKICAgICAgICBpZiAoIXBsYXlsaXN0X3RyYWNrICYmIG91dHB1dC0-c3RhdGUgKCkgPT0gT1VUUFVUX1NUQVRFX1NUT1BQRUQpIHsKICAgICAgICAgICAgaW50IGN1ciA9IHBsdF9nZXRfY3Vyc29yIChzdHJlYW1lcl9wbGF5bGlzdCwgUExfTUFJTik7CiAgICAgICAgICAgIGlmIChjdXIgIT0gLTEpIHsKICAgICAgICAgICAgICAgIHBsYXlsaXN0X3RyYWNrID0gcGx0X2dldF9pdGVtX2Zvcl9pZHggKHN0cmVhbWVyX3BsYXlsaXN0LCBjdXIsIFBMX01BSU4pOwogICAgICAgICAgICAgICAgcGxfaXRlbV91bnJlZiAocGxheWxpc3RfdHJhY2spOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChwbGF5bGlzdF90cmFjaykgewogICAgICAgICAgICBpdCA9IHBsYXlsaXN0X3RyYWNrLT5wcmV2W1BMX01BSU5dOwogICAgICAgIH0KICAgICAgICBpZiAoIWl0KSB7CiAgICAgICAgICAgIGlmIChwbF9sb29wX21vZGUgPT0gUExBWUJBQ0tfTU9ERV9MT09QX0FMTCkgewogICAgICAgICAgICAgICAgaXQgPSBwbHQtPnRhaWxbUExfTUFJTl07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCFpdCkgewogICAgICAgICAgICBwbF91bmxvY2sgKCk7CiAgICAgICAgICAgIHN0cmVhbWVyX3NldF9uZXh0c29uZ19yZWFsICgtMiwgMSk7CiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICB9CiAgICAgICAgaW50IHIgPSBzdHJfZ2V0X2lkeF9vZiAoaXQpOwogICAgICAgIHBsX3VubG9jayAoKTsKICAgICAgICBzdHJlYW1lcl9zZXRfbmV4dHNvbmdfcmVhbCAociwgMSk7CiAgICAgICAgcmV0dXJuIDA7CiAgICB9CiAgICBlbHNlIGlmIChwbF9vcmRlciA9PSBQTEFZQkFDS19PUkRFUl9SQU5ET00pIHsgLy8gcmFuZG9tCiAgICAgICAgcGxfdW5sb2NrICgpOwogICAgICAgIGludCByZXMgPSBzdHJlYW1lcl9tb3ZlX3RvX3JhbmRvbXNvbmdfcmVhbCAoMCk7CiAgICAgICAgaWYgKHJlcyA9PSAtMSkgewogICAgICAgICAgICBzdHJlYW1lcl9zZXRfbmV4dHNvbmdfcmVhbCAoLTIsIDEpOwogICAgICAgICAgICB0cmFjZSAoInN0cmVhbWVyX21vdmVfdG9fcmFuZG9tc29uZyBlcnJvclxuIik7CiAgICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIDA7CiAgICB9CiAgICBwbF91bmxvY2sgKCk7CiAgICByZXR1cm4gLTE7Cn0KCnN0YXRpYyBpbnQKc3RyZWFtZXJfbW92ZV90b19yYW5kb21zb25nX3JlYWwgKGludCByZWFzb24pIHsKICAgIGlmIChyZWFzb24pIHsKICAgICAgICBwbHVnX2dldF9vdXRwdXQgKCktPnN0b3AgKCk7CiAgICB9CiAgICBpZiAoIXN0cmVhbWVyX3BsYXlsaXN0KSB7CiAgICAgICAgc3RyZWFtZXJfcGxheWxpc3QgPSBwbHRfZ2V0X2N1cnIgKCk7CiAgICB9CiAgICBwbGF5bGlzdF90ICpwbHQgPSBzdHJlYW1lcl9wbGF5bGlzdDsKICAgIGludCBjbnQgPSBwbHQtPmNvdW50W1BMX01BSU5dOwogICAgaWYgKCFjbnQpIHsKICAgICAgICB0cmFjZSAoImVtcHR5IHBsYXlsaXN0XG4iKTsKICAgICAgICByZXR1cm4gLTE7CiAgICB9CiAgICBpbnQgY3VyciA9IHN0cl9nZXRfaWR4X29mIChwbGF5aW5nX3RyYWNrKTsKICAgIGludCByID0gcmFuZCAoKSAvIChmbG9hdClSQU5EX01BWCAqIGNudDsKICAgIGlmIChyID09IGN1cnIpIHsKICAgICAgICByKys7CiAgICAgICAgaWYgKHIgPj0gY250KSB7CiAgICAgICAgICAgIHIgPSAwOwogICAgICAgIH0KICAgIH0KCiAgICBzdHJlYW1lcl9zZXRfbmV4dHNvbmdfcmVhbCAociwgMSk7CiAgICByZXR1cm4gMDsKfQoKaW50CnN0cmVhbWVyX21vdmVfdG9fbmV4dHNvbmcgKGludCByKSB7CiAgICBpZiAocikgewogICAgICAgIHN0cmVhbWVyX2Fib3J0X2ZpbGVzICgpOwogICAgfQogICAgaGFuZGxlcl9wdXNoIChoYW5kbGVyLCBTVFJfRVZfTkVYVCwgMCwgciwgMCk7CiAgICByZXR1cm4gMDsKfQoKaW50CnN0cmVhbWVyX21vdmVfdG9fcHJldnNvbmcgKGludCByKSB7CiAgICBpZiAocikgewogICAgICAgIHN0cmVhbWVyX2Fib3J0X2ZpbGVzICgpOwogICAgfQogICAgaGFuZGxlcl9wdXNoIChoYW5kbGVyLCBTVFJfRVZfUFJFViwgMCwgciwgMCk7CiAgICByZXR1cm4gMDsKfQoKaW50CnN0cmVhbWVyX21vdmVfdG9fcmFuZG9tc29uZyAoaW50IHIpIHsKICAgIGlmIChyKSB7CiAgICAgICAgc3RyZWFtZXJfYWJvcnRfZmlsZXMgKCk7CiAgICB9CiAgICBoYW5kbGVyX3B1c2ggKGhhbmRsZXIsIFNUUl9FVl9SQU5ELCAwLCByLCAwKTsKICAgIHJldHVybiAwOwp9CgovLyBwbGF5bGlzdCBtdXN0IGNhbGwgdGhhdCB3aGVuZXZlciBpdGVtIHdhcyByZW1vdmVkCnZvaWQKc3RyZWFtZXJfc29uZ19yZW1vdmVkX25vdGlmeSAocGxheUl0ZW1fdCAqaXQpIHsKICAgIGlmICghbXV0ZXgpIHsKICAgICAgICByZXR1cm47IC8vIHN0cmVhbWVyIGlzIG5vdCBydW5uaW5nCiAgICB9CiAgICBpZiAoaXQgPT0gcGxheWxpc3RfdHJhY2spIHsKICAgICAgICBwbGF5bGlzdF90cmFjayA9IHBsYXlsaXN0X3RyYWNrLT5wcmV2W1BMX01BSU5dOwogICAgfQp9CgojZGVmaW5lIENUTUFQX01BWF9QTFVHSU5TIDUKCnR5cGVkZWYgc3RydWN0IGN0bWFwX3MgewogICAgY2hhciAqY3Q7CiAgICBjaGFyICpwbHVnaW5zW0NUTUFQX01BWF9QTFVHSU5TXTsKICAgIHN0cnVjdCBjdG1hcF9zICpuZXh0Owp9IGN0bWFwX3Q7CgpzdGF0aWMgY3RtYXBfdCAqc3RyZWFtZXJfY3RtYXA7CnN0YXRpYyBjaGFyIGNvbmZfbmV0d29ya19jdG1hcHBpbmdbMjA0OF07CnN0YXRpYyB1aW50cHRyX3QgY3RtYXBfbXV0ZXg7CgpzdGF0aWMgdm9pZApjdG1hcF9pbml0X211dGV4ICh2b2lkKSB7CiAgICBjdG1hcF9tdXRleCA9IG11dGV4X2NyZWF0ZSAoKTsKfQoKc3RhdGljIHZvaWQKY3RtYXBfZnJlZV9tdXRleCAodm9pZCkgewogICAgaWYgKGN0bWFwX211dGV4KSB7CiAgICAgICAgbXV0ZXhfZnJlZSAoY3RtYXBfbXV0ZXgpOwogICAgICAgIGN0bWFwX211dGV4ID0gMDsKICAgIH0KfQoKc3RhdGljIHZvaWQKY3RtYXBfbG9jayAodm9pZCkgewogICAgbXV0ZXhfbG9jayAoY3RtYXBfbXV0ZXgpOwp9CgpzdGF0aWMgdm9pZApjdG1hcF91bmxvY2sgKHZvaWQpIHsKICAgIG11dGV4X3VubG9jayAoY3RtYXBfbXV0ZXgpOwp9CgpzdGF0aWMgdm9pZApjdG1hcF9mcmVlICh2b2lkKSB7CiAgICB3aGlsZSAoc3RyZWFtZXJfY3RtYXApIHsKICAgICAgICBjdG1hcF90ICpjdCA9IHN0cmVhbWVyX2N0bWFwOwogICAgICAgIGZyZWUgKGN0LT5jdCk7CiAgICAgICAgZm9yIChpbnQgaSA9IDA7IGN0LT5wbHVnaW5zW2ldOyBpKyspIHsKICAgICAgICAgICAgZnJlZSAoY3QtPnBsdWdpbnNbaV0pOwogICAgICAgIH0KICAgICAgICBzdHJlYW1lcl9jdG1hcCA9IGN0LT5uZXh0OwogICAgICAgIGZyZWUgKGN0KTsKICAgIH0KfQoKc3RhdGljIHZvaWQKY3RtYXBfaW5pdCAodm9pZCkgewogICAgY3RtYXBfZnJlZSAoKTsKICAgIGNoYXIgKm1hcHN0ciA9IGNvbmZfbmV0d29ya19jdG1hcHBpbmc7CgogICAgY29uc3QgY2hhciAqcCA9IG1hcHN0cjsKICAgIGNoYXIgdFtNQVhfVE9LRU5dOwogICAgY2hhciBjdFtNQVhfVE9LRU5dOwogICAgY2hhciBwbHVnaW5zW01BWF9UT0tFTio1XTsKCiAgICBjdG1hcF90ICp0YWlsID0gTlVMTDsKCiAgICBmb3IgKDs7KSB7CiAgICAgICAgcCA9IGdldHRva2VuIChwLCB0KTsKCiAgICAgICAgaWYgKCFwKSB7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KCiAgICAgICAgY3RtYXBfdCAqY3RtYXAgPSBtYWxsb2MgKHNpemVvZiAoY3RtYXBfdCkpOwogICAgICAgIG1lbXNldCAoY3RtYXAsIDAsIHNpemVvZiAoY3RtYXBfdCkpOwogICAgICAgIGN0bWFwLT5jdCA9IHN0cmR1cCAodCk7CgogICAgICAgIGludCBuID0gMDsKCiAgICAgICAgcCA9IGdldHRva2VuIChwLCB0KTsKICAgICAgICBpZiAoIXAgfHwgc3RyY21wICh0LCAieyIpKSB7CiAgICAgICAgICAgIGZyZWUgKGN0bWFwLT5jdCk7CiAgICAgICAgICAgIGZyZWUgKGN0bWFwKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQoKICAgICAgICBwbHVnaW5zWzBdID0gMDsKICAgICAgICBmb3IgKDs7KSB7CiAgICAgICAgICAgIHAgPSBnZXR0b2tlbiAocCwgdCk7CiAgICAgICAgICAgIGlmICghcCB8fCAhc3RyY21wICh0LCAifSIpIHx8IG4gPj0gQ1RNQVBfTUFYX1BMVUdJTlMtMSkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGN0bWFwLT5wbHVnaW5zW24rK10gPSBzdHJkdXAgKHQpOwogICAgICAgIH0KICAgICAgICBjdG1hcC0-cGx1Z2luc1tuXSA9IE5VTEw7CiAgICAgICAgaWYgKHRhaWwpIHsKICAgICAgICAgICAgdGFpbC0-bmV4dCA9IGN0bWFwOwogICAgICAgIH0KICAgICAgICB0YWlsID0gY3RtYXA7CiAgICAgICAgaWYgKCFzdHJlYW1lcl9jdG1hcCkgewogICAgICAgICAgICBzdHJlYW1lcl9jdG1hcCA9IGN0bWFwOwogICAgICAgIH0KICAgIH0KfQoKc3RhdGljIGludAppc19yZW1vdGVfc3RyZWFtIChwbGF5SXRlbV90ICppdCkgewogICAgaW50IHJlbW90ZSA9IDA7CiAgICBwbF9sb2NrICgpOwogICAgY29uc3QgY2hhciAqdXJpID0gcGxfZmluZF9tZXRhIChpdCwgIjpVUkkiKTsKICAgIGlmICh1cmkgJiYgIXBsdWdfaXNfbG9jYWxfZmlsZSAodXJpKSkgewogICAgICAgIHJlbW90ZSA9IDE7CiAgICB9CiAgICBwbF91bmxvY2sgKCk7CiAgICByZXR1cm4gcmVtb3RlOwp9CgpzdGF0aWMgREJfZmlsZWluZm9fdCAqZGVjX29wZW4gKERCX2RlY29kZXJfdCAqZGVjLCB1aW50MzJfdCBoaW50cywgcGxheUl0ZW1fdCAqaXQpIHsKICAgIGlmIChkZWMtPnBsdWdpbi5hcGlfdm1pbm9yID49IDcgJiYgZGVjLT5vcGVuMikgewogICAgICAgIERCX2ZpbGVpbmZvX3QgKmZpID0gZGVjLT5vcGVuMiAoaGludHMsIERCX1BMQVlJVEVNIChpdCkpOwogICAgICAgIHJldHVybiBmaTsKICAgIH0KICAgIHJldHVybiBkZWMtPm9wZW4gKGhpbnRzKTsKfQoKLy8gdGhhdCBtdXN0IGJlIGNhbGxlZCBhZnRlciBsYXN0IHNhbXBsZSBmcm9tIHN0cl9wbGF5aW5nX3Nvbmcgd2FzIGRvbmUgcmVhZGluZwpzdGF0aWMgaW50CnN0cmVhbWVyX3NldF9jdXJyZW50IChwbGF5SXRlbV90ICppdCkgewogICAgdHJhY2UgKCJzdHJlYW1lcl9zZXRfY3VycmVudCAlc1xuIiwgcGxheWluZ190cmFjayA_IHBsX2ZpbmRfbWV0YSAocGxheWluZ190cmFjaywgIjpVUkkiKSA6ICJudWxsIik7CiAgICBEQl9vdXRwdXRfdCAqb3V0cHV0ID0gcGx1Z19nZXRfb3V0cHV0ICgpOwogICAgaW50IGVyciA9IDA7CiAgICBpbnQgZG9fc29uZ3N0YXJ0ZWQgPSAwOwogICAgcGxheUl0ZW1fdCAqZnJvbSwgKnRvOwogICAgLy8gbmVlZCB0byBhZGQgcmVmcyBoZXJlLCBiZWNhdXNlIHN0cmVhbWVyX3N0YXJ0X3BsYXliYWNrIGNhbiBkZXN0cm95IGl0ZW1zCiAgICBmcm9tID0gcGxheWluZ190cmFjazsKICAgIHRvID0gaXQ7CiAgICBpZiAoZnJvbSkgewogICAgICAgIHBsX2l0ZW1fcmVmIChmcm9tKTsKICAgIH0KICAgIGlmICh0bykgewogICAgICAgIHBsX2l0ZW1fcmVmICh0byk7CiAgICB9CiAgICB0cmFjZSAoIlwwMzNbMDszNW1zdHJlYW1lcl9zZXRfY3VycmVudCBmcm9tICVwIHRvICVwXDAzM1szNzswbVxuIiwgZnJvbSwgaXQpOwogICAgdHJhY2UgKCJcMDMzWzA7MzVtb3V0cHV0IHN0YXRlOiAlZFwwMzNbMzc7MG1cbiIsIG91dHB1dC0-c3RhdGUgKCkpOwogICAgaWYgKCFwbGF5aW5nX3RyYWNrIHx8IG91dHB1dC0-c3RhdGUgKCkgPT0gT1VUUFVUX1NUQVRFX1NUT1BQRUQpIHsKICAgICAgICBzdHJlYW1lcl9idWZmZXJpbmcgPSAxOwogICAgICAgIHRyYWNlICgiXDAzM1swOzM1bXN0cmVhbWVyX3N0YXJ0X3BsYXliYWNrWzFdIGZyb20gJXAgdG8gJXBcMDMzWzM3OzBtXG4iLCBmcm9tLCBpdCk7CiAgICAgICAgZG9fc29uZ3N0YXJ0ZWQgPSAxOwogICAgICAgIHN0cmVhbWVyX3N0YXJ0X3BsYXliYWNrIChmcm9tLCBpdCk7CiAgICAgICAgYnl0ZXNfdW50aWxfbmV4dF9zb25nID0gLTE7CiAgICB9CgogICAgdHJhY2UgKCJzdHJlYW1lcl9zZXRfY3VycmVudCAlcCwgYnVucz0lZFxuIiwgaXQsIGJ5dGVzX3VudGlsX25leHRfc29uZyk7CiAgICBtdXRleF9sb2NrIChjdXJydHJhY2tfbXV0ZXgpOwogICAgaWYgKHN0cmVhbWluZ190cmFjaykgewogICAgICAgIHBsX2l0ZW1fdW5yZWYgKHN0cmVhbWluZ190cmFjayk7CiAgICAgICAgc3RyZWFtaW5nX3RyYWNrID0gTlVMTDsKICAgIH0KCiAgICBtdXRleF91bmxvY2sgKGN1cnJ0cmFja19tdXRleCk7CgogICAgaW50IHBhdXNlZF9zdHJlYW0gPSAwOwogICAgaWYgKGl0ICYmIG5leHRzb25nX3BzdGF0ZSA9PSAyKSB7CiAgICAgICAgcGF1c2VkX3N0cmVhbSA9IGlzX3JlbW90ZV9zdHJlYW0gKGl0KTsKICAgIH0KCiAgICBpZiAoIWl0IHx8IHBhdXNlZF9zdHJlYW0pIHsKICAgICAgICBnb3RvIHN1Y2Nlc3M7CiAgICB9CiAgICBpZiAodG8pIHsKICAgICAgICB0cmFjZSAoImRyYXcgYmVmb3JlIGluaXQ6ICVwLT4lcCwgcGxheWluZ190cmFjaz0lcCwgcGxheWxpc3RfdHJhY2s9JXBcbiIsIGZyb20sIHRvLCBwbGF5aW5nX3RyYWNrLCBwbGF5bGlzdF90cmFjayk7CiAgICAgICAgc2VuZF90cmFja2luZm9jaGFuZ2VkICh0byk7CiAgICB9CiAgICBpZiAoZnJvbSkgewogICAgICAgIHNlbmRfdHJhY2tpbmZvY2hhbmdlZCAoZnJvbSk7CiAgICB9CiAgICBjaGFyIGRlY29kZXJfaWRbMTAwXSA9ICIiOwogICAgY2hhciBmaWxldHlwZVsxMDBdID0gIiI7CiAgICBwbF9sb2NrICgpOwogICAgY29uc3QgY2hhciAqZGVjID0gcGxfZmluZF9tZXRhIChpdCwgIjpERUNPREVSIik7CiAgICBpZiAoZGVjKSB7CiAgICAgICAgc3RybmNweSAoZGVjb2Rlcl9pZCwgZGVjLCBzaXplb2YgKGRlY29kZXJfaWQpKTsKICAgIH0KCiAgICBpZiAoIWRlY29kZXJfaWRbMF0pIHsKICAgICAgICAvLyBzb21lIGRlY29kZXJzIHNldCBmaWxldHlwZSBvdmVycmlkZSwKICAgICAgICAvLyBidXQgdGhlIG92ZXJyaWRlIGlzIGludmFsaWQgd2hlbiBkZWNvZGVyIGlzIG5vdCBzZXQuCiAgICAgICAgLy8gcmVzZXQgdG8gZGVmYXVsdCBoZXJlLCBzbyB0aGF0IHRyYWNrcyBiZWNvbWUgcGxheWFibGUgYWZ0ZXIgZmFpbHVyZXMKICAgICAgICBwbF9kZWxldGVfbWV0YShpdCwgIiFGSUxFVFlQRSIpOwogICAgfQoKICAgIGNvbnN0IGNoYXIgKmZ0ID0gcGxfZmluZF9tZXRhIChpdCwgIjpGSUxFVFlQRSIpOwogICAgaWYgKGZ0KSB7CiAgICAgICAgc3RybmNweSAoZmlsZXR5cGUsIGZ0LCBzaXplb2YgKGZpbGV0eXBlKSk7CiAgICB9CiAgICBwbF91bmxvY2sgKCk7CiAgICBjaGFyICpwbHVnc1tDVE1BUF9NQVhfUExVR0lOU10gPSB7TlVMTH07CiAgICBpZiAoIWRlY29kZXJfaWRbMF0gJiYgKCFzdHJjbXAgKGZpbGV0eXBlLCAiY29udGVudCIpIHx8ICFmaWxldHlwZVswXSkpIHsKICAgICAgICAvLyB0cnkgdG8gZ2V0IGNvbnRlbnQtdHlwZQogICAgICAgIHRyYWNlICgiXDAzM1swOzM0bW9wZW5pbmcgZmlsZSAlc1wwMzNbMzc7MG1cbiIsIHBsX2ZpbmRfbWV0YSAoaXQsICI6VVJJIikpOwogICAgICAgIHBsX2xvY2sgKCk7CiAgICAgICAgY2hhciAqdXJpID0gc3RyZHVwYSAocGxfZmluZF9tZXRhIChpdCwgIjpVUkkiKSk7CiAgICAgICAgcGxfdW5sb2NrICgpOwogICAgICAgIERCX0ZJTEUgKmZwID0gc3RyZWFtZXJfZmlsZSA9IHZmc19mb3BlbiAodXJpKTsKICAgICAgICB0cmFjZSAoIlwwMzNbMDszNG1nZXR0aW5nIGNvbnRlbnQtdHlwZVwwMzNbMzc7MG1cbiIpOwogICAgICAgIGlmICghZnApIHsKICAgICAgICAgICAgZXJyID0gLTE7CiAgICAgICAgICAgIGdvdG8gZXJyb3I7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGNoYXIgKmN0ID0gdmZzX2dldF9jb250ZW50X3R5cGUgKGZwKTsKICAgICAgICBpZiAoIWN0KSB7CiAgICAgICAgICAgIHZmc19mY2xvc2UgKGZwKTsKICAgICAgICAgICAgZnAgPSBOVUxMOwogICAgICAgICAgICBzdHJlYW1lcl9maWxlID0gTlVMTDsKICAgICAgICAgICAgZXJyID0gLTE7CiAgICAgICAgICAgIGdvdG8gZXJyb3I7CiAgICAgICAgfQogICAgICAgIHRyYWNlICgiZ290IGNvbnRlbnQtdHlwZTogJXNcbiIsIGN0KTsKICAgICAgICBjaGFyICpjY3QgPSBzdHJkdXBhIChjdCk7CiAgICAgICAgY2hhciAqc2MgPSBzdHJjaHIgKGNjdCwgJzsnKTsKICAgICAgICBpZiAoc2MpIHsKICAgICAgICAgICAgKnNjID0gMDsKICAgICAgICB9CgogICAgICAgIGN0bWFwX2xvY2sgKCk7CiAgICAgICAgY3RtYXBfdCAqY3RtYXAgPSBzdHJlYW1lcl9jdG1hcDsKICAgICAgICB3aGlsZSAoY3RtYXApIHsKICAgICAgICAgICAgaWYgKCFzdHJjbXAgKGNjdCwgY3RtYXAtPmN0KSkgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY3RtYXAgPSBjdG1hcC0-bmV4dDsKICAgICAgICB9CiAgICAgICAgaWYgKGN0bWFwKSB7CiAgICAgICAgICAgIGludCBpOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBjdG1hcC0-cGx1Z2luc1tpXTsgaSsrKSB7CiAgICAgICAgICAgICAgICBwbHVnc1tpXSA9IHN0cmR1cGEgKGN0bWFwLT5wbHVnaW5zW2ldKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwbHVnc1tpXSA9IE5VTEw7CiAgICAgICAgfQogICAgICAgIGN0bWFwX3VubG9jayAoKTsKCiAgICAgICAgaWYgKCFwbHVnc1swXSAmJiAoIXN0cmNtcCAoY2N0LCAiYXVkaW8veC1tcGVndXJsIikgfHwgIXN0cm5jbXAgKGNjdCwgInRleHQvaHRtbCIsIDkpIHx8ICFzdHJuY21wIChjY3QsICJhdWRpby94LXNjcGxzIiwgMTMpIHx8ICFzdHJuY21wIChjY3QsICJhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0iLCA5KSkpIHsKICAgICAgICAgICAgLy8gZG93bmxvYWQgcGxheWxpc3QgaW50byB0ZW1wIGZpbGUKICAgICAgICAgICAgdHJhY2UgKCJkb3dubG9hZGluZyBwbGF5bGlzdCBpbnRvIHRlbXAgZmlsZS4uLlxuIik7CiAgICAgICAgICAgIGNoYXIgKmJ1ZiA9IE5VTEw7CiAgICAgICAgICAgIGludCBmZCA9IC0xOwogICAgICAgICAgICBGSUxFICpvdXQgPSBOVUxMOwogICAgICAgICAgICBjaGFyIHRlbXBmaWxlWzEwMDBdID0gIiI7CgogICAgICAgICAgICBpbnQgc2l6ZSA9IHZmc19mZ2V0bGVuZ3RoIChmcCk7CiAgICAgICAgICAgIGlmIChzaXplIDw9IDApIHsKICAgICAgICAgICAgICAgIHNpemUgPSBNQVhfUExBWUxJU1RfRE9XTkxPQURfU0laRTsKICAgICAgICAgICAgfQogICAgICAgICAgICBidWYgPSBtYWxsb2MgKHNpemUpOwogICAgICAgICAgICBpZiAoIWJ1ZikgewogICAgICAgICAgICAgICAgdHJhY2UgKCJmYWlsZWQgdG8gYWxsb2MgJWQgYnl0ZXMgZm9yIHBsYXlsaXN0IGJ1ZmZlclxuIiwgc2l6ZSk7CiAgICAgICAgICAgICAgICBnb3RvIG0zdV9lcnJvcjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0cmFjZSAoInJlYWRpbmcgJWQgYnl0ZXNcbiIsIHNpemUpOwogICAgICAgICAgICBpbnQgcmQgPSB2ZnNfZnJlYWQgKGJ1ZiwgMSwgc2l6ZSwgZnApOwogICAgICAgICAgICBpZiAocmQgPD0gMCkgewogICAgICAgICAgICAgICAgdHJhY2UgKCJmYWlsZWQgdG8gZG93bmxvYWQgJWQgYnl0ZXMgKGdvdCAlZCBieXRlcylcbiIsIHNpemUsIHJkKTsKICAgICAgICAgICAgICAgIGdvdG8gbTN1X2Vycm9yOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNvbnN0IGNoYXIgKnRtcGRpciA9IGdldGVudiAoIlRNUERJUiIpOwogICAgICAgICAgICBpZiAoIXRtcGRpcikgewogICAgICAgICAgICAgICAgdG1wZGlyID0gIi90bXAiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNucHJpbnRmICh0ZW1wZmlsZSwgc2l6ZW9mICh0ZW1wZmlsZSksICIlcy9kZGJtM3VYWFhYWFgiLCB0bXBkaXIpOwoKICAgICAgICAgICAgZmQgPSBta3N0ZW1wICh0ZW1wZmlsZSk7CiAgICAgICAgICAgIGlmIChmZCA9PSAtMSkgewogICAgICAgICAgICAgICAgdHJhY2UgKCJmYWlsZWQgdG8gb3BlbiB0ZW1wIGZpbGUgJXNcbiIsIHRlbXBmaWxlKTsKICAgICAgICAgICAgICAgIGdvdG8gbTN1X2Vycm9yOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRyYWNlICgid3JpdGluZyB0byAlc1xuIiwgdGVtcGZpbGUpOwogICAgICAgICAgICBvdXQgPSBmZG9wZW4gKGZkLCAidytiIik7CiAgICAgICAgICAgIGlmICghb3V0KSB7CiAgICAgICAgICAgICAgICB0cmFjZSAoImZkb3BlbiBmYWlsZWQgZm9yICVzXG4iLCB0ZW1wZmlsZSk7CiAgICAgICAgICAgICAgICBnb3RvIG0zdV9lcnJvcjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbnQgcncgPSBmd3JpdGUgKGJ1ZiwgMSwgcmQsIG91dCk7CiAgICAgICAgICAgIGlmIChydyAhPSByZCkgewogICAgICAgICAgICAgICAgdHJhY2UgKCJmYWlsZWQgdG8gd3JpdGUgJWQgYnl0ZXMgaW50byBmaWxlICVzXG4iLCBzaXplLCB0ZW1wZmlsZSk7CiAgICAgICAgICAgICAgICBnb3RvIG0zdV9lcnJvcjsKICAgICAgICAgICAgfQogICAgICAgICAgICBmY2xvc2UgKG91dCk7CiAgICAgICAgICAgIGZkID0gLTE7CiAgICAgICAgICAgIG91dCA9IE5VTEw7CgogICAgICAgICAgICB0cmFjZSAoImxvYWRpbmcgcGxheWxpc3QgZnJvbSAlc1xuIiwgdGVtcGZpbGUpOwogICAgICAgICAgICAvLyBsb2FkIHBsYXlsaXN0CiAgICAgICAgICAgIHBsYXlsaXN0X3QgKnBsdCA9IHBsdF9hbGxvYyAoInRlbXAiKTsKICAgICAgICAgICAgREJfcGxheWxpc3RfdCAqKnBsdWcgPSBwbHVnX2dldF9wbGF5bGlzdF9saXN0ICgpOwogICAgICAgICAgICBpbnQgcCwgZTsKICAgICAgICAgICAgREJfcGxheUl0ZW1fdCAqbTN1ID0gTlVMTDsKICAgICAgICAgICAgZm9yIChwID0gMDsgcGx1Z1twXTsgcCsrKSB7CiAgICAgICAgICAgICAgICBpZiAocGx1Z1twXS0-bG9hZCkgewogICAgICAgICAgICAgICAgICAgIG0zdSA9IHBsdWdbcF0tPmxvYWQgKChkZGJfcGxheWxpc3RfdCAqKXBsdCwgTlVMTCwgdGVtcGZpbGUsIE5VTEwsIE5VTEwsIE5VTEwpOwogICAgICAgICAgICAgICAgICAgIGlmIChtM3UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICghbTN1KSB7CiAgICAgICAgICAgICAgICB0cmFjZSAoImZhaWxlZCB0byBsb2FkIHBsYXlsaXN0IGZyb20gJXMgdXNpbmcgYW55IG9mIHRoZSBpbnN0YWxsZWQgcGxheWxpc3QgcGx1Z2luc1xuIiwgdGVtcGZpbGUpOwogICAgICAgICAgICAgICAgcGx0X2ZyZWUgKHBsdCk7CiAgICAgICAgICAgICAgICBnb3RvIG0zdV9lcnJvcjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gaGFjazogbmVlZCB0byBzbGVlcCBoZXJlLCBzb21lIHNlcnZlcnMgbGlrZSB0byByZWplY3QgZnJlcXVlbnQgY29ubmVjdGlvbnMKICAgICAgICAgICAgdXNsZWVwKGNvbmZfZ2V0X2ludCAoInN0cmVhbWVyLndhaXRfbXNfYWZ0ZXJfbTN1X2xpbmsiLCA0MDAwMDApKTsKCiAgICAgICAgICAgIC8vIGZvciBldmVyeSBwbGF5bGlzdCB1cmk6IG92ZXJyaWRlIHN0cmVhbSB1cmkgd2l0aCB0aGUgb25lIGZyb20gcGxheWxpc3QsIGFuZCB0cnkgdG8gcGxheSBpdAogICAgICAgICAgICBwbGF5SXRlbV90ICppID0gKHBsYXlJdGVtX3QgKiltM3U7CiAgICAgICAgICAgIHBsX2l0ZW1fcmVmIChpKTsKICAgICAgICAgICAgaW50IHJlcyA9IC0xOwogICAgICAgICAgICB3aGlsZSAoaSkgewogICAgICAgICAgICAgICAgcGxfbG9jayAoKTsKICAgICAgICAgICAgICAgIHBsX3JlcGxhY2VfbWV0YSAoaXQsICIhVVJJIiwgcGxfZmluZF9tZXRhX3JhdyAoaSwgIjpVUkkiKSk7CiAgICAgICAgICAgICAgICBwbF91bmxvY2sgKCk7CiAgICAgICAgICAgICAgICByZXMgPSBzdHJlYW1lcl9zZXRfY3VycmVudCAoaXQpOwogICAgICAgICAgICAgICAgaWYgKCFyZXMpIHsKICAgICAgICAgICAgICAgICAgICBwbF9pdGVtX3VucmVmIChpKTsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHBsYXlJdGVtX3QgKm5leHQgPSBwbF9nZXRfbmV4dCAoaSwgUExfTUFJTik7CiAgICAgICAgICAgICAgICBwbF9pdGVtX3VucmVmIChpKTsKICAgICAgICAgICAgICAgIGkgPSBuZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHBsdF9mcmVlIChwbHQpOwogICAgICAgICAgICBpZiAocmVzID09IDApIHsKICAgICAgICAgICAgICAgIC8vIHN1Y2NlZWRlZCAtLSBwbGF5aW5nIG5vdwogICAgICAgICAgICAgICAgaWYgKGZyb20pIHsKICAgICAgICAgICAgICAgICAgICBwbF9pdGVtX3VucmVmIChmcm9tKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh0bykgewogICAgICAgICAgICAgICAgICAgIHBsX2l0ZW1fdW5yZWYgKHRvKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChidWYpIHsKICAgICAgICAgICAgICAgICAgICBmcmVlIChidWYpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdW5saW5rICh0ZW1wZmlsZSk7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzOwogICAgICAgICAgICB9CgptM3VfZXJyb3I6CiAgICAgICAgICAgIGlmICgqdGVtcGZpbGUpIHsKICAgICAgICAgICAgICAgIHVubGluayAodGVtcGZpbGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVyciA9IC0xOwogICAgICAgICAgICBpZiAoYnVmKSB7CiAgICAgICAgICAgICAgICBmcmVlIChidWYpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvdXQpIHsKICAgICAgICAgICAgICAgIGZjbG9zZSAob3V0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChmZCAhPSAtMSkgewogICAgICAgICAgICAgICAgY2xvc2UgKGZkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBnb3RvIGVycm9yOwogICAgICAgIH0KICAgICAgICBzdHJlYW1lcl9maWxlID0gTlVMTDsKICAgICAgICB2ZnNfZmNsb3NlIChmcCk7CiAgICB9CiAgICBwbGF5bGlzdF90cmFjayA9IGl0OwoKICAgIGludCBwbHVnX2lkeCA9IDA7CiAgICBmb3IgKDs7KSB7CiAgICAgICAgaWYgKCFkZWNvZGVyX2lkWzBdICYmIHBsdWdzWzBdICYmICFwbHVnc1twbHVnX2lkeF0pIHsKICAgICAgICAgICAgaXQtPnBsYXllZCA9IDE7CiAgICAgICAgICAgIHRyYWNlICgiZGVjb2Rlci0-aW5pdCByZXR1cm5lZCAlcFxuIiwgbmV3X2ZpbGVpbmZvKTsKICAgICAgICAgICAgc3RyZWFtZXJfYnVmZmVyaW5nID0gMDsKICAgICAgICAgICAgaWYgKHBsYXlsaXN0X3RyYWNrID09IGl0KSB7CiAgICAgICAgICAgICAgICB0cmFjZSAoInJlZHJhdyB0cmFjayAlcDsgcGxheWluZ190cmFjaz0lcDsgcGxheWxpc3RfdHJhY2s9JXBcbiIsIHRvLCBwbGF5aW5nX3RyYWNrLCBwbGF5bGlzdF90cmFjayk7CiAgICAgICAgICAgICAgICBzZW5kX3RyYWNraW5mb2NoYW5nZWQgKHRvKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBlcnIgPSAtMTsKICAgICAgICAgICAgZ290byBlcnJvcjsKICAgICAgICB9CgogICAgICAgIERCX2RlY29kZXJfdCAqZGVjID0gTlVMTDsKCiAgICAgICAgaWYgKGRlY29kZXJfaWRbMF0pIHsKICAgICAgICAgICAgZGVjID0gcGx1Z19nZXRfZGVjb2Rlcl9mb3JfaWQgKGRlY29kZXJfaWQpOwogICAgICAgICAgICBkZWNvZGVyX2lkWzBdID0gMDsKICAgICAgICAgICAgaWYgKCFkZWMpIHsKICAgICAgICAgICAgICAgIC8vIGZpbmQgbmV3IGRlY29kZXIgYnkgZmlsZSBleHRlbnNpb24KICAgICAgICAgICAgICAgIHBsX2xvY2sgKCk7CiAgICAgICAgICAgICAgICBjb25zdCBjaGFyICpmbmFtZSA9IHBsX2ZpbmRfbWV0YSAoaXQsICI6VVJJIik7CiAgICAgICAgICAgICAgICBjb25zdCBjaGFyICpleHQgPSBzdHJyY2hyIChmbmFtZSwgJy4nKTsKICAgICAgICAgICAgICAgIGlmIChleHQpIHsKICAgICAgICAgICAgICAgICAgICBleHQrKzsKICAgICAgICAgICAgICAgICAgICBEQl9kZWNvZGVyX3QgKipkZWNzID0gcGx1Z19nZXRfZGVjb2Rlcl9saXN0ICgpOwogICAgICAgICAgICAgICAgICAgIGZvciAoaW50IGkgPSAwOyBkZWNzW2ldOyBpKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2hhciAqKmV4dHMgPSBkZWNzW2ldLT5leHRzOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXh0cykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpbnQgaiA9IDA7IGV4dHNbal07IGorKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc3RyY2FzZWNtcCAoZXh0c1tqXSwgZXh0KSB8fCAhc3RyY21wIChleHRzW2pdLCAiKiIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZwcmludGYgKHN0ZGVyciwgInN0cmVhbWVyOiAlcyA6IGNoYW5nZWQgZGVjb2RlciBwbHVnaW4gdG8gJXNcbiIsIGZuYW1lLCBkZWNzW2ldLT5wbHVnaW4uaWQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwbF9yZXBsYWNlX21ldGEgKGl0LCAiIURFQ09ERVIiLCBkZWNzW2ldLT5wbHVnaW4uaWQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwbF9yZXBsYWNlX21ldGEgKGl0LCAiIUZJTEVUWVBFIiwgZXh0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVjID0gZGVjc1tpXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgcGxfdW5sb2NrICgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKHBsdWdzWzBdKSB7CiAgICAgICAgICAgIC8vIG1hdGNoIGJ5IGRlY29kZXIKICAgICAgICAgICAgZGVjID0gcGx1Z19nZXRfZGVjb2Rlcl9mb3JfaWQgKHBsdWdzW3BsdWdfaWR4XSk7CiAgICAgICAgICAgIGlmIChkZWMpIHsKICAgICAgICAgICAgICAgIHBsX3JlcGxhY2VfbWV0YSAoaXQsICIhREVDT0RFUiIsIGRlYy0-cGx1Z2luLmlkKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwbHVnX2lkeCsrOwogICAgICAgIH0KCiAgICAgICAgaWYgKCFkZWMpIHsKICAgICAgICAgICAgdHJhY2UgKCJubyBkZWNvZGVyIGluIHBsYXlpdGVtIVxuIik7CiAgICAgICAgICAgIGl0LT5wbGF5ZWQgPSAxOwogICAgICAgICAgICBzdHJlYW1lcl9idWZmZXJpbmcgPSAwOwogICAgICAgICAgICBpZiAocGxheWxpc3RfdHJhY2sgPT0gaXQpIHsKICAgICAgICAgICAgICAgIHNlbmRfdHJhY2tpbmZvY2hhbmdlZCAodG8pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChmcm9tKSB7CiAgICAgICAgICAgICAgICBwbF9pdGVtX3VucmVmIChmcm9tKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodG8pIHsKICAgICAgICAgICAgICAgIHBsX2l0ZW1fdW5yZWYgKHRvKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgfQoKICAgICAgICB0cmFjZSAoIlwwMzNbMDszM21pbml0IGRlY29kZXIgZm9yICVzICglcylcMDMzWzM3OzBtXG4iLCBwbF9maW5kX21ldGEgKGl0LCAiOlVSSSIpLCBkZWMtPnBsdWdpbi5pZCk7CiAgICAgICAgbmV3X2ZpbGVpbmZvID0gZGVjX29wZW4gKGRlYywgU1RSRUFNRVJfSElOVFMsIGl0KTsKICAgICAgICBpZiAobmV3X2ZpbGVpbmZvLT5maWxlKSB7CiAgICAgICAgICAgIG5ld19maWxlaW5mb19maWxlID0gbmV3X2ZpbGVpbmZvLT5maWxlOwogICAgICAgIH0KICAgICAgICBpZiAobmV3X2ZpbGVpbmZvICYmIGRlYy0-aW5pdCAobmV3X2ZpbGVpbmZvLCBEQl9QTEFZSVRFTSAoaXQpKSAhPSAwKSB7CiAgICAgICAgICAgIHRyYWNlICgiXDAzM1swOzMxbWZhaWxlZCB0byBpbml0IGRlY29kZXJcMDMzWzM3OzBtXG4iKTsKICAgICAgICAgICAgcGxfZGVsZXRlX21ldGEgKGl0LCAiIURFQ09ERVIiKTsKICAgICAgICAgICAgZGVjLT5mcmVlIChuZXdfZmlsZWluZm8pOwogICAgICAgICAgICBuZXdfZmlsZWluZm8gPSBOVUxMOwogICAgICAgICAgICBuZXdfZmlsZWluZm9fZmlsZSA9IE5VTEw7CiAgICAgICAgfQoKICAgICAgICBpZiAoIW5ld19maWxlaW5mbykgewogICAgICAgICAgICB0cmFjZSAoImRlY29kZXIgJXMgZmFpbGVkXG4iLCBkZWMtPnBsdWdpbi5pZCk7CiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgbmV3X2ZpbGVpbmZvX2ZpbGUgPSBuZXdfZmlsZWluZm8tPmZpbGU7CiAgICAgICAgICAgIGlmIChzdHJlYW1pbmdfdHJhY2spIHsKICAgICAgICAgICAgICAgIHBsX2l0ZW1fdW5yZWYgKHN0cmVhbWluZ190cmFjayk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgc3RyZWFtaW5nX3RyYWNrID0gaXQ7CiAgICAgICAgICAgIGlmIChzdHJlYW1pbmdfdHJhY2spIHsKICAgICAgICAgICAgICAgIHBsX2l0ZW1fcmVmIChzdHJlYW1pbmdfdHJhY2spOwogICAgICAgICAgICAgICAgc3RyZWFtZXJfc2V0X3JlcGxheWdhaW4gKHN0cmVhbWluZ190cmFjayk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRyYWNlICgiYnBzPSVkLCBjaGFubmVscz0lZCwgc2FtcGxlcmF0ZT0lZFxuIiwgbmV3X2ZpbGVpbmZvLT5mbXQuYnBzLCBuZXdfZmlsZWluZm8tPmZtdC5jaGFubmVscywgbmV3X2ZpbGVpbmZvLT5mbXQuc2FtcGxlcmF0ZSk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgIH0Kc3VjY2VzczoKICAgIGlmIChmaWxlaW5mbykgewogICAgICAgIGZpbGVpbmZvLT5wbHVnaW4tPmZyZWUgKGZpbGVpbmZvKTsKICAgICAgICBmaWxlaW5mbyA9IE5VTEw7CiAgICAgICAgZmlsZWluZm9fZmlsZSA9IE5VTEw7CiAgICB9CiAgICBpZiAobmV3X2ZpbGVpbmZvKSB7CiAgICAgICAgZmlsZWluZm8gPSBuZXdfZmlsZWluZm87CiAgICAgICAgbmV3X2ZpbGVpbmZvID0gTlVMTDsKICAgICAgICBuZXdfZmlsZWluZm9fZmlsZSA9IE5VTEw7CiAgICB9CiAgICBpZiAoZG9fc29uZ3N0YXJ0ZWQgJiYgcGxheWluZ190cmFjaykgewogICAgICAgIHRyYWNlICgic29uZ3N0YXJ0ZWQgJXNcbiIsIHBsYXlpbmdfdHJhY2sgPyBwbF9maW5kX21ldGEgKHBsYXlpbmdfdHJhY2ssICI6VVJJIikgOiAibnVsbCIpOwogICAgICAgIHBsYXl0aW1lID0gMDsKICAgICAgICBzZW5kX3NvbmdzdGFydGVkIChwbGF5aW5nX3RyYWNrKTsKICAgIH0KICAgIHNlbmRfdHJhY2tpbmZvY2hhbmdlZCAodG8pOwoKICAgIHRyYWNlICgiXDAzM1swOzMybXN0cjogJXAgKCVzKSwgcGx5OiAlcCAoJXMpXDAzM1szNzswbVxuIiwgc3RyZWFtaW5nX3RyYWNrLCBzdHJlYW1pbmdfdHJhY2sgPyBwbF9maW5kX21ldGEgKHN0cmVhbWluZ190cmFjaywgIjpVUkkiKSA6ICJudWxsIiwgcGxheWluZ190cmFjaywgcGxheWluZ190cmFjayA_IHBsX2ZpbmRfbWV0YSAocGxheWluZ190cmFjaywgIjpVUkkiKSA6ICJudWxsIik7CgplcnJvcjoKICAgIGlmIChmcm9tKSB7CiAgICAgICAgcGxfaXRlbV91bnJlZiAoZnJvbSk7CiAgICB9CiAgICBpZiAodG8pIHsKICAgICAgICBwbF9pdGVtX3VucmVmICh0byk7CiAgICB9CgogICAgcmV0dXJuIGVycjsKfQoKZmxvYXQKc3RyZWFtZXJfZ2V0X3BsYXlwb3MgKHZvaWQpIHsKICAgIGZsb2F0IHNlZWsgPSBsYXN0X3NlZWtwb3M7CiAgICBpZiAoc2VlayA-PSAwKSB7CiAgICAgICAgcmV0dXJuIHNlZWs7CiAgICB9CiAgICByZXR1cm4gcGxheXBvczsKfQoKdm9pZApzdHJlYW1lcl9zZXRfYml0cmF0ZSAoaW50IGJpdHJhdGUpIHsKICAgIGlmIChieXRlc191bnRpbF9uZXh0X3NvbmcgPD0gMCkgeyAvLyBwcmV2ZW50IG5leHQgdHJhY2sgZnJvbSByZXNldHRpbmcgY3VycmVudCBwbGF5YmFjayBiaXRyYXRlCiAgICAgICAgbGFzdF9iaXRyYXRlID0gYml0cmF0ZTsKICAgIH0KfQoKaW50CnN0cmVhbWVyX2dldF9hcHhfYml0cmF0ZSAodm9pZCkgewogICAgcmV0dXJuIGF2Z19iaXRyYXRlOwp9Cgp2b2lkCnN0cmVhbWVyX3NldF9uZXh0c29uZyAoaW50IHNvbmcsIGludCBwc3RhdGUpIHsKLy8gICAgcHRocmVhZF90IHRpZCA9IHB0aHJlYWRfc2VsZiAoKTsKLy8gICAgYXNzZXJ0ICh0aWQgIT0gc3RyZWFtZXJfdGlkKTsKICAgIGlmIChwc3RhdGUgPT0gMCkgewogICAgICAgIC8vIHRoaXMgaXMgYSBzdG9wIHF1ZXJ5IC0tIGNsZWFyIHRoZSBxdWV1ZQogICAgICAgIGhhbmRsZXJfcmVzZXQgKGhhbmRsZXIpOwogICAgfQogICAgc3RyZWFtZXJfYWJvcnRfZmlsZXMgKCk7CiAgICBoYW5kbGVyX3B1c2ggKGhhbmRsZXIsIFNUUl9FVl9QTEFZX1RSQUNLX0lEWCwgMCwgc29uZywgcHN0YXRlKTsKfQoKc3RhdGljIHZvaWQKc3RyZWFtZXJfc2V0X25leHRzb25nX3JlYWwgKGludCBzb25nLCBpbnQgcHN0YXRlKSB7CiAgICBEQl9vdXRwdXRfdCAqb3V0cHV0ID0gcGx1Z19nZXRfb3V0cHV0ICgpOwogICAgaWYgKHBzdGF0ZSAhPSA0KSB7CiAgICAgICAgaW50IG4gPSAwOwogICAgfQogICAgdHJhY2UgKCJcMDMzWzA7MzVtc3RyZWFtZXJfc2V0X25leHRzb25nICVkICVkXDAzM1szNzswbVxuIiwgc29uZywgcHN0YXRlKTsKICAgIGlmIChwc3RhdGUgPT0gNCkgewogICAgICAgIHBzdGF0ZSA9IDE7CiAgICAgICAgb3V0cHV0LT5zdG9wICgpOwogICAgfQogICAgc3RyZWFtZXJfbG9jayAoKTsKICAgIG5leHRzb25nID0gc29uZzsKICAgIG5leHRzb25nX3BzdGF0ZSA9IHBzdGF0ZTsKICAgIGlmIChvdXRwdXQtPnN0YXRlICgpID09IE9VVFBVVF9TVEFURV9TVE9QUEVEKSB7CiAgICAgICAgaWYgKHBzdGF0ZSA9PSAxKSB7IC8vIG1lYW5zIHVzZXIgaW5pdGlhdGVkIHRoaXMKICAgICAgICAgICAgcGxfbG9jayAoKTsKICAgICAgICAgICAgaWYgKHN0cmVhbWVyX3BsYXlsaXN0KSB7CiAgICAgICAgICAgICAgICBwbHRfdW5yZWYgKHN0cmVhbWVyX3BsYXlsaXN0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzdHJlYW1lcl9wbGF5bGlzdCA9IHBsdF9nZXRfY3VyciAoKTsKICAgICAgICAgICAgcGxfdW5sb2NrICgpOwogICAgICAgIH0KICAgICAgICAvLyBubyBzZW5zZSB0byB3YWl0IHVudGlsIGVuZCBvZiBwcmV2aW91cyBzb25nLCByZXNldCBidWZmZXIKICAgICAgICBieXRlc191bnRpbF9uZXh0X3NvbmcgPSAwOwogICAgICAgIHBsYXlwb3MgPSAwOwogICAgICAgIGxhc3Rfc2Vla3BvcyA9IC0xOwogICAgfQogICAgaWYgKHBsX2dldF9vcmRlciAoKSA9PSBQTEFZQkFDS19PUkRFUl9TSFVGRkxFX0FMQlVNUykgewogICAgICAgIHBsdF9pbml0X3NodWZmbGVfYWxidW1zIChzdHJlYW1lcl9wbGF5bGlzdCwgc29uZyk7CiAgICB9CiAgICBzdHJlYW1lcl91bmxvY2sgKCk7Cn0KCnN0YXRpYyB2b2lkCnN0cmVhbWVyX3NldF9nZW5lcmljX291dHB1dF9mb3JtYXQgKHZvaWQpIHsKICAgIG91dHB1dF9mb3JtYXQuYnBzID0gMTY7CiAgICBvdXRwdXRfZm9ybWF0LmlzX2Zsb2F0ID0gMDsKICAgIG91dHB1dF9mb3JtYXQuY2hhbm5lbHMgPSAyOwogICAgb3V0cHV0X2Zvcm1hdC5zYW1wbGVyYXRlID0gNDQxMDA7CiAgICBvdXRwdXRfZm9ybWF0LmNoYW5uZWxtYXNrID0gMzsKICAgIHN0cmVhbWVyX3NldF9vdXRwdXRfZm9ybWF0ICgpOwp9Cgp2b2lkCnN0cmVhbWVyX3NldF9zZWVrIChmbG9hdCBwb3MpIHsKICAgIGxhc3Rfc2Vla3BvcyA9IHBvczsKICAgIGhhbmRsZXJfcHVzaCAoaGFuZGxlciwgU1RSX0VWX1NFRUssIDAsICooKHVpbnQzMl90ICopJnBvcyksIDApOwp9CgpzdGF0aWMgdm9pZApzdHJlYW1lcl9zdGFydF9uZXdfc29uZyAodm9pZCkgewogICAgdHJhY2UgKCJuZXh0c29uZz0lZCAoYmFkc29uZz0lZClcbiIsIG5leHRzb25nLCBiYWRzb25nKTsKICAgIHN0cmVhbWVyX2xvY2sgKCk7CiAgICBEQl9vdXRwdXRfdCAqb3V0cHV0ID0gcGx1Z19nZXRfb3V0cHV0ICgpOwogICAgaW50IHNuZyA9IG5leHRzb25nOwogICAgaW50IGluaXRzbmcgPSBuZXh0c29uZzsKICAgIGludCBwc3RhdGUgPSBuZXh0c29uZ19wc3RhdGU7CiAgICBuZXh0c29uZyA9IC0xOwogICAgc3RyZWFtZXJfdW5sb2NrICgpOwogICAgaWYgKGJhZHNvbmcgPT0gc25nKSB7CiAgICAgICAgdHJhY2UgKCJsb29wZWQgdG8gYmFkIGZpbGUuIHN0b3BwaW5nLi4uXG4iKTsKICAgICAgICBzdHJlYW1lcl9zZXRfbmV4dHNvbmdfcmVhbCAoLTIsIC0yKTsKICAgICAgICBiYWRzb25nID0gLTE7CiAgICAgICAgcmV0dXJuOwogICAgfQogICAgcGxheUl0ZW1fdCAqdHJ5ID0gc3RyX2dldF9mb3JfaWR4IChzbmcpOwogICAgaWYgKCF0cnkpIHsgLy8gdHJhY2sgaXMgbm90IGluIHBsYXlsaXN0CiAgICAgICAgdHJhY2UgKCJ0cmFjayAjJWQgaXMgbm90IGluIHBsYXlsaXN0OyBzdG9wcGluZyBwbGF5YmFja1xuIiwgc25nKTsKICAgICAgICBvdXRwdXQtPnN0b3AgKCk7CgogICAgICAgIG11dGV4X2xvY2sgKGN1cnJ0cmFja19tdXRleCk7CiAgICAgICAgaWYgKHBsYXlpbmdfdHJhY2spIHsKICAgICAgICAgICAgcGxfaXRlbV91bnJlZiAocGxheWluZ190cmFjayk7CiAgICAgICAgICAgIHBsYXlpbmdfdHJhY2sgPSBOVUxMOwogICAgICAgIH0KICAgICAgICBpZiAoc3RyZWFtaW5nX3RyYWNrKSB7CiAgICAgICAgICAgIHBsX2l0ZW1fdW5yZWYgKHN0cmVhbWluZ190cmFjayk7CiAgICAgICAgICAgIHN0cmVhbWluZ190cmFjayA9IE5VTEw7CiAgICAgICAgfQogICAgICAgIG11dGV4X3VubG9jayAoY3VycnRyYWNrX211dGV4KTsKCiAgICAgICAgc2VuZF90cmFja2NoYW5nZWQgKE5VTEwsIE5VTEwpOwogICAgICAgIHJldHVybjsKICAgIH0KICAgIGludCByZXQgPSBzdHJlYW1lcl9zZXRfY3VycmVudCAodHJ5KTsKCiAgICBpZiAocmV0IDwgMCkgewogICAgICAgIHRyYWNlICgiXDAzM1swOzMxbWZhaWxlZCB0byBwbGF5IHRyYWNrICVzLCBza2lwcGluZyAoY3VycmVudD0lcC8lcCkuLi5cMDMzWzM3OzBtXG4iLCBwbF9maW5kX21ldGEgKHRyeSwgIjpVUkkiKSwgc3RyZWFtaW5nX3RyYWNrLCBwbGF5bGlzdF90cmFjayk7CiAgICAgICAgcGxfaXRlbV91bnJlZiAodHJ5KTsKICAgICAgICB0cnkgPSBOVUxMOwogICAgICAgIC8vIHJlbWVtYmVyIGJhZCBzb25nIG51bWJlciBpbiBjYXNlIG9mIGxvb3BpbmcKICAgICAgICBpZiAoYmFkc29uZyA9PSAtMSkgewogICAgICAgICAgICBiYWRzb25nID0gc25nOwogICAgICAgIH0KICAgICAgICB0cmFjZSAoIlwwMzNbMDszNG1iYWRzb25nPSVkXDAzM1szNzswbVxuIiwgYmFkc29uZyk7CiAgICAgICAgLy8gdHJ5IGp1bXAgdG8gbmV4dCBzb25nCiAgICAgICAgaWYgKG5leHRzb25nID09IC0xKSB7CiAgICAgICAgICAgIHRyYWNlICgic3RyZWFtZXJfbW92ZV90b19uZXh0c29uZyBhZnRlciBza2lwXG4iKTsKICAgICAgICAgICAgc3RyZWFtZXJfbW92ZV90b19uZXh0c29uZ19yZWFsICgxKTsKICAgICAgICAgICAgdXNsZWVwICg1MDAwMCk7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICB0cmFjZSAoIm5leHRzb25nIGNoYW5nZWQgZnJvbSAlZCB0byAlZCBieSBhbm90aGVyIHRocmVhZCwgcmVpbml0XG4iLCBpbml0c25nLCBuZXh0c29uZyk7CiAgICAgICAgICAgIGJhZHNvbmcgPSAtMTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuOwogICAgfQogICAgcGxfaXRlbV91bnJlZiAodHJ5KTsKICAgIHRyeSA9IE5VTEw7CiAgICBiYWRzb25nID0gLTE7CiAgICB0cmFjZSAoInBzdGF0ZSA9ICVkXG4iLCBwc3RhdGUpOwogICAgdHJhY2UgKCJwbGF5YmFjayBzdGF0ZSA9ICVkXG4iLCBvdXRwdXQtPnN0YXRlICgpKTsKICAgIGlmIChwc3RhdGUgPT0gMCkgewogICAgICAgIG91dHB1dC0-c3RvcCAoKTsKICAgIH0KICAgIGVsc2UgaWYgKHBzdGF0ZSA9PSAxIHx8IHBzdGF0ZSA9PSAzKSB7CiAgICAgICAgbGFzdF9iaXRyYXRlID0gLTE7CiAgICAgICAgYXZnX2JpdHJhdGUgPSAtMTsKICAgICAgICBpZiAob3V0cHV0LT5zdGF0ZSAoKSAhPSBPVVRQVVRfU1RBVEVfUExBWUlORykgewogICAgICAgICAgICBzdHJlYW1lcl9yZXNldCAoMSk7CiAgICAgICAgICAgIGlmIChmaWxlaW5mbyAmJiBtZW1jbXAgKCZvcmlnX291dHB1dF9mb3JtYXQsICZmaWxlaW5mby0-Zm10LCBzaXplb2YgKGRkYl93YXZlZm9ybWF0X3QpKSkgewogICAgICAgICAgICAgICAgbWVtY3B5ICgmb3V0cHV0X2Zvcm1hdCwgJmZpbGVpbmZvLT5mbXQsIHNpemVvZiAoZGRiX3dhdmVmb3JtYXRfdCkpOwogICAgICAgICAgICAgICAgbWVtY3B5ICgmb3JpZ19vdXRwdXRfZm9ybWF0LCAmZmlsZWluZm8tPmZtdCwgc2l6ZW9mIChkZGJfd2F2ZWZvcm1hdF90KSk7Ci8vICAgICAgICAgICAgICAgIGZwcmludGYgKHN0ZGVyciwgInN0cmVhbWVyX3NldF9vdXRwdXRfZm9ybWF0ICVkYml0ICVzICVkY2ggJWRIeiBjaGFubmVsbWFzaz0lWFxuIiwgb3V0cHV0X2Zvcm1hdC5icHMsIG91dHB1dF9mb3JtYXQuaXNfZmxvYXQgPyAiZmxvYXQiIDogImludCIsIG91dHB1dF9mb3JtYXQuY2hhbm5lbHMsIG91dHB1dF9mb3JtYXQuc2FtcGxlcmF0ZSwgb3V0cHV0X2Zvcm1hdC5jaGFubmVsbWFzayk7CiAgICAgICAgICAgICAgICBzdHJlYW1lcl9zZXRfb3V0cHV0X2Zvcm1hdCAoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoMCAhPSBvdXRwdXQtPnBsYXkgKCkpIHsKICAgICAgICAgICAgICAgIC8vIGdpdmUgYSBjaGFuY2UgdG8gRFNQIHBsdWdpbnMgdG8gY29udmVydCBmb3JtYXQgdG8gc29tZXRoaW5nCiAgICAgICAgICAgICAgICAvLyBzdXBwb3J0ZWQKICAgICAgICAgICAgICAgIHN0cmVhbWVyX3NldF9nZW5lcmljX291dHB1dF9mb3JtYXQgKCk7CiAgICAgICAgICAgICAgICBpZiAoMCAhPSBvdXRwdXQtPnBsYXkgKCkpIHsKICAgICAgICAgICAgICAgICAgICBtZW1zZXQgKCZvcmlnX291dHB1dF9mb3JtYXQsIDAsIHNpemVvZiAob3JpZ19vdXRwdXRfZm9ybWF0KSk7CiAgICAgICAgICAgICAgICAgICAgZnByaW50ZiAoc3RkZXJyLCAic3RyZWFtZXI6IGZhaWxlZCB0byBzdGFydCBwbGF5YmFjayAoc3RhcnQgdHJhY2spXG4iKTsKICAgICAgICAgICAgICAgICAgICBzdHJlYW1lcl9zZXRfbmV4dHNvbmdfcmVhbCAoLTIsIDApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgZWxzZSBpZiAocHN0YXRlID09IDIpIHsKICAgICAgICBpZiAob3V0cHV0LT5zdGF0ZSAoKSA9PSBPVVRQVVRfU1RBVEVfU1RPUFBFRCkgewogICAgICAgICAgICBsYXN0X2JpdHJhdGUgPSAtMTsKICAgICAgICAgICAgYXZnX2JpdHJhdGUgPSAtMTsKICAgICAgICAgICAgc3RyZWFtZXJfcmVzZXQgKDEpOwogICAgICAgICAgICBpZiAoZmlsZWluZm8gJiYgbWVtY21wICgmb3JpZ19vdXRwdXRfZm9ybWF0LCAmZmlsZWluZm8tPmZtdCwgc2l6ZW9mIChkZGJfd2F2ZWZvcm1hdF90KSkpIHsKICAgICAgICAgICAgICAgIG1lbWNweSAoJm9yaWdfb3V0cHV0X2Zvcm1hdCwgJmZpbGVpbmZvLT5mbXQsIHNpemVvZiAoZGRiX3dhdmVmb3JtYXRfdCkpOwogICAgICAgICAgICAgICAgbWVtY3B5ICgmb3V0cHV0X2Zvcm1hdCwgJmZpbGVpbmZvLT5mbXQsIHNpemVvZiAoZGRiX3dhdmVmb3JtYXRfdCkpOwogICAgICAgICAgICAgICAgc3RyZWFtZXJfc2V0X291dHB1dF9mb3JtYXQgKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gd2UgbmVlZCB0byBzdGFydCBwbGF5YmFjayBiZWZvcmUgd2UgY2FuIHBhdXNlIGl0CiAgICAgICAgICAgIGlmICgwICE9IG91dHB1dC0-cGxheSAoKSkgewogICAgICAgICAgICAgICAgbWVtc2V0ICgmb3JpZ19vdXRwdXRfZm9ybWF0LCAwLCBzaXplb2YgKG9yaWdfb3V0cHV0X2Zvcm1hdCkpOwogICAgICAgICAgICAgICAgZnByaW50ZiAoc3RkZXJyLCAic3RyZWFtZXI6IGZhaWxlZCB0byBzdGFydCBwbGF5YmFjayAoc3RhcnQgdHJhY2spXG4iKTsKICAgICAgICAgICAgICAgIHN0cmVhbWVyX3NldF9uZXh0c29uZ19yZWFsICgtMiwgMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgb3V0cHV0LT5wYXVzZSAoKTsKICAgIH0KfQoKc3RhdGljIHZvaWQKc3RyZWFtZXJfbmV4dCAoaW50IGJ5dGVzcmVhZCkgewogICAgc3RyZWFtZXJfbG9jayAoKTsKICAgIGJ5dGVzX3VudGlsX25leHRfc29uZyA9IHN0cmVhbWVyX3JpbmdidWYucmVtYWluaW5nICsgYnl0ZXNyZWFkOwogICAgc3RyZWFtZXJfdW5sb2NrICgpOwogICAgaWYgKHN0b3BfYWZ0ZXJfY3VycmVudCkgewogICAgICAgIHN0cmVhbWVyX2J1ZmZlcmluZyA9IDA7CiAgICAgICAgc3RyZWFtZXJfc2V0X25leHRzb25nX3JlYWwgKC0yLCAtMik7CiAgICAgICAgaWYgKGNvbmZfZ2V0X2ludCAoInBsYXlsaXN0LnN0b3BfYWZ0ZXJfY3VycmVudF9yZXNldCIsIDApKSB7CiAgICAgICAgICAgIGNvbmZfc2V0X2ludCAoInBsYXlsaXN0LnN0b3BfYWZ0ZXJfY3VycmVudCIsIDApOwogICAgICAgICAgICBzdG9wX2FmdGVyX2N1cnJlbnQgPSAwOwogICAgICAgICAgICBkZWFkYmVlZi0-c2VuZG1lc3NhZ2UgKERCX0VWX0NPTkZJR0NIQU5HRUQsIDAsIDAsIDApOwogICAgICAgIH0KICAgIH0KICAgIGVsc2UgewogICAgICAgIHRyYWNlICgic3RyZWFtZXJfbW92ZV90b19uZXh0c29uZyAoMCkgY2FsbGVkIGZyb20gc3RyZWFtZXJfbmV4dFxuIik7CiAgICAgICAgc3RyZWFtZXJfbW92ZV90b19uZXh0c29uZ19yZWFsICgwKTsKICAgIH0KfQoKc3RhdGljIHZvaWQKc3RyZWFtZXJfZHNwX3Bvc3Rpbml0ICh2b2lkKTsKCnN0YXRpYyB2b2lkCnN0cmVhbWVyX3NldF9kc3BfY2hhaW5fcmVhbCAoZGRiX2RzcF9jb250ZXh0X3QgKmNoYWluKTsKCnN0YXRpYyB2b2lkCnN0cmVhbWVyX25vdGlmeV9vcmRlcl9jaGFuZ2VkX3JlYWwgKGludCBwcmV2X29yZGVyLCBpbnQgbmV3X29yZGVyKTsKCnN0YXRpYyB2b2lkCmZyZWVfZHNwX2J1ZmZlcnMgKHZvaWQpOwoKdm9pZApzdHJlYW1lcl90aHJlYWQgKHZvaWQgKmN0eCkgewojaWZkZWYgX19saW51eF9fCiAgICBwcmN0bCAoUFJfU0VUX05BTUUsICJkZWFkYmVlZi1zdHJlYW0iLCAwLCAwLCAwLCAwKTsKI2VuZGlmCgogICAgd2hpbGUgKCFzdHJlYW1pbmdfdGVybWluYXRlKSB7CiAgICAgICAgZmxvYXQgc2Vla3BvcyA9IC0xOwoKICAgICAgICBzdHJ1Y3QgdGltZXZhbCB0bTE7CiAgICAgICAgREJfb3V0cHV0X3QgKm91dHB1dCA9IHBsdWdfZ2V0X291dHB1dCAoKTsKICAgICAgICBnZXR0aW1lb2ZkYXkgKCZ0bTEsIE5VTEwpOwoKICAgICAgICB1aW50MzJfdCBpZDsKICAgICAgICB1aW50cHRyX3QgY3R4OwogICAgICAgIHVpbnQzMl90IHAxLCBwMjsKICAgICAgICBpZiAoIWhhbmRsZXJfcG9wIChoYW5kbGVyLCAmaWQsICZjdHgsICZwMSwgJnAyKSkgewogICAgICAgICAgICBzd2l0Y2ggKGlkKSB7CiAgICAgICAgICAgIGNhc2UgU1RSX0VWX1BMQVlfVFJBQ0tfSURYOgogICAgICAgICAgICAgICAgc3RyZWFtZXJfc2V0X25leHRzb25nX3JlYWwgKHAxLCBwMik7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBTVFJfRVZfUExBWV9DVVJSOgogICAgICAgICAgICAgICAgc3RyZWFtZXJfcGxheV9jdXJyZW50X3RyYWNrX3JlYWwgKCk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBTVFJfRVZfTkVYVDoKICAgICAgICAgICAgICAgIHN0cmVhbWVyX21vdmVfdG9fbmV4dHNvbmdfcmVhbCAocDEpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgU1RSX0VWX1BSRVY6CiAgICAgICAgICAgICAgICBzdHJlYW1lcl9tb3ZlX3RvX3ByZXZzb25nX3JlYWwgKHAxKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFNUUl9FVl9SQU5EOgogICAgICAgICAgICAgICAgc3RyZWFtZXJfbW92ZV90b19yYW5kb21zb25nX3JlYWwgKHAxKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFNUUl9FVl9TRUVLOgogICAgICAgICAgICAgICAgc2Vla3BvcyA9ICooKGZsb2F0ICopJnAxKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFNUUl9FVl9TRVRfQ1VSUl9QTFQ6CiAgICAgICAgICAgICAgICBzdHJlYW1lcl9zZXRfY3VycmVudF9wbGF5bGlzdF9yZWFsIChwMSk7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgY2FzZSBTVFJfRVZfRFNQX1JFTE9BRDoKICAgICAgICAgICAgICAgIHN0cmVhbWVyX2RzcF9wb3N0aW5pdCAoKTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICBjYXNlIFNUUl9FVl9TRVRfRFNQX0NIQUlOOgogICAgICAgICAgICAgICAgc3RyZWFtZXJfc2V0X2RzcF9jaGFpbl9yZWFsICgoZGRiX2RzcF9jb250ZXh0X3QgKiljdHgpOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIGNhc2UgU1RSX0VWX09SREVSX0NIQU5HRUQ6CiAgICAgICAgICAgICAgICBzdHJlYW1lcl9ub3RpZnlfb3JkZXJfY2hhbmdlZF9yZWFsKHAxLCBwMik7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKG5leHRzb25nID49IDApIHsgLy8gc3RhcnQgc3RyZWFtaW5nIG5leHQgc29uZwogICAgICAgICAgICB0cmFjZSAoIlwwMzNbMDszNG1uZXh0c29uZz0lZFwwMzNbMzc7MG1cbiIsIG5leHRzb25nKTsKICAgICAgICAgICAgc3RyZWFtZXJfc3RhcnRfbmV3X3NvbmcgKCk7CiAgICAgICAgICAgIGlmIChuZXh0c29uZ19wc3RhdGUgPT0gMikgewogICAgICAgICAgICAgICAgbmV4dHNvbmdfcHN0YXRlID0gLTE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgLy8gaXQncyB0b3RhbGx5IHBvc3NpYmxlIHRoYXQgc29uZyB3YXMgc3dpdGNoZWQKICAgICAgICAgICAgLy8gd2hpbGUgc3RyZWFtZXJfc2V0X2N1cnJlbnQgd2FzIHJ1bm5pbmcsCiAgICAgICAgICAgIC8vIHNvIHdlIG5lZWQgdG8gcmVzdGFydCBoZXJlCiAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChuZXh0c29uZyA9PSAtMiAmJiAobmV4dHNvbmdfcHN0YXRlPT0wIHx8IGJ5dGVzX3VudGlsX25leHRfc29uZyA9PSAwKSkgewogICAgICAgICAgICBzdHJlYW1lcl9sb2NrICgpOwogICAgICAgICAgICBwbGF5SXRlbV90ICpmcm9tID0gcGxheWluZ190cmFjazsKICAgICAgICAgICAgYnl0ZXNfdW50aWxfbmV4dF9zb25nID0gLTE7CiAgICAgICAgICAgIHRyYWNlICgibmV4dHNvbmc9LTJcbiIpOwogICAgICAgICAgICBuZXh0c29uZyA9IC0xOwogICAgICAgICAgICBpZiAocGxheWluZ190cmFjaykgewogICAgICAgICAgICAgICAgdHJhY2UgKCJzZW5kaW5nIHNvbmdmaW5pc2hlZCB0byBwbHVnaW5zIFsxXVxuIik7CiAgICAgICAgICAgICAgICBzZW5kX3NvbmdmaW5pc2hlZCAocGxheWluZ190cmFjayk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGZyb20pIHsKICAgICAgICAgICAgICAgIHBsX2l0ZW1fcmVmIChmcm9tKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBzdHJlYW1lcl9zZXRfY3VycmVudCAoTlVMTCk7CiAgICAgICAgICAgIGlmIChwbGF5aW5nX3RyYWNrKSB7CiAgICAgICAgICAgICAgICBwbF9pdGVtX3VucmVmIChwbGF5aW5nX3RyYWNrKTsKICAgICAgICAgICAgICAgIHBsYXlpbmdfdHJhY2sgPSBOVUxMOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHNlbmRfdHJhY2tjaGFuZ2VkIChmcm9tLCBOVUxMKTsKICAgICAgICAgICAgaWYgKGZyb20pIHsKICAgICAgICAgICAgICAgIHBsX2l0ZW1fdW5yZWYgKGZyb20pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHN0cmVhbWVyX3VubG9jayAoKTsKICAgICAgICAgICAgb3V0cHV0LT5zdG9wICgpOwogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAob3V0cHV0LT5zdGF0ZSAoKSA9PSBPVVRQVVRfU1RBVEVfU1RPUFBFRCkgewogICAgICAgICAgICB1c2xlZXAgKDUwMDAwKTsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgfQoKICAgICAgICBpZiAoYnl0ZXNfdW50aWxfbmV4dF9zb25nID09IDApIHsKICAgICAgICAgICAgc3RyZWFtZXJfbG9jayAoKTsKICAgICAgICAgICAgaWYgKCFzdHJlYW1pbmdfdHJhY2spIHsKICAgICAgICAgICAgICAgIC8vIG1lYW5zIGxhc3Qgc29uZyB3YXMgZGVsZXRlZCBkdXJpbmcgZmluYWwgZHJhaW4KICAgICAgICAgICAgICAgIG5leHRzb25nID0gLTE7CiAgICAgICAgICAgICAgICBvdXRwdXQtPnN0b3AgKCk7CiAgICAgICAgICAgICAgICBzdHJlYW1lcl9zZXRfY3VycmVudCAoTlVMTCk7CiAgICAgICAgICAgICAgICBzdHJlYW1lcl91bmxvY2sgKCk7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0cmFjZSAoImJ5dGVzX3VudGlsX25leHRfc29uZz0wLCBzdGFydGluZyBwbGF5YmFjayBvZiBuZXcgc29uZ1xuIik7CiAgICAgICAgICAgIC8vcGxheUl0ZW1fdCAqZnJvbSA9IHBsYXlpbmdfdHJhY2s7CiAgICAgICAgICAgIC8vcGxheUl0ZW1fdCAqdG8gPSBzdHJlYW1pbmdfdHJhY2s7CiAgICAgICAgICAgIHRyYWNlICgic2VuZGluZyBzb25nY2hhbmdlZFxuIik7CiAgICAgICAgICAgIGJ5dGVzX3VudGlsX25leHRfc29uZyA9IC0xOwogICAgICAgICAgICAvLyBwbHVnaW4gd2lsbCBnZXQgcG9pbnRlciB0byBzdHJfcGxheWluZ19zb25nCiAgICAgICAgICAgIGlmIChwbGF5aW5nX3RyYWNrKSB7CiAgICAgICAgICAgICAgICB0cmFjZSAoInNlbmRpbmcgc29uZ2ZpbmlzaGVkIHRvIHBsdWdpbnMgWzJdXG4iKTsKICAgICAgICAgICAgICAgIHNlbmRfc29uZ2ZpbmlzaGVkIChwbGF5aW5nX3RyYWNrKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAvLyBjb3B5IHN0cmVhbWluZyBpbnRvIHBsYXlpbmcKICAgICAgICAgICAgdHJhY2UgKCJcMDMzWzA7MzVtc3RyZWFtZXJfc3RhcnRfcGxheWJhY2tbMl0gZnJvbSAlcCB0byAlcFwwMzNbMzc7MG1cbiIsIHBsYXlpbmdfdHJhY2ssIHN0cmVhbWluZ190cmFjayk7CiAgICAgICAgICAgIHN0cmVhbWVyX3N0YXJ0X3BsYXliYWNrIChwbGF5aW5nX3RyYWNrLCBzdHJlYW1pbmdfdHJhY2spOwogICAgICAgICAgICB0cmFjZSAoInNvbmdzdGFydGVkICVzXG4iLCBwbGF5aW5nX3RyYWNrID8gcGxfZmluZF9tZXRhIChwbGF5aW5nX3RyYWNrLCAiOlVSSSIpIDogIm51bGwiKTsKICAgICAgICAgICAgcGxheXRpbWUgPSAwOwogICAgICAgICAgICBzZW5kX3NvbmdzdGFydGVkIChwbGF5aW5nX3RyYWNrKTsKICAgICAgICAgICAgbGFzdF9iaXRyYXRlID0gLTE7CiAgICAgICAgICAgIGF2Z19iaXRyYXRlID0gLTE7CiAgICAgICAgICAgIHBsYXlsaXN0X3RyYWNrID0gcGxheWluZ190cmFjazsKICAgICAgICAgICAgcGxheXBvcyA9IDA7CiAgICAgICAgICAgIGxhc3Rfc2Vla3BvcyA9IC0xOwogICAgICAgICAgICBzZWVrcG9zID0gLTE7CgogICAgICAgICAgICAvLyBkb24ndCBzd2l0Y2ggaWYgdW5jaGFuZ2VkCiAgICAgICAgICAgIGRkYl93YXZlZm9ybWF0X3QgcHJldmZtdDsKICAgICAgICAgICAgbWVtY3B5ICgmcHJldmZtdCwgJm91dHB1dC0-Zm10LCBzaXplb2YgKGRkYl93YXZlZm9ybWF0X3QpKTsKICAgICAgICAgICAgaWYgKG1lbWNtcCAoJm9yaWdfb3V0cHV0X2Zvcm1hdCwgJmZpbGVpbmZvLT5mbXQsIHNpemVvZiAoZGRiX3dhdmVmb3JtYXRfdCkpKSB7CiAgICAgICAgICAgICAgICBtZW1jcHkgKCZvcmlnX291dHB1dF9mb3JtYXQsICZmaWxlaW5mby0-Zm10LCBzaXplb2YgKGRkYl93YXZlZm9ybWF0X3QpKTsKICAgICAgICAgICAgICAgIG1lbWNweSAoJm91dHB1dF9mb3JtYXQsICZmaWxlaW5mby0-Zm10LCBzaXplb2YgKGRkYl93YXZlZm9ybWF0X3QpKTsKICAgICAgICAgICAgICAgIGZvcm1hdGNoYW5nZWQgPSAxOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHN0cmVhbWVyX3VubG9jayAoKTsKICAgICAgICB9CgogICAgICAgIGlmIChmb3JtYXRjaGFuZ2VkICYmIGJ5dGVzX3VudGlsX25leHRfc29uZyA8PSAwKSB7CiAgICAgICAgICAgIHN0cmVhbWVyX3NldF9vdXRwdXRfZm9ybWF0ICgpOwogICAgICAgICAgICBmb3JtYXRjaGFuZ2VkID0gMDsKICAgICAgICB9CgogICAgICAgIGZsb2F0IHNlZWsgPSBzZWVrcG9zOwogICAgICAgIGlmIChzZWVrID49IDAgJiYgcGxfZ2V0X2l0ZW1fZHVyYXRpb24gKHBsYXlpbmdfdHJhY2spID4gMCkgewogICAgICAgICAgICBwbGF5cG9zID0gc2VlazsKICAgICAgICAgICAgdHJhY2UgKCJzZWVraW5nIHRvICVmXG4iLCBzZWVrKTsKICAgICAgICAgICAgZmxvYXQgcG9zID0gc2VlazsKCiAgICAgICAgICAgIGlmIChwbGF5aW5nX3RyYWNrICE9IHN0cmVhbWluZ190cmFjaykgewogICAgICAgICAgICAgICAgdHJhY2UgKCJzdHJlYW1lciBhbHJlYWR5IHN3aXRjaGVkIHRvIG5leHQgdHJhY2tcbiIpOwoKICAgICAgICAgICAgICAgIC8vIHJlc3RhcnQgcGxheWluZyBmcm9tIG5ldyBwb3NpdGlvbgoKICAgICAgICAgICAgICAgIG11dGV4X2xvY2sgKGN1cnJ0cmFja19tdXRleCk7CiAgICAgICAgICAgICAgICBpZihmaWxlaW5mbykgewogICAgICAgICAgICAgICAgICAgIGZpbGVpbmZvLT5wbHVnaW4tPmZyZWUgKGZpbGVpbmZvKTsKICAgICAgICAgICAgICAgICAgICBmaWxlaW5mbyA9IE5VTEw7CiAgICAgICAgICAgICAgICAgICAgZmlsZWluZm9fZmlsZSA9IE5VTEw7CiAgICAgICAgICAgICAgICAgICAgcGxfaXRlbV91bnJlZiAoc3RyZWFtaW5nX3RyYWNrKTsKICAgICAgICAgICAgICAgICAgICBzdHJlYW1pbmdfdHJhY2sgPSBOVUxMOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RyZWFtaW5nX3RyYWNrID0gcGxheWluZ190cmFjazsKICAgICAgICAgICAgICAgIGlmIChzdHJlYW1pbmdfdHJhY2spIHsKICAgICAgICAgICAgICAgICAgICBwbF9pdGVtX3JlZiAoc3RyZWFtaW5nX3RyYWNrKTsKICAgICAgICAgICAgICAgICAgICBzdHJlYW1lcl9zZXRfcmVwbGF5Z2FpbiAoc3RyZWFtaW5nX3RyYWNrKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIG11dGV4X3VubG9jayAoY3VycnRyYWNrX211dGV4KTsKCiAgICAgICAgICAgICAgICBieXRlc191bnRpbF9uZXh0X3NvbmcgPSAtMTsKICAgICAgICAgICAgICAgIHN0cmVhbWVyX2J1ZmZlcmluZyA9IDE7CiAgICAgICAgICAgICAgICBpZiAoc3RyZWFtaW5nX3RyYWNrKSB7CiAgICAgICAgICAgICAgICAgICAgc2VuZF90cmFja2luZm9jaGFuZ2VkIChzdHJlYW1pbmdfdHJhY2spOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIERCX2RlY29kZXJfdCAqZGVjID0gTlVMTDsKICAgICAgICAgICAgICAgIHBsX2xvY2sgKCk7CiAgICAgICAgICAgICAgICBjb25zdCBjaGFyICpkZWNvZGVyX2lkID0gcGxfZmluZF9tZXRhIChzdHJlYW1pbmdfdHJhY2ssICI6REVDT0RFUiIpOwogICAgICAgICAgICAgICAgaWYgKGRlY29kZXJfaWQpIHsKICAgICAgICAgICAgICAgICAgICBkZWMgPSBwbHVnX2dldF9kZWNvZGVyX2Zvcl9pZCAoZGVjb2Rlcl9pZCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBwbF91bmxvY2sgKCk7CiAgICAgICAgICAgICAgICBpZiAoZGVjKSB7CiAgICAgICAgICAgICAgICAgICAgZmlsZWluZm8gPSBkZWNfb3BlbiAoZGVjLCBTVFJFQU1FUl9ISU5UUywgc3RyZWFtaW5nX3RyYWNrKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZmlsZWluZm8gJiYgZGVjLT5pbml0IChmaWxlaW5mbywgREJfUExBWUlURU0gKHN0cmVhbWluZ190cmFjaykpICE9IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGVjLT5mcmVlIChmaWxlaW5mbyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVpbmZvID0gTlVMTDsKICAgICAgICAgICAgICAgICAgICAgICAgZmlsZWluZm9fZmlsZSA9IE5VTEw7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGZpbGVpbmZvKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbGVpbmZvX2ZpbGUgPSBmaWxlaW5mby0-ZmlsZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKCFkZWMgfHwgIWZpbGVpbmZvKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0cmVhbWluZ190cmFjaykgewogICAgICAgICAgICAgICAgICAgICAgICBzZW5kX3RyYWNraW5mb2NoYW5nZWQgKHN0cmVhbWluZ190cmFjayk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRyYWNlICgiZmFpbGVkIHRvIHJlc3RhcnQgcHJldiB0cmFjayBvbiBzZWVrLCB0cnlpbmcgdG8ganVtcCB0byBuZXh0IHRyYWNrXG4iKTsKICAgICAgICAgICAgICAgICAgICB0cmFjZSAoInN0cmVhbWVyX21vdmVfdG9fbmV4dHNvbmcgZnJvbSBzZWVrXG4iKTsKICAgICAgICAgICAgICAgICAgICBzdHJlYW1lcl9tb3ZlX3RvX25leHRzb25nICgwKTsKICAgICAgICAgICAgICAgICAgICB1c2xlZXAgKDUwMDAwKTsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgYnl0ZXNfdW50aWxfbmV4dF9zb25nID0gLTE7CiAgICAgICAgICAgIHN0cmVhbWVyX2J1ZmZlcmluZyA9IDE7CiAgICAgICAgICAgIGlmIChzdHJlYW1pbmdfdHJhY2spIHsKICAgICAgICAgICAgICAgIHNlbmRfdHJhY2tpbmZvY2hhbmdlZCAoc3RyZWFtaW5nX3RyYWNrKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBmbG9hdCBkdXIgPSBwbF9nZXRfaXRlbV9kdXJhdGlvbiAocGxheWluZ190cmFjayk7CiAgICAgICAgICAgIGlmIChmaWxlaW5mbyAmJiBwbGF5aW5nX3RyYWNrICYmIGR1ciA-IDApIHsKICAgICAgICAgICAgICAgIGlmIChwb3MgPj0gZHVyKSB7CiAgICAgICAgICAgICAgICAgICAgb3V0cHV0LT5zdG9wICgpOwogICAgICAgICAgICAgICAgICAgIHN0cmVhbWVyX21vdmVfdG9fbmV4dHNvbmcgKDEpOwogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RyZWFtZXJfbG9jayAoKTsKICAgICAgICAgICAgICAgIHN0cmVhbWVyX3Jlc2V0ICgxKTsKICAgICAgICAgICAgICAgIGlmIChmaWxlaW5mby0-cGx1Z2luLT5zZWVrIChmaWxlaW5mbywgcG9zKSA-PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgcGxheXBvcyA9IGZpbGVpbmZvLT5yZWFkcG9zOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbGFzdF9iaXRyYXRlID0gLTE7CiAgICAgICAgICAgICAgICBhdmdfYml0cmF0ZSA9IC0xOwogICAgICAgICAgICAgICAgc3RyZWFtZXJfdW5sb2NrKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZGRiX2V2ZW50X3BsYXlwb3NfdCAqZXYgPSAoZGRiX2V2ZW50X3BsYXlwb3NfdCAqKW1lc3NhZ2VwdW1wX2V2ZW50X2FsbG9jIChEQl9FVl9TRUVLRUQpOwogICAgICAgICAgICBldi0-dHJhY2sgPSBEQl9QTEFZSVRFTSAocGxheWluZ190cmFjayk7CiAgICAgICAgICAgIGlmIChwbGF5aW5nX3RyYWNrKSB7CiAgICAgICAgICAgICAgICBwbF9pdGVtX3JlZiAocGxheWluZ190cmFjayk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZXYtPnBsYXlwb3MgPSBwbGF5cG9zOwogICAgICAgICAgICBtZXNzYWdlcHVtcF9wdXNoX2V2ZW50ICgoZGRiX2V2ZW50X3QqKWV2LCAwLCAwKTsKICAgICAgICB9CiAgICAgICAgbGFzdF9zZWVrcG9zID0gLTE7CgogICAgICAgIC8vIHJlYWQgYWhlYWQgYXQgMnggc3BlZWQgb2Ygb3V0cHV0IHNhbXBsZXJhdGUsIGluIDRrIGJsb2NrcwogICAgICAgIGludCByYXRlID0gb3V0cHV0LT5mbXQuc2FtcGxlcmF0ZTsKICAgICAgICBpZiAoIXJhdGUpIHsKICAgICAgICAgICAgdHJhY2UgKCJzdHI6IGdvdCAwIG91dHB1dCBzYW1wbGVyYXRlXG4iKTsKICAgICAgICAgICAgdXNsZWVwKDIwMDAwKTsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgfQogICAgICAgIGludCBjaGFubmVscyA9IG91dHB1dC0-Zm10LmNoYW5uZWxzOwogICAgICAgIGludCBieXRlc19pbl9vbmVfc2Vjb25kID0gcmF0ZSAqIChvdXRwdXQtPmZtdC5icHM-PjMpICogY2hhbm5lbHM7CiAgICAgICAgaW50IGJsb2Nrc2l6ZSA9IGJ5dGVzX2luX29uZV9zZWNvbmQgLyAxMjA7CgogICAgICAgIGlmIChibG9ja3NpemUgPCBNSU5fQkxPQ0tfU0laRSkgewogICAgICAgICAgICBibG9ja3NpemUgPSBNSU5fQkxPQ0tfU0laRTsKICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAoYmxvY2tzaXplID4gTUFYX0JMT0NLX1NJWkUpIHsKICAgICAgICAgICAgYmxvY2tzaXplID0gTUFYX0JMT0NLX1NJWkU7CiAgICAgICAgfQoKICAgICAgICBibG9ja3NpemUgJj0gfjM7IC8vIDRieXRlIGFsaWdubWVudCBpcyByZXF1aXJlZAoKICAgICAgICBpZiAoYnl0ZXNfaW5fb25lX3NlY29uZCA8IGJsb2Nrc2l6ZSkgewogICAgICAgICAgICBieXRlc19pbl9vbmVfc2Vjb25kID0gYmxvY2tzaXplOwogICAgICAgIH0KCiAgICAgICAgaW50IGFsbG9jX3RpbWUgPSAxMDAwIC8gKGJ5dGVzX2luX29uZV9zZWNvbmQgLyBibG9ja3NpemUpOwoKICAgICAgICBpbnQgc2tpcCA9IDA7CiAgICAgICAgaWYgKGJ5dGVzX3VudGlsX25leHRfc29uZyA-PSAwKSB7CiAgICAgICAgICAgIC8vIGNoZWNrIGlmIHN0cmVhbWluZyBmb3JtYXQgZGlmZmVycyBmcm9tIG91dHB1dAogICAgICAgICAgICBpZiAobWVtY21wKCZmaWxlaW5mby0-Zm10LCAmb3JpZ19vdXRwdXRfZm9ybWF0LCBzaXplb2YgKGRkYl93YXZlZm9ybWF0X3QpKSkgewogICAgICAgICAgICAgICAgc2tpcCA9IDE7CiAgICAgICAgICAgICAgICBzdHJlYW1lcl9idWZmZXJpbmcgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHN0cmVhbWVyX2xvY2sgKCk7CgogICAgICAgIGlmICghZm9ybWF0Y2hhbmdlZCAmJiAhc2tpcCAmJiBzdHJlYW1lcl9yaW5nYnVmLnJlbWFpbmluZyA8IChTVFJFQU1fQlVGRkVSX1NJWkUtYmxvY2tzaXplICogTUFYX0RTUF9SQVRJTykpIHsKICAgICAgICAgICAgaW50IHN6ID0gU1RSRUFNX0JVRkZFUl9TSVpFIC0gc3RyZWFtZXJfcmluZ2J1Zi5yZW1haW5pbmc7CiAgICAgICAgICAgIGludCBtaW5zaXplID0gYmxvY2tzaXplOwoKICAgICAgICAgICAgLy8gc3BlZWQgdXAgYnVmZmVyaW5nIHdoZW4gZW1wdHkKICAgICAgICAgICAgaWYgKHN0cmVhbWVyX3JpbmdidWYucmVtYWluaW5nIDwgTUFYX0JMT0NLX1NJWkUpIHsKICAgICAgICAgICAgICAgIG1pbnNpemUgKj0gNDsKICAgICAgICAgICAgICAgIGFsbG9jX3RpbWUgKj0gNDsKICAgICAgICAgICAgfQogICAgICAgICAgICBzeiA9IG1pbiAobWluc2l6ZSwgc3opOwogICAgICAgICAgICBhc3NlcnQgKChzeiYzKSA9PSAwKTsKICAgICAgICAgICAgLy8gYnVmZmVyIG11c3QgYmUgbGFyZ2VyIGVub3VnaCB0byBhY2NvbW9kYXRlIHJlc2FtcGxlcnMvcGl0Y2hlcnMvLi4uCiAgICAgICAgICAgIC8vIEZJWE1FOiBib3VuZHMgY2hlY2tpbmcKICAgICAgICAgICAgc3RyZWFtZXJfdW5sb2NrICgpOwoKICAgICAgICAgICAgLy8gZW5zdXJlIHRoYXQgc2l6ZSBpcyBwb3NzaWJsZSB3aXRoIGN1cnJlbnQgZm9ybWF0CiAgICAgICAgICAgIGludCBzYW1wbGVzaXplID0gb3V0cHV0LT5mbXQuY2hhbm5lbHMgKiAob3V0cHV0LT5mbXQuYnBzPj4zKTsKICAgICAgICAgICAgaWYgKHN6ICUgc2FtcGxlc2l6ZSkgewogICAgICAgICAgICAgICAgc3ogLT0gKHN6ICUgc2FtcGxlc2l6ZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW50IGJ5dGVzcmVhZCA9IDA7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgIGludCBwcmV2X2J1bnMgPSBieXRlc191bnRpbF9uZXh0X3Nvbmc7CiAgICAgICAgICAgICAgICBpbnQgbmIgPSBzdHJlYW1lcl9yZWFkX2FzeW5jIChyZWFkYnVmZmVyK2J5dGVzcmVhZCxzei1ieXRlc3JlYWQpOwogICAgICAgICAgICAgICAgaWYgKG5iIDw9IDApIHsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJ5dGVzcmVhZCArPSBuYjsKICAgICAgICAgICAgICAgIHN0cnVjdCB0aW1ldmFsIHRtMjsKICAgICAgICAgICAgICAgIGdldHRpbWVvZmRheSAoJnRtMiwgTlVMTCk7CiAgICAgICAgICAgICAgICBpbnQgbXMgPSAodG0yLnR2X3NlYyoxMDAwK3RtMi50dl91c2VjLzEwMDApIC0gKHRtMS50dl9zZWMqMTAwMCt0bTEudHZfdXNlYy8xMDAwKTsKICAgICAgICAgICAgICAgIGlmIChtcyA-PSBhbGxvY190aW1lKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAocHJldl9idW5zICE9IGJ5dGVzX3VudGlsX25leHRfc29uZykgewogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IHdoaWxlIChieXRlc3JlYWQgPCBzei0xMDApOwogICAgICAgICAgICBzdHJlYW1lcl9sb2NrICgpOwoKICAgICAgICAgICAgaWYgKGJ5dGVzcmVhZCA-IDApIHsKICAgICAgICAgICAgICAgIHJpbmdidWZfd3JpdGUgKCZzdHJlYW1lcl9yaW5nYnVmLCByZWFkYnVmZmVyLCBieXRlc3JlYWQpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAodHJhY2VfYnVmZmVyZmlsbCA-PSAxKSB7CiAgICAgICAgICAgICAgICBmcHJpbnRmIChzdGRlcnIsICJmaWxsOiAlZCwgcmVhZDogJWQsIHNpemU9JWQsIGJsb2Nrc2l6ZT0lZFxuIiwgKGludClzdHJlYW1lcl9yaW5nYnVmLnJlbWFpbmluZywgKGludClieXRlc3JlYWQsIChpbnQpU1RSRUFNX0JVRkZFUl9TSVpFLCAoaW50KWJsb2Nrc2l6ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgc3RyZWFtZXJfdW5sb2NrICgpOwogICAgICAgIGlmICgoc3RyZWFtZXJfcmluZ2J1Zi5yZW1haW5pbmcgPiAxMjgwMDAgJiYgc3RyZWFtZXJfYnVmZmVyaW5nKSB8fCAhc3RyZWFtaW5nX3RyYWNrKSB7CiAgICAgICAgICAgIHN0cmVhbWVyX2J1ZmZlcmluZyA9IDA7CiAgICAgICAgICAgIGlmIChzdHJlYW1pbmdfdHJhY2spIHsKICAgICAgICAgICAgICAgIHNlbmRfdHJhY2tpbmZvY2hhbmdlZCAoc3RyZWFtaW5nX3RyYWNrKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBzdHJ1Y3QgdGltZXZhbCB0bTI7CiAgICAgICAgZ2V0dGltZW9mZGF5ICgmdG0yLCBOVUxMKTsKCiAgICAgICAgaW50IG1zID0gKHRtMi50dl9zZWMqMTAwMCt0bTIudHZfdXNlYy8xMDAwKSAtICh0bTEudHZfc2VjKjEwMDArdG0xLnR2X3VzZWMvMTAwMCk7CiAgICAgICAgaWYgKHRyYWNlX2J1ZmZlcmZpbGwgPj0gMikgewogICAgICAgICAgICBmcHJpbnRmIChzdGRlcnIsICJzbGVwdCAlZG1zIChhbGxvYz0lZG1zLCBieXRlc3BlcnNlYz0lZCwgY2hhbj0lZCwgYmxvY2tzaXplPSVkKSwgZmlsbDogJWQvJWQgKGN1cnNvcj0lZClcbiIsIChpbnQpKGFsbG9jX3RpbWUtbXMpLCAoaW50KWFsbG9jX3RpbWUsIChpbnQpYnl0ZXNfaW5fb25lX3NlY29uZCwgb3V0cHV0LT5mbXQuY2hhbm5lbHMsIGJsb2Nrc2l6ZSwgKGludClzdHJlYW1lcl9yaW5nYnVmLnJlbWFpbmluZywgU1RSRUFNX0JVRkZFUl9TSVpFLCAoaW50KXN0cmVhbWVyX3JpbmdidWYuY3Vyc29yKTsKICAgICAgICB9CgogICAgICAgIC8vIGFkZCAxbXMgaGVyZSB0byBjb21wZW5zYXRlIHRoZSByb3VuZGluZyBlcnJvcgogICAgICAgIC8vIGFuZCBhbm90aGVyIDFtcyB0byBidWZmZXIgc2xpZ2h0bHkgZmFzdGVyIHRoZW4gcGxheWluZwogICAgICAgIGFsbG9jX3RpbWUgLT0gbXMrMjsKICAgICAgICBpZiAoc3RyZWFtZXJfYnVmZmVyaW5nKSB7CiAgICAgICAgICAgIGFsbG9jX3RpbWUgPSAwOwogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChzdHJlYW1lcl9yaW5nYnVmLnJlbWFpbmluZyA8IFNUUkVBTV9CVUZGRVJfU0laRSAvIDIpIHsKICAgICAgICAgICAgYWxsb2NfdGltZSA-Pj0gMjsgLy8gc3BlZWQtdXAgbG9hZGluZyBhIGxpdHRsZQogICAgICAgIH0KCiAgICAgICAgLy9wcmludGYgKCJzbGVlcDogJWQsIGJ1ZmZlcmluZzogJWQsIGJ1ZmZlcl9zdGFydmluZzogJWQgKCVkLyVkKVxuIiwgYWxsb2NfdGltZSwgc3RyZWFtZXJfYnVmZmVyaW5nLCBzdHJlYW1lcl9yaW5nYnVmLnJlbWFpbmluZyA8IFNUUkVBTV9CVUZGRVJfU0laRSAvIDIsIHN0cmVhbWVyX3JpbmdidWYucmVtYWluaW5nLCBTVFJFQU1fQlVGRkVSX1NJWkUgLyAyKTsKCiAgICAgICAgaWYgKGFsbG9jX3RpbWUgPiAwICYmICFjb25mX3N0cmVhbWVyX25vc2xlZXApIHsKICAgICAgICAgICAgdXNsZWVwIChhbGxvY190aW1lICogMTAwMCk7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKGJ5dGVzX3VudGlsX25leHRfc29uZyA-IDApIHsKICAgICAgICAgICAgdXNsZWVwICgyMDAwMCk7CiAgICAgICAgfQogICAgfQoKICAgIC8vIHN0b3Agc3RyZWFtaW5nIHNvbmcKICAgIGlmIChmaWxlaW5mbykgewogICAgICAgIGZpbGVpbmZvLT5wbHVnaW4tPmZyZWUgKGZpbGVpbmZvKTsKICAgICAgICBmaWxlaW5mbyA9IE5VTEw7CiAgICAgICAgZmlsZWluZm9fZmlsZSA9IE5VTEw7CiAgICB9CiAgICBtdXRleF9sb2NrIChjdXJydHJhY2tfbXV0ZXgpOwogICAgaWYgKHN0cmVhbWluZ190cmFjaykgewogICAgICAgIHBsX2l0ZW1fdW5yZWYgKHN0cmVhbWluZ190cmFjayk7CiAgICAgICAgc3RyZWFtaW5nX3RyYWNrID0gTlVMTDsKICAgIH0KICAgIGlmIChwbGF5aW5nX3RyYWNrKSB7CiAgICAgICAgcGxfaXRlbV91bnJlZiAocGxheWluZ190cmFjayk7CiAgICAgICAgcGxheWluZ190cmFjayA9IE5VTEw7CiAgICB9CiAgICBtdXRleF91bmxvY2sgKGN1cnJ0cmFja19tdXRleCk7Cn0KCnZvaWQKc3RyZWFtZXJfZHNwX2NoYWluX2ZyZWUgKGRkYl9kc3BfY29udGV4dF90ICpkc3BfY2hhaW4pIHsKICAgIHdoaWxlIChkc3BfY2hhaW4pIHsKICAgICAgICBkZGJfZHNwX2NvbnRleHRfdCAqbmV4dCA9IGRzcF9jaGFpbi0-bmV4dDsKICAgICAgICBkc3BfY2hhaW4tPnBsdWdpbi0-Y2xvc2UgKGRzcF9jaGFpbik7CiAgICAgICAgZHNwX2NoYWluID0gbmV4dDsKICAgIH0KfQoKZGRiX2RzcF9jb250ZXh0X3QgKgpzdHJlYW1lcl9kc3BfY2hhaW5fbG9hZCAoY29uc3QgY2hhciAqZm5hbWUpIHsKICAgIGludCBlcnIgPSAxOwogICAgRklMRSAqZnAgPSBmb3BlbiAoZm5hbWUsICJydCIpOwogICAgaWYgKCFmcCkgewogICAgICAgIHJldHVybiBOVUxMOwogICAgfQoKICAgIGNoYXIgdGVtcFsxMDBdOwogICAgZGRiX2RzcF9jb250ZXh0X3QgKmNoYWluID0gTlVMTDsKICAgIGRkYl9kc3BfY29udGV4dF90ICp0YWlsID0gTlVMTDsKICAgIGZvciAoOzspIHsKICAgICAgICAvLyBwbHVnaW4gZW5hYmxlZCB7CiAgICAgICAgaW50IGVuYWJsZWQgPSAwOwogICAgICAgIGludCBlcnIgPSBmc2NhbmYgKGZwLCAiJTk5cyAlZCB7XG4iLCB0ZW1wLCAmZW5hYmxlZCk7CiAgICAgICAgaWYgKGVyciA9PSBFT0YpIHsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKDIgIT0gZXJyKSB7CiAgICAgICAgICAgIGZwcmludGYgKHN0ZGVyciwgImVycm9yIHBsdWdpbiBuYW1lXG4iKTsKICAgICAgICAgICAgZ290byBlcnJvcjsKICAgICAgICB9CgogICAgICAgIERCX2RzcF90ICpwbHVnID0gKERCX2RzcF90ICopZGVhZGJlZWYtPnBsdWdfZ2V0X2Zvcl9pZCAodGVtcCk7CiAgICAgICAgaWYgKCFwbHVnKSB7CiAgICAgICAgICAgIGZwcmludGYgKHN0ZGVyciwgInN0cmVhbWVyX2RzcF9jaGFpbl9sb2FkOiBwbHVnaW4gJXMgbm90IGZvdW5kLiBwcmVzZXQgd2lsbCBub3QgYmUgbG9hZGVkXG4iLCB0ZW1wKTsKICAgICAgICAgICAgZ290byBlcnJvcjsKICAgICAgICB9CiAgICAgICAgZGRiX2RzcF9jb250ZXh0X3QgKmN0eCA9IHBsdWctPm9wZW4gKCk7CiAgICAgICAgaWYgKCFjdHgpIHsKICAgICAgICAgICAgZnByaW50ZiAoc3RkZXJyLCAic3RyZWFtZXJfZHNwX2NoYWluX2xvYWQ6IGZhaWxlZCB0byBvcGVuIGN0eGFuY2Ugb2YgcGx1Z2luICVzXG4iLCB0ZW1wKTsKICAgICAgICAgICAgZ290byBlcnJvcjsKICAgICAgICB9CgogICAgICAgIGlmICh0YWlsKSB7CiAgICAgICAgICAgIHRhaWwtPm5leHQgPSBjdHg7CiAgICAgICAgICAgIHRhaWwgPSBjdHg7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICB0YWlsID0gY2hhaW4gPSBjdHg7CiAgICAgICAgfQoKICAgICAgICBpbnQgbiA9IDA7CiAgICAgICAgZm9yICg7OykgewogICAgICAgICAgICBjaGFyIHZhbHVlWzEwMDBdOwogICAgICAgICAgICBpZiAoIWZnZXRzICh0ZW1wLCBzaXplb2YgKHRlbXApLCBmcCkpIHsKICAgICAgICAgICAgICAgIGZwcmludGYgKHN0ZGVyciwgInN0cmVhbWVyX2RzcF9jaGFpbl9sb2FkOiB1bmV4cGVjdGVkIGVvZiB3aGlsZSByZWFkaW5nIHBsdWdpbiBwYXJhbXNcbiIpOwogICAgICAgICAgICAgICAgZ290byBlcnJvcjsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIXN0cmNtcCAodGVtcCwgIn1cbiIpKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmICgxICE9IHNzY2FuZiAodGVtcCwgIlx0JTEwMDBbXlxuXVxuIiwgdmFsdWUpKSB7CiAgICAgICAgICAgICAgICBmcHJpbnRmIChzdGRlcnIsICJzdHJlYW1lcl9kc3BfY2hhaW5fbG9hZDogZXJyb3IgbG9hZGluZyBwYXJhbSAlZFxuIiwgbik7CiAgICAgICAgICAgICAgICBnb3RvIGVycm9yOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwbHVnLT5udW1fcGFyYW1zKSB7CiAgICAgICAgICAgICAgICBwbHVnLT5zZXRfcGFyYW0gKGN0eCwgbiwgdmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG4rKzsKICAgICAgICB9CiAgICAgICAgY3R4LT5lbmFibGVkID0gZW5hYmxlZDsKICAgIH0KCiAgICBlcnIgPSAwOwplcnJvcjoKICAgIGlmIChlcnIpIHsKICAgICAgICBmcHJpbnRmIChzdGRlcnIsICJzdHJlYW1lcl9kc3BfY2hhaW5fbG9hZDogZXJyb3IgbG9hZGluZyAlc1xuIiwgZm5hbWUpOwogICAgfQogICAgaWYgKGZwKSB7CiAgICAgICAgZmNsb3NlIChmcCk7CiAgICB9CiAgICBpZiAoZXJyICYmIGNoYWluKSB7CiAgICAgICAgc3RyZWFtZXJfZHNwX2NoYWluX2ZyZWUgKGNoYWluKTsKICAgICAgICBjaGFpbiA9IE5VTEw7CiAgICB9CiAgICByZXR1cm4gY2hhaW47Cn0KCmludApzdHJlYW1lcl9kc3BfY2hhaW5fc2F2ZV9pbnRlcm5hbCAoY29uc3QgY2hhciAqZm5hbWUsIGRkYl9kc3BfY29udGV4dF90ICpjaGFpbikgewogICAgY2hhciB0ZW1wZmlsZVtQQVRIX01BWF07CiAgICBzbnByaW50ZiAodGVtcGZpbGUsIHNpemVvZiAodGVtcGZpbGUpLCAiJXMudG1wIiwgZm5hbWUpOwogICAgRklMRSAqZnAgPSBmb3BlbiAodGVtcGZpbGUsICJ3K3QiKTsKICAgIGlmICghZnApIHsKICAgICAgICByZXR1cm4gLTE7CiAgICB9CgogICAgZGRiX2RzcF9jb250ZXh0X3QgKmN0eCA9IGNoYWluOwogICAgd2hpbGUgKGN0eCkgewogICAgICAgIGlmIChmcHJpbnRmIChmcCwgIiVzICVkIHtcbiIsIGN0eC0-cGx1Z2luLT5wbHVnaW4uaWQsIChpbnQpY3R4LT5lbmFibGVkKSA8IDApIHsKICAgICAgICAgICAgZnByaW50ZiAoc3RkZXJyLCAid3JpdGUgdG8gJXMgZmFpbGVkICglcylcbiIsIHRlbXBmaWxlLCBzdHJlcnJvciAoZXJybm8pKTsKICAgICAgICAgICAgZ290byBlcnJvcjsKICAgICAgICB9CiAgICAgICAgaWYgKGN0eC0-cGx1Z2luLT5udW1fcGFyYW1zKSB7CiAgICAgICAgICAgIGludCBuID0gY3R4LT5wbHVnaW4tPm51bV9wYXJhbXMgKCk7CiAgICAgICAgICAgIGludCBpOwogICAgICAgICAgICBmb3IgKGkgPSAwOyBpIDwgbjsgaSsrKSB7CiAgICAgICAgICAgICAgICBjaGFyIHZbMTAwMF07CiAgICAgICAgICAgICAgICBjdHgtPnBsdWdpbi0-Z2V0X3BhcmFtIChjdHgsIGksIHYsIHNpemVvZiAodikpOwogICAgICAgICAgICAgICAgaWYgKGZwcmludGYgKGZwLCAiXHQlc1xuIiwgdikgPCAwKSB7CiAgICAgICAgICAgICAgICAgICAgZnByaW50ZiAoc3RkZXJyLCAid3JpdGUgdG8gJXMgZmFpbGVkICglcylcbiIsIHRlbXBmaWxlLCBzdHJlcnJvciAoZXJybm8pKTsKICAgICAgICAgICAgICAgICAgICBnb3RvIGVycm9yOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChmcHJpbnRmIChmcCwgIn1cbiIpIDwgMCkgewogICAgICAgICAgICBmcHJpbnRmIChzdGRlcnIsICJ3cml0ZSB0byAlcyBmYWlsZWQgKCVzKVxuIiwgdGVtcGZpbGUsIHN0cmVycm9yIChlcnJubykpOwogICAgICAgICAgICBnb3RvIGVycm9yOwogICAgICAgIH0KICAgICAgICBjdHggPSBjdHgtPm5leHQ7CiAgICB9CgogICAgZmNsb3NlIChmcCk7CiAgICBpZiAocmVuYW1lICh0ZW1wZmlsZSwgZm5hbWUpICE9IDApIHsKICAgICAgICBmcHJpbnRmIChzdGRlcnIsICJkc3Bjb25maWcgcmVuYW1lICVzIC0-ICVzIGZhaWxlZDogJXNcbiIsIHRlbXBmaWxlLCBmbmFtZSwgc3RyZXJyb3IgKGVycm5vKSk7CiAgICAgICAgcmV0dXJuIC0xOwogICAgfQogICAgcmV0dXJuIDA7CmVycm9yOgogICAgZmNsb3NlIChmcCk7CiAgICByZXR1cm4gLTE7Cn0KCmludApzdHJlYW1lcl9kc3BfY2hhaW5fc2F2ZSAodm9pZCkgewogICAgY2hhciBmbmFtZVtQQVRIX01BWF07CiAgICBzbnByaW50ZiAoZm5hbWUsIHNpemVvZiAoZm5hbWUpLCAiJXMvZHNwY29uZmlnIiwgcGx1Z19nZXRfY29uZmlnX2RpciAoKSk7CiAgICByZXR1cm4gc3RyZWFtZXJfZHNwX2NoYWluX3NhdmVfaW50ZXJuYWwgKGZuYW1lLCBkc3BfY2hhaW4pOwp9CgpzdGF0aWMgdm9pZApzdHJlYW1lcl9kc3BfcG9zdGluaXQgKHZvaWQpIHsKICAgIC8vIG5vdGUgYWJvdXQgRVEgaGFjazoKICAgIC8vIHdlIDFzdCBjaGVjayBpZiB0aGVyZSdzIGFuIEVRIGluIGRzcCBjaGFpbiwgYW5kIGp1c3QgdXNlIGl0CiAgICAvLyBpZiBub3QgLS0gd2UgYWRkIG91ciBvd24KCiAgICAvLyBlcSBwbHVnCiAgICBpZiAoZXFwbHVnKSB7CiAgICAgICAgZGRiX2RzcF9jb250ZXh0X3QgKnA7CgogICAgICAgIGZvciAocCA9IGRzcF9jaGFpbjsgcDsgcCA9IHAtPm5leHQpIHsKICAgICAgICAgICAgaWYgKCFzdHJjbXAgKHAtPnBsdWdpbi0-cGx1Z2luLmlkLCAic3VwZXJlcSIpKSB7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAocCkgewogICAgICAgICAgICBlcSA9IHA7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICBlcSA9IGVxcGx1Zy0-b3BlbiAoKTsKICAgICAgICAgICAgZXEtPmVuYWJsZWQgPSAwOwogICAgICAgICAgICBlcS0-bmV4dCA9IGRzcF9jaGFpbjsKICAgICAgICAgICAgZHNwX2NoYWluID0gZXE7CiAgICAgICAgfQoKICAgIH0KICAgIGRkYl9kc3BfY29udGV4dF90ICpjdHggPSBkc3BfY2hhaW47CiAgICB3aGlsZSAoY3R4KSB7CiAgICAgICAgaWYgKGN0eC0-ZW5hYmxlZCkgewogICAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgICAgY3R4ID0gY3R4LT5uZXh0OwogICAgfQogICAgaWYgKCFjdHggJiYgZmlsZWluZm8pIHsKICAgICAgICBpZiAobWVtY21wICgmb3JpZ19vdXRwdXRfZm9ybWF0LCAmZmlsZWluZm8tPmZtdCwgc2l6ZW9mIChkZGJfd2F2ZWZvcm1hdF90KSkpIHsKICAgICAgICAgICAgbWVtY3B5ICgmb3JpZ19vdXRwdXRfZm9ybWF0LCAmZmlsZWluZm8tPmZtdCwgc2l6ZW9mIChkZGJfd2F2ZWZvcm1hdF90KSk7CiAgICAgICAgICAgIG1lbWNweSAoJm91dHB1dF9mb3JtYXQsICZmaWxlaW5mby0-Zm10LCBzaXplb2YgKGRkYl93YXZlZm9ybWF0X3QpKTsKICAgICAgICAgICAgZm9ybWF0Y2hhbmdlZCA9IDE7CiAgICAgICAgfQogICAgICAgIGRzcF9vbiA9IDA7CiAgICB9CiAgICBlbHNlIGlmIChjdHgpIHsKICAgICAgICBkc3Bfb24gPSAxOwogICAgICAgIC8vIHNldCBzb21lIHZlcnkgZ2VuZXJpYyBmb3JtYXQsIHRoaXMgd2lsbCBhbGxvdyBwbGF5YmFjayBvZiB3ZWlyZAogICAgICAgIC8vIGZvcm1hdHMgYWZ0ZXIgZml4aW5nIHRoZW0gd2l0aCBkc3AgcGx1Z2lucwogICAgICAgIHN0cmVhbWVyX3NldF9nZW5lcmljX291dHB1dF9mb3JtYXQgKCk7CiAgICB9CiAgICBlbHNlIGlmICghY3R4KSB7CiAgICAgICAgZHNwX29uID0gMDsKICAgIH0KfQoKdm9pZApzdHJlYW1lcl9kc3BfcmVmcmVzaCAodm9pZCkgewogICAgaGFuZGxlcl9wdXNoIChoYW5kbGVyLCBTVFJfRVZfRFNQX1JFTE9BRCwgMCwgMCwgMCk7Cn0KCnN0YXRpYyB2b2lkCnN0cmVhbWVyX2RzcF9pbml0ICh2b2lkKSB7CiAgICAvLyBsb2FkIGRzcCBjaGFpbiBmcm9tIGZpbGUKICAgIGNoYXIgZm5hbWVbUEFUSF9NQVhdOwogICAgc25wcmludGYgKGZuYW1lLCBzaXplb2YgKGZuYW1lKSwgIiVzL2RzcGNvbmZpZyIsIHBsdWdfZ2V0X2NvbmZpZ19kaXIgKCkpOwogICAgZHNwX2NoYWluID0gc3RyZWFtZXJfZHNwX2NoYWluX2xvYWQgKGZuYW1lKTsKICAgIGlmICghZHNwX2NoYWluKSB7CiAgICAgICAgLy8gZmlyc3QgcnVuLCBsZXQncyBhZGQgcmVzYW1wbGVyCiAgICAgICAgREJfZHNwX3QgKnNyYyA9IChEQl9kc3BfdCAqKXBsdWdfZ2V0X2Zvcl9pZCAoIlNSQyIpOwogICAgICAgIGlmIChzcmMpIHsKICAgICAgICAgICAgZGRiX2RzcF9jb250ZXh0X3QgKmluc3QgPSBzcmMtPm9wZW4gKCk7CiAgICAgICAgICAgIGluc3QtPmVuYWJsZWQgPSAxOwogICAgICAgICAgICBzcmMtPnNldF9wYXJhbSAoaW5zdCwgMCwgIjQ4MDAwIik7IC8vIHNhbXBsZXJhdGUKICAgICAgICAgICAgc3JjLT5zZXRfcGFyYW0gKGluc3QsIDEsICIyIik7IC8vIHF1YWxpdHk9U0lOQ19GQVNURVNUCiAgICAgICAgICAgIHNyYy0-c2V0X3BhcmFtIChpbnN0LCAyLCAiMSIpOyAvLyBhdXRvCiAgICAgICAgICAgIGluc3QtPm5leHQgPSBkc3BfY2hhaW47CiAgICAgICAgICAgIGRzcF9jaGFpbiA9IGluc3Q7CiAgICAgICAgfQogICAgfQoKICAgIGVxcGx1ZyA9IChEQl9kc3BfdCAqKXBsdWdfZ2V0X2Zvcl9pZCAoInN1cGVyZXEiKTsKICAgIHN0cmVhbWVyX2RzcF9wb3N0aW5pdCAoKTsKCiAgICAvLyBsb2FkIGxlZ2FjeSBlcSBzZXR0aW5ncyBmcm9tIHByZS0wLjUKICAgIGlmIChlcSAmJiBlcXBsdWcgJiYgY29uZl9maW5kICgiZXEuIiwgTlVMTCkpIHsKICAgICAgICBlcS0-ZW5hYmxlZCA9IGRlYWRiZWVmLT5jb25mX2dldF9pbnQgKCJlcS5lbmFibGUiLCAwKTsKICAgICAgICBjaGFyIHNbNTBdOwoKICAgICAgICAvLyAwLjQuNCB3YXMgd3JpdGluZyBidWdneSBzZXR0aW5ncywgbmVlZCB0byBtdWx0aXBseSBieSAyIHRvIGNvbXBlbnNhdGUKICAgICAgICBjb25mX2dldF9zdHIgKCJlcS5wcmVhbXAiLCAiMCIsIHMsIHNpemVvZiAocykpOwogICAgICAgIHNucHJpbnRmIChzLCBzaXplb2YgKHMpLCAiJWYiLCBhdG9mKHMpKjIpOwogICAgICAgIGVxcGx1Zy0-c2V0X3BhcmFtIChlcSwgMCwgcyk7CiAgICAgICAgZm9yIChpbnQgaSA9IDA7IGkgPCAxODsgaSsrKSB7CiAgICAgICAgICAgIGNoYXIga2V5WzEwMF07CiAgICAgICAgICAgIHNucHJpbnRmIChrZXksIHNpemVvZiAoa2V5KSwgImVxLmJhbmQlZCIsIGkpOwogICAgICAgICAgICBjb25mX2dldF9zdHIgKGtleSwgIjAiLCBzLCBzaXplb2YgKHMpKTsKICAgICAgICAgICAgc25wcmludGYgKHMsIHNpemVvZiAocyksICIlZiIsIGF0b2YocykqMik7CiAgICAgICAgICAgIGVxcGx1Zy0-c2V0X3BhcmFtIChlcSwgMStpLCBzKTsKICAgICAgICB9CiAgICAgICAgLy8gZGVsZXRlIG9ic29sZXRlIHNldHRpbmdzCiAgICAgICAgY29uZl9yZW1vdmVfaXRlbXMgKCJlcS4iKTsKICAgIH0KfQoKaW50CnN0cmVhbWVyX2luaXQgKHZvaWQpIHsKICAgIHN0cmVhbWluZ190ZXJtaW5hdGUgPSAwOwogICAgaGFuZGxlciA9IGhhbmRsZXJfYWxsb2MgKDEwMCk7CiNpZiBXUklURV9EVU1QCiAgICBvdXQgPSBmb3BlbiAoIm91dC5yYXciLCAidytiIik7CiNlbmRpZgogICAgbXV0ZXggPSBtdXRleF9jcmVhdGUgKCk7CiAgICBjdXJydHJhY2tfbXV0ZXggPSBtdXRleF9jcmVhdGUgKCk7CiAgICB3ZGxfbXV0ZXggPSBtdXRleF9jcmVhdGUgKCk7CgogICAgcmluZ2J1Zl9pbml0ICgmc3RyZWFtZXJfcmluZ2J1Ziwgc3RyZWFtYnVmZmVyLCBTVFJFQU1fQlVGRkVSX1NJWkUpOwoKICAgIHBsX3NldF9vcmRlciAoY29uZl9nZXRfaW50ICgicGxheWJhY2sub3JkZXIiLCAwKSk7CgogICAgc3RyZWFtZXJfZHNwX2luaXQgKCk7CgogICAgcmVwbGF5Z2Fpbl9zZXQgKGNvbmZfZ2V0X2ludCAoInJlcGxheWdhaW5fbW9kZSIsIDApLCBjb25mX2dldF9pbnQgKCJyZXBsYXlnYWluX3NjYWxlIiwgMSksIGNvbmZfZ2V0X2Zsb2F0ICgicmVwbGF5Z2Fpbl9wcmVhbXAiLCAwKSwgY29uZl9nZXRfZmxvYXQgKCJnbG9iYWxfcHJlYW1wIiwgMCkpOwoKICAgIGN0bWFwX2luaXRfbXV0ZXggKCk7CiAgICBkZWFkYmVlZi0-Y29uZl9nZXRfc3RyICgibmV0d29yay5jdG1hcHBpbmciLCBEREJfREVGQVVMVF9DVE1BUFBJTkcsIGNvbmZfbmV0d29ya19jdG1hcHBpbmcsIHNpemVvZiAoY29uZl9uZXR3b3JrX2N0bWFwcGluZykpOwogICAgY3RtYXBfaW5pdCAoKTsKCiAgICBzdHJlYW1lcl90aWQgPSB0aHJlYWRfc3RhcnQgKHN0cmVhbWVyX3RocmVhZCwgTlVMTCk7CiAgICByZXR1cm4gMDsKfQoKdm9pZApzdHJlYW1lcl9mcmVlICh2b2lkKSB7CiNpZiBXUklURV9EVU1QCiAgICBmY2xvc2UgKG91dCk7CiNlbmRpZgoKICAgIGlmIChwbGF5aW5nX3RyYWNrKSB7CiAgICAgICAgc2VuZF90cmFja2NoYW5nZWQgKHBsYXlpbmdfdHJhY2ssIE5VTEwpOwogICAgfQogICAgc3RyZWFtZXJfYWJvcnRfZmlsZXMgKCk7CiAgICBzdHJlYW1pbmdfdGVybWluYXRlID0gMTsKICAgIHRocmVhZF9qb2luIChzdHJlYW1lcl90aWQpOwoKICAgIGlmIChzdHJlYW1pbmdfdHJhY2spIHsKICAgICAgICBwbF9pdGVtX3VucmVmIChzdHJlYW1pbmdfdHJhY2spOwogICAgICAgIHN0cmVhbWluZ190cmFjayA9IE5VTEw7CiAgICB9CiAgICBpZiAocGxheWluZ190cmFjaykgewogICAgICAgIHBsX2l0ZW1fdW5yZWYgKHBsYXlpbmdfdHJhY2spOwogICAgICAgIHBsYXlpbmdfdHJhY2sgPSBOVUxMOwogICAgfQogICAgaWYgKHBsYXlsaXN0X3RyYWNrKSB7CiAgICAgICAgcGxheWxpc3RfdHJhY2sgPSBOVUxMOwogICAgfQogICAgaWYgKHN0cmVhbWVyX3BsYXlsaXN0KSB7CiAgICAgICAgcGx0X3VucmVmIChzdHJlYW1lcl9wbGF5bGlzdCk7CiAgICAgICAgc3RyZWFtZXJfcGxheWxpc3QgPSBOVUxMOwogICAgfQoKICAgIGN0bWFwX2ZyZWUgKCk7CiAgICBjdG1hcF9mcmVlX211dGV4ICgpOwoKICAgIG11dGV4X2ZyZWUgKGN1cnJ0cmFja19tdXRleCk7CiAgICBjdXJydHJhY2tfbXV0ZXggPSAwOwogICAgbXV0ZXhfZnJlZSAobXV0ZXgpOwogICAgbXV0ZXggPSAwOwogICAgbXV0ZXhfZnJlZSAod2RsX211dGV4KTsKICAgIHdkbF9tdXRleCA9IDA7CgogICAgc3RyZWFtZXJfZHNwX2NoYWluX3NhdmUoKTsKCiAgICBzdHJlYW1lcl9kc3BfY2hhaW5fZnJlZSAoZHNwX2NoYWluKTsKICAgIGRzcF9jaGFpbiA9IE5VTEw7CgogICAgZnJlZV9kc3BfYnVmZmVycyAoKTsKCiAgICBlcXBsdWcgPSBOVUxMOwogICAgZXEgPSBOVUxMOwoKICAgIGlmIChoYW5kbGVyKSB7CiAgICAgICAgaGFuZGxlcl9mcmVlIChoYW5kbGVyKTsKICAgICAgICBoYW5kbGVyID0gTlVMTDsKICAgIH0KfQoKdm9pZApzdHJlYW1lcl9yZXNldCAoaW50IGZ1bGwpIHsgLy8gbXVzdCBiZSBjYWxsZWQgd2hlbiBjdXJyZW50IHNvbmcgY2hhbmdlcyBieSBleHRlcm5hbCByZWFzb25zCiAgICBpZiAoIW11dGV4KSB7CiAgICAgICAgZnByaW50ZiAoc3RkZXJyLCAiRVJST1I6IHNvbWVvbmUgY2FsbGVkIHN0cmVhbWVyX3Jlc2V0IGFmdGVyIGV4aXRcbiIpOwogICAgICAgIHJldHVybjsgLy8gZmFpbHNhZmUsIGluIGNhc2Ugc29tZW9uZSBjYWxscyBzdHJlYW1lciByZXNldCBhZnRlciBkZWluaXQKICAgIH0KICAgIGlmIChmdWxsKSB7CiAgICAgICAgc3RyZWFtZXJfbG9jayAoKTsKICAgICAgICBzdHJlYW1lcl9yaW5nYnVmLnJlbWFpbmluZyA9IDA7CiAgICAgICAgc3RyZWFtZXJfdW5sb2NrICgpOwogICAgfQoKICAgIC8vIHJlc2V0IGRzcAogICAgZGRiX2RzcF9jb250ZXh0X3QgKmRzcCA9IGRzcF9jaGFpbjsKICAgIHdoaWxlIChkc3ApIHsKICAgICAgICBpZiAoZHNwLT5wbHVnaW4tPnJlc2V0KSB7CiAgICAgICAgICAgIGRzcC0-cGx1Z2luLT5yZXNldCAoZHNwKTsKICAgICAgICB9CiAgICAgICAgZHNwID0gZHNwLT5uZXh0OwogICAgfQp9CgpzdGF0aWMgaW50CnN0cmVhbWVyX3NldF9vdXRwdXRfZm9ybWF0ICh2b2lkKSB7CiAgICBEQl9vdXRwdXRfdCAqb3V0cHV0ID0gcGx1Z19nZXRfb3V0cHV0ICgpOwogICAgaW50IHBsYXlpbmcgPSAob3V0cHV0LT5zdGF0ZSAoKSA9PSBPVVRQVVRfU1RBVEVfUExBWUlORyk7CgogICAgdHJhY2UgKCJzdHJlYW1lcl9zZXRfb3V0cHV0X2Zvcm1hdCAlZGJpdCAlcyAlZGNoICVkSHogY2hhbm5lbG1hc2s9JVgsIGJ1ZmZlcmZpbGw6ICVkXG4iLCBvdXRwdXRfZm9ybWF0LmJwcywgb3V0cHV0X2Zvcm1hdC5pc19mbG9hdCA_ICJmbG9hdCIgOiAiaW50Iiwgb3V0cHV0X2Zvcm1hdC5jaGFubmVscywgb3V0cHV0X2Zvcm1hdC5zYW1wbGVyYXRlLCBvdXRwdXRfZm9ybWF0LmNoYW5uZWxtYXNrLCBzdHJlYW1lcl9yaW5nYnVmLnJlbWFpbmluZyk7CiAgICBkZGJfd2F2ZWZvcm1hdF90IGZtdDsKICAgIG1lbWNweSAoJmZtdCwgJm91dHB1dF9mb3JtYXQsIHNpemVvZiAoZGRiX3dhdmVmb3JtYXRfdCkpOwogICAgaWYgKGF1dG9jb252XzhfdG9fMTYpIHsKICAgICAgICBpZiAoZm10LmJwcyA9PSA4KSB7CiAgICAgICAgICAgIGZtdC5icHMgPSAxNjsKICAgICAgICB9CiAgICB9CiAgICBpZiAoYXV0b2NvbnZfMTZfdG9fMjQpIHsKICAgICAgICBpZiAoZm10LmJwcyA9PSAxNikgewogICAgICAgICAgICBmbXQuYnBzID0gMjQ7CiAgICAgICAgfQogICAgfQogICAgb3V0cHV0LT5zZXRmb3JtYXQgKCZmbXQpOwogICAgc3RyZWFtZXJfYnVmZmVyaW5nID0gMTsKICAgIGlmIChwbGF5aW5nICYmIG91dHB1dC0-c3RhdGUgKCkgIT0gT1VUUFVUX1NUQVRFX1BMQVlJTkcpIHsKICAgICAgICBpZiAoMCAhPSBvdXRwdXQtPnBsYXkgKCkpIHsKICAgICAgICAgICAgbWVtc2V0ICgmb3V0cHV0X2Zvcm1hdCwgMCwgc2l6ZW9mIChvdXRwdXRfZm9ybWF0KSk7CiAgICAgICAgICAgIGZwcmludGYgKHN0ZGVyciwgInN0cmVhbWVyOiBmYWlsZWQgdG8gc3RhcnQgcGxheWJhY2sgKHN0cmVhbWVyX3JlYWQgZm9ybWF0IGNoYW5nZSlcbiIpOwogICAgICAgICAgICBzdHJlYW1lcl9zZXRfbmV4dHNvbmdfcmVhbCAoLTIsIDApOwogICAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIDA7Cn0KCnN0YXRpYyBjaGFyICoKZW5zdXJlX2RzcF9pbnB1dF9idWZmZXIgKGludCBzaXplKSB7CiAgICBpZiAoIXNpemUpIHsKICAgICAgICBpZiAoZHNwX2lucHV0X2J1ZmZlcikgewogICAgICAgICAgICBmcmVlIChkc3BfaW5wdXRfYnVmZmVyKTsKICAgICAgICAgICAgZHNwX2lucHV0X2J1ZmZlciA9IE5VTEw7CiAgICAgICAgfQogICAgICAgIHJldHVybiAwOwogICAgfQogICAgaWYgKHNpemUgIT0gZHNwX2lucHV0X2J1ZmZlcl9zaXplKSB7CiAgICAgICAgZHNwX2lucHV0X2J1ZmZlciA9IHJlYWxsb2MgKGRzcF9pbnB1dF9idWZmZXIsIHNpemUpOwogICAgICAgIGRzcF9pbnB1dF9idWZmZXJfc2l6ZSA9IHNpemU7CiAgICB9CiAgICByZXR1cm4gZHNwX2lucHV0X2J1ZmZlcjsKfQoKCnN0YXRpYyBjaGFyICoKZW5zdXJlX2RzcF90ZW1wX2J1ZmZlciAoaW50IHNpemUpIHsKICAgIGlmICghc2l6ZSkgewogICAgICAgIGlmIChkc3BfdGVtcF9idWZmZXIpIHsKICAgICAgICAgICAgZnJlZSAoZHNwX3RlbXBfYnVmZmVyKTsKICAgICAgICAgICAgZHNwX3RlbXBfYnVmZmVyID0gTlVMTDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIE5VTEw7CiAgICB9CiAgICBpZiAoc2l6ZSAhPSBkc3BfdGVtcF9idWZmZXJfc2l6ZSkgewogICAgICAgIGRzcF90ZW1wX2J1ZmZlciA9IHJlYWxsb2MgKGRzcF90ZW1wX2J1ZmZlciwgc2l6ZSk7CiAgICAgICAgZHNwX3RlbXBfYnVmZmVyX3NpemUgPSBzaXplOwogICAgfQogICAgcmV0dXJuIGRzcF90ZW1wX2J1ZmZlcjsKfQoKc3RhdGljIHZvaWQKZnJlZV9kc3BfYnVmZmVycyAodm9pZCkgewogICAgZW5zdXJlX2RzcF9pbnB1dF9idWZmZXIgKDApOwogICAgZW5zdXJlX2RzcF90ZW1wX2J1ZmZlciAoMCk7Cn0KCi8vIGRlY29kZXMgZGF0YSBhbmQgY29udmVydHMgdG8gY3VycmVudCBvdXRwdXQgZm9ybWF0Ci8vIHJldHVybnMgbnVtYmVyIG9mIGJ5dGVzIGJlZW4gcmVhZApzdGF0aWMgaW50CnN0cmVhbWVyX3JlYWRfYXN5bmMgKGNoYXIgKmJ5dGVzLCBpbnQgc2l6ZSkgewogICAgREJfb3V0cHV0X3QgKm91dHB1dCA9IHBsdWdfZ2V0X291dHB1dCAoKTsKICAgIGludCBpbml0c2l6ZSA9IHNpemU7CiAgICBpbnQgYnl0ZXNyZWFkID0gMDsKICAgIGlmICghZmlsZWluZm8pIHsKICAgICAgICAvLyBtZWFucyB0aGVyZSdzIG5vdGhpbmcgbGVmdCB0byBzdHJlYW0sIHNvIGp1c3QgZG8gbm90aGluZwogICAgICAgIHJldHVybiAwOwogICAgfQogICAgaW50IGlzX2VvZiA9IDA7CgogICAgaWYgKGZpbGVpbmZvLT5mbXQuc2FtcGxlcmF0ZSAhPSAtMSkgewogICAgICAgIGludCBvdXRwdXRzYW1wbGVzaXplID0gb3V0cHV0LT5mbXQuY2hhbm5lbHMgKiBvdXRwdXQtPmZtdC5icHMgLyA4OwogICAgICAgIGludCBpbnB1dHNhbXBsZXNpemUgPSBmaWxlaW5mby0-Zm10LmNoYW5uZWxzICogZmlsZWluZm8tPmZtdC5icHMgLyA4OwoKICAgICAgICBkZGJfd2F2ZWZvcm1hdF90IGRzcGZtdDsKICAgICAgICBtZW1jcHkgKCZkc3BmbXQsICZmaWxlaW5mby0-Zm10LCBzaXplb2YgKGRkYl93YXZlZm9ybWF0X3QpKTsKICAgICAgICBkc3BmbXQuYnBzID0gMzI7CiAgICAgICAgZHNwZm10LmlzX2Zsb2F0ID0gMTsKICAgICAgICBpbnQgY2FuX2J5cGFzcyA9IDA7CiAgICAgICAgaWYgKGRzcF9vbikgewogICAgICAgICAgICAvLyBjaGVjayBpZiBEU1AgY2FuIGJlIHBhc3NlZCB0aHJvdWdoCiAgICAgICAgICAgIGRkYl9kc3BfY29udGV4dF90ICpkc3AgPSBkc3BfY2hhaW47CiAgICAgICAgICAgIHdoaWxlIChkc3ApIHsKICAgICAgICAgICAgICAgIGlmIChkc3AtPmVuYWJsZWQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZHNwLT5wbHVnaW4tPnBsdWdpbi5hcGlfdm1pbm9yID49IDEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGRzcC0-cGx1Z2luLT5jYW5fYnlwYXNzICYmICFkc3AtPnBsdWdpbi0-Y2FuX2J5cGFzcyAoZHNwLCAmZHNwZm10KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRzcCA9IGRzcC0-bmV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAoIWRzcCkgewogICAgICAgICAgICAgICAgY2FuX2J5cGFzcyA9IDE7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmICghbWVtY21wICgmZmlsZWluZm8tPmZtdCwgJm91dHB1dC0-Zm10LCBzaXplb2YgKGRkYl93YXZlZm9ybWF0X3QpKSAmJiAoIWRzcF9vbiB8fCBjYW5fYnlwYXNzKSkgewogICAgICAgICAgICAvLyBwYXNzIHRocm91Z2ggZnJvbSBpbnB1dCB0byBvdXRwdXQKICAgICAgICAgICAgYnl0ZXNyZWFkID0gZmlsZWluZm8tPnBsdWdpbi0-cmVhZCAoZmlsZWluZm8sIGJ5dGVzLCBzaXplKTsKCiAgICAgICAgICAgIGlmIChieXRlc3JlYWQgIT0gc2l6ZSkgewogICAgICAgICAgICAgICAgaXNfZW9mID0gMTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChkc3Bfb24pIHsKICAgICAgICAgICAgLy8gY29udmVydCB0byBmbG9hdCwgcGFzcyB0aHJvdWdoIHN0cmVhbWVyIERTUCBjaGFpbgogICAgICAgICAgICBpbnQgZHNwc2FtcGxlc2l6ZSA9IGZpbGVpbmZvLT5mbXQuY2hhbm5lbHMgKiBzaXplb2YgKGZsb2F0KTsKICAgICAgICAgICAgaW50IGRzcF9udW1fZnJhbWVzID0gc2l6ZSAvIChvdXRwdXQtPmZtdC5jaGFubmVscyAqIG91dHB1dC0-Zm10LmJwcyAvIDgpOwoKICAgICAgICAgICAgaW50IGlucHV0c2l6ZSA9IGRzcF9udW1fZnJhbWVzICogaW5wdXRzYW1wbGVzaXplOwogICAgICAgICAgICBjaGFyICppbnB1dCA9IGVuc3VyZV9kc3BfaW5wdXRfYnVmZmVyIChpbnB1dHNpemUpOwoKICAgICAgICAgICAgLy8gZGVjb2RlIHBjbQogICAgICAgICAgICBpbnQgbmIgPSBmaWxlaW5mby0-cGx1Z2luLT5yZWFkIChmaWxlaW5mbywgaW5wdXQsIGlucHV0c2l6ZSk7CiAgICAgICAgICAgIGlmIChuYiAhPSBpbnB1dHNpemUpIHsKICAgICAgICAgICAgICAgIGlzX2VvZiA9IDE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaW5wdXRzaXplID0gbmI7CgogICAgICAgICAgICBpZiAoaW5wdXRzaXplID4gMCkgewogICAgICAgICAgICAgICAgLy8gbWFrZSAqTUFYX0RTUF9SQVRJTyBzaXplZCBidWZmZXIgZm9yIGZsb2F0IGRhdGEKICAgICAgICAgICAgICAgIGludCB0ZW1wYnVmX3NpemUgPSBpbnB1dHNpemUvaW5wdXRzYW1wbGVzaXplICogZHNwc2FtcGxlc2l6ZSAqIE1BWF9EU1BfUkFUSU87CiAgICAgICAgICAgICAgICBjaGFyICp0ZW1wYnVmID0gZW5zdXJlX2RzcF90ZW1wX2J1ZmZlciAodGVtcGJ1Zl9zaXplKTsKCiAgICAgICAgICAgICAgICAvLyBjb252ZXJ0IHRvIGZsb2F0CiAgICAgICAgICAgICAgICBpbnQgdGVtcHNpemUgPSBwY21fY29udmVydCAoJmZpbGVpbmZvLT5mbXQsIGlucHV0LCAmZHNwZm10LCB0ZW1wYnVmLCBpbnB1dHNpemUpOwogICAgICAgICAgICAgICAgaW50IG5mcmFtZXMgPSBpbnB1dHNpemUgLyBpbnB1dHNhbXBsZXNpemU7CiAgICAgICAgICAgICAgICBkZGJfZHNwX2NvbnRleHRfdCAqZHNwID0gZHNwX2NoYWluOwogICAgICAgICAgICAgICAgZmxvYXQgcmF0aW8gPSAxLmY7CiAgICAgICAgICAgICAgICBpbnQgbWF4ZnJhbWVzID0gdGVtcGJ1Zl9zaXplIC8gZHNwc2FtcGxlc2l6ZTsKICAgICAgICAgICAgICAgIHdoaWxlIChkc3ApIHsKICAgICAgICAgICAgICAgICAgICBpZiAoZHNwLT5lbmFibGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZsb2F0IHIgPSAxOwogICAgICAgICAgICAgICAgICAgICAgICBuZnJhbWVzID0gZHNwLT5wbHVnaW4tPnByb2Nlc3MgKGRzcCwgKGZsb2F0ICopdGVtcGJ1ZiwgbmZyYW1lcywgbWF4ZnJhbWVzLCAmZHNwZm10LCAmcik7CiAgICAgICAgICAgICAgICAgICAgICAgIHJhdGlvICo9IHI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGRzcCA9IGRzcC0-bmV4dDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGRzcF9yYXRpbyA9IHJhdGlvOwoKICAgICAgICAgICAgICAgIGRkYl93YXZlZm9ybWF0X3Qgb3V0Zm10OwogICAgICAgICAgICAgICAgLy8gcHJlc2VydmUgc2FtcGxlZm9ybWF0LCBidXQgdGFrZSBjaGFubmVscywgc2FtcGxlcmF0ZQogICAgICAgICAgICAgICAgb3V0Zm10LmJwcyA9IGZpbGVpbmZvLT5mbXQuYnBzOwogICAgICAgICAgICAgICAgb3V0Zm10LmlzX2Zsb2F0ID0gZmlsZWluZm8tPmZtdC5pc19mbG9hdDsKICAgICAgICAgICAgICAgIC8vIGNoYW5uZWxtYXNrIGZyb20gZHNwIGNoYWluCiAgICAgICAgICAgICAgICBvdXRmbXQuY2hhbm5lbHMgPSBkc3BmbXQuY2hhbm5lbHM7CiAgICAgICAgICAgICAgICBvdXRmbXQuc2FtcGxlcmF0ZSA9IGRzcGZtdC5zYW1wbGVyYXRlOwogICAgICAgICAgICAgICAgb3V0Zm10LmNoYW5uZWxtYXNrID0gZHNwZm10LmNoYW5uZWxtYXNrOwogICAgICAgICAgICAgICAgb3V0Zm10LmlzX2JpZ2VuZGlhbiA9IGZpbGVpbmZvLT5mbXQuaXNfYmlnZW5kaWFuOwogICAgICAgICAgICAgICAgaWYgKGJ5dGVzX3VudGlsX25leHRfc29uZyA8PSAwICYmIG1lbWNtcCAoJm91dHB1dF9mb3JtYXQsICZvdXRmbXQsIHNpemVvZiAoZGRiX3dhdmVmb3JtYXRfdCkpKSB7CiAgICAgICAgICAgICAgICAgICAgbWVtY3B5ICgmb3V0cHV0X2Zvcm1hdCwgJm91dGZtdCwgc2l6ZW9mIChkZGJfd2F2ZWZvcm1hdF90KSk7CiAgICAgICAgICAgICAgICAgICAgc3RyZWFtZXJfc2V0X291dHB1dF9mb3JtYXQgKCk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy9wcmludGYgKCJjb252ZXJ0IGZyb20gJWRiaXQgJXMgJWRjaCAlZEh6IGNoYW5uZWxtYXNrPSVYIHRvICVkYml0ICVzICVkY2ggJWRIeiBjaGFubmVsbWFzaz0lWFxuIiwgZHNwZm10LmJwcywgZHNwZm10LmlzX2Zsb2F0ID8gImZsb2F0IiA6ICJpbnQiLCBkc3BmbXQuY2hhbm5lbHMsIGRzcGZtdC5zYW1wbGVyYXRlLCBkc3BmbXQuY2hhbm5lbG1hc2ssIG91dHB1dC0-Zm10LmJwcywgb3V0cHV0LT5mbXQuaXNfZmxvYXQgPyAiZmxvYXQiIDogImludCIsIG91dHB1dC0-Zm10LmNoYW5uZWxzLCBvdXRwdXQtPmZtdC5zYW1wbGVyYXRlLCBvdXRwdXQtPmZtdC5jaGFubmVsbWFzayk7CgogICAgICAgICAgICAgICAgaW50IG4gPSBwY21fY29udmVydCAoJmRzcGZtdCwgdGVtcGJ1ZiwgJm91dHB1dC0-Zm10LCBieXRlcywgbmZyYW1lcyAqIGRzcGZtdC5jaGFubmVscyAqIHNpemVvZiAoZmxvYXQpKTsKCiAgICAgICAgICAgICAgICBieXRlc3JlYWQgPSBuOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UgewojaWZkZWYgQU5EUk9JRAogICAgICAgICAgICAvLyBpZiB3ZSBub3QgY29tcGVuc2F0ZSBoZXJlLCB0aGUgc3RyZWFtZXIgbG9vcCB3aWxsIGdvIGNyYXp5CiAgICAgICAgICAgIGlmIChmaWxlaW5mby0-Zm10LnNhbXBsZXJhdGUgIT0gb3V0cHV0LT5mbXQuc2FtcGxlcmF0ZSkgewogICAgICAgICAgICAgICAgaWYgKChmaWxlaW5mby0-Zm10LnNhbXBsZXJhdGUgLyBvdXRwdXQtPmZtdC5zYW1wbGVyYXRlKSA9PSAyICYmIChmaWxlaW5mby0-Zm10LnNhbXBsZXJhdGUgJSBvdXRwdXQtPmZtdC5zYW1wbGVyYXRlKSA9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgc2l6ZSA8PD0gMTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgaWYgKChmaWxlaW5mby0-Zm10LnNhbXBsZXJhdGUgLyBvdXRwdXQtPmZtdC5zYW1wbGVyYXRlKSA9PSA0ICYmIChmaWxlaW5mby0-Zm10LnNhbXBsZXJhdGUgJSBvdXRwdXQtPmZtdC5zYW1wbGVyYXRlKSA9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgc2l6ZSA8PD0gMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQojZW5kaWYKICAgICAgICAgICAgLy8gY29udmVydCBmcm9tIGlucHV0IGZtdCB0byBvdXRwdXQgZm10CiAgICAgICAgICAgIGludCBpbnB1dHNpemUgPSBzaXplL291dHB1dHNhbXBsZXNpemUqaW5wdXRzYW1wbGVzaXplOwogICAgICAgICAgICBjaGFyIGlucHV0W2lucHV0c2l6ZV07CiAgICAgICAgICAgIGludCBuYiA9IGZpbGVpbmZvLT5wbHVnaW4tPnJlYWQgKGZpbGVpbmZvLCBpbnB1dCwgaW5wdXRzaXplKTsKICAgICAgICAgICAgaWYgKG5iICE9IGlucHV0c2l6ZSkgewogICAgICAgICAgICAgICAgYnl0ZXNyZWFkID0gbmI7CiAgICAgICAgICAgICAgICBpc19lb2YgPSAxOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlucHV0c2l6ZSA9IG5iOwovLyAgICAgICAgICAgIHRyYWNlICgiY29udmVydCAlZHwlZHwlZHwlZHwlZHwlZCB0byAlZHwlZHwlZHwlZHwlZHwlZFxuIgovLyAgICAgICAgICAgICAgICAsIGZpbGVpbmZvLT5mbXQuYnBzLCBmaWxlaW5mby0-Zm10LmNoYW5uZWxzLCBmaWxlaW5mby0-Zm10LnNhbXBsZXJhdGUsIGZpbGVpbmZvLT5mbXQuY2hhbm5lbG1hc2ssIGZpbGVpbmZvLT5mbXQuaXNfZmxvYXQsIGZpbGVpbmZvLT5mbXQuaXNfYmlnZW5kaWFuCi8vICAgICAgICAgICAgICAgICwgb3V0cHV0LT5mbXQuYnBzLCBvdXRwdXQtPmZtdC5jaGFubmVscywgb3V0cHV0LT5mbXQuc2FtcGxlcmF0ZSwgb3V0cHV0LT5mbXQuY2hhbm5lbG1hc2ssIG91dHB1dC0-Zm10LmlzX2Zsb2F0LCBvdXRwdXQtPmZtdC5pc19iaWdlbmRpYW4pOwogICAgICAgICAgICBieXRlc3JlYWQgPSBwY21fY29udmVydCAoJmZpbGVpbmZvLT5mbXQsIGlucHV0LCAmb3V0cHV0LT5mbXQsIGJ5dGVzLCBpbnB1dHNpemUpOwoKI2lmZGVmIEFORFJPSUQKICAgICAgICAgICAgLy8gZG93bnNhbXBsZQogICAgICAgICAgICBpZiAoZmlsZWluZm8tPmZtdC5zYW1wbGVyYXRlID4gb3V0cHV0LT5mbXQuc2FtcGxlcmF0ZSkgewogICAgICAgICAgICAgICAgaWYgKChmaWxlaW5mby0-Zm10LnNhbXBsZXJhdGUgLyBvdXRwdXQtPmZtdC5zYW1wbGVyYXRlKSA9PSAyICYmIChmaWxlaW5mby0-Zm10LnNhbXBsZXJhdGUgJSBvdXRwdXQtPmZtdC5zYW1wbGVyYXRlKSA9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgLy8gY2xpcCB0byBtdWx0aXBsZSBvZiAyIHNhbXBsZXMKICAgICAgICAgICAgICAgICAgICBpbnQgb3V0c2FtcGxlc2l6ZSA9IG91dHB1dC0-Zm10LmNoYW5uZWxzICogKG91dHB1dC0-Zm10LmJwcz4-MykgKiAyOwogICAgICAgICAgICAgICAgICAgIGlmICgoYnl0ZXNyZWFkICUgb3V0c2FtcGxlc2l6ZSkgIT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBieXRlc3JlYWQgLT0gKGJ5dGVzcmVhZCAlIG91dHNhbXBsZXNpemUpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgLy8gMnggZG93bnNhbXBsZQogICAgICAgICAgICAgICAgICAgIGludCBuZnJhbWVzID0gYnl0ZXNyZWFkIC8gKG91dHB1dC0-Zm10LmJwcyA-PiAzKSAvIG91dHB1dC0-Zm10LmNoYW5uZWxzOwogICAgICAgICAgICAgICAgICAgIGludDE2X3QgKmluID0gKGludDE2X3QgKilieXRlczsKICAgICAgICAgICAgICAgICAgICBpbnQxNl90ICpvdXQgPSBpbjsKICAgICAgICAgICAgICAgICAgICBmb3IgKGludCBmID0gMDsgZiA8IG5mcmFtZXMvMjsgZisrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaW50IGMgPSAwOyBjIDwgb3V0cHV0LT5mbXQuY2hhbm5lbHM7IGMrKykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgb3V0W2Yqb3V0cHV0LT5mbXQuY2hhbm5lbHMrY10gPSAoaW5bZioyKm91dHB1dC0-Zm10LmNoYW5uZWxzK2NdICsgaW5bKGYqMisxKSpvdXRwdXQtPmZtdC5jaGFubmVscytjXSkgPj4gMTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBieXRlc3JlYWQgPj49IDE7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIGlmICgoZmlsZWluZm8tPmZtdC5zYW1wbGVyYXRlIC8gb3V0cHV0LT5mbXQuc2FtcGxlcmF0ZSkgPT0gNCAmJiAoZmlsZWluZm8tPmZtdC5zYW1wbGVyYXRlICUgb3V0cHV0LT5mbXQuc2FtcGxlcmF0ZSkgPT0gMCkgewogICAgICAgICAgICAgICAgICAgIC8vIGNsaXAgdG8gbXVsdGlwbGUgb2YgNCBzYW1wbGVzCiAgICAgICAgICAgICAgICAgICAgaW50IG91dHNhbXBsZXNpemUgPSBvdXRwdXQtPmZtdC5jaGFubmVscyAqIChvdXRwdXQtPmZtdC5icHM-PjMpICogNDsKICAgICAgICAgICAgICAgICAgICBpZiAoKGJ5dGVzcmVhZCAlIG91dHNhbXBsZXNpemUpICE9IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgYnl0ZXNyZWFkIC09IChieXRlc3JlYWQgJSBvdXRzYW1wbGVzaXplKTsKICAgICAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgICAgICAgICAgICAvLyA0eCBkb3duc2FtcGxlCiAgICAgICAgICAgICAgICAgICAgaW50IG5mcmFtZXMgPSBieXRlc3JlYWQgLyAob3V0cHV0LT5mbXQuYnBzID4-IDMpIC8gb3V0cHV0LT5mbXQuY2hhbm5lbHM7CiAgICAgICAgICAgICAgICAgICAgYXNzZXJ0IChieXRlc3JlYWQgJSAoKG91dHB1dC0-Zm10LmJwcyA-PiAzKSAqIG91dHB1dC0-Zm10LmNoYW5uZWxzKSA9PSAwKTsKICAgICAgICAgICAgICAgICAgICBpbnQxNl90ICppbiA9IChpbnQxNl90ICopYnl0ZXM7CiAgICAgICAgICAgICAgICAgICAgZm9yIChpbnQgZiA9IDA7IGYgPCBuZnJhbWVzLzQ7IGYrKykgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGludCBjID0gMDsgYyA8IG91dHB1dC0-Zm10LmNoYW5uZWxzOyBjKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluW2Yqb3V0cHV0LT5mbXQuY2hhbm5lbHMrY10gPSAoaW5bZio0Km91dHB1dC0-Zm10LmNoYW5uZWxzK2NdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICsgaW5bKGYqNCsxKSpvdXRwdXQtPmZtdC5jaGFubmVscytjXQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICArIGluWyhmKjQrMikqb3V0cHV0LT5mbXQuY2hhbm5lbHMrY10KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKyBpblsoZio0KzMpKm91dHB1dC0-Zm10LmNoYW5uZWxzK2NdKSA-PiAyOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGJ5dGVzcmVhZCA-Pj0gMjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBhc3NlcnQgKChieXRlc3JlYWQlMikgPT0gMCk7CiNlbmRpZgoKICAgICAgICB9CiNpZiBXUklURV9EVU1QCiAgICAgICAgaWYgKGJ5dGVzcmVhZCkgewogICAgICAgICAgICBmd3JpdGUgKGJ5dGVzLCAxLCBieXRlc3JlYWQsIG91dCk7CiAgICAgICAgfQojZW5kaWYKCiAgICAgICAgcmVwbGF5Z2Fpbl9hcHBseSAoJm91dHB1dC0-Zm10LCBzdHJlYW1pbmdfdHJhY2ssIGJ5dGVzLCBieXRlc3JlYWQpOwogICAgfQogICAgaWYgKCFpc19lb2YpIHsKICAgICAgICByZXR1cm4gYnl0ZXNyZWFkOwogICAgfQogICAgZWxzZSAgewogICAgICAgIC8vIHRoYXQgbWVhbnMgRU9GCiAgICAgICAgLy8gdHJhY2UgKCJzdHJlYW1lcjogRU9GISBidW5zOiAlZCwgYnl0ZXNyZWFkOiAlZCwgYnVmZmVyaW5nOiAlZCwgYnVmZmVyZmlsbDogJWRcbiIsIGJ5dGVzX3VudGlsX25leHRfc29uZywgYnl0ZXNyZWFkLCBzdHJlYW1lcl9idWZmZXJpbmcsIHN0cmVhbWVyX3JpbmdidWYucmVtYWluaW5nKTsKCiAgICAgICAgLy8gRU9GIG9yIGVycm9yIHdoaWxlIGJ1ZmZlcmluZyAtLSBzdG9wIGJ1ZmZlcmluZwogICAgICAgIGlmIChieXRlc3JlYWQgPD0gMCAmJiBieXRlc191bnRpbF9uZXh0X3NvbmcgPj0gMCAmJiBzdHJlYW1lcl9idWZmZXJpbmcpIHsKICAgICAgICAgICAgc3RyZWFtZXJfYnVmZmVyaW5nID0gMDsKICAgICAgICAgICAgcmV0dXJuIGJ5dGVzcmVhZDsKICAgICAgICB9CgogICAgICAgIC8vIGlmIHRyYWNrIGZpbmlzaGVkIHBsYXlpbmcgLS0gZ28gdG8gbmV4dAogICAgICAgIGlmIChieXRlc191bnRpbF9uZXh0X3NvbmcgPCAwKSB7CiAgICAgICAgICAgIHN0cmVhbWVyX25leHQgKGJ5dGVzcmVhZCk7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIGJ5dGVzcmVhZDsKfQoKaW50CnN0cmVhbWVyX3JlYWQgKGNoYXIgKmJ5dGVzLCBpbnQgc2l6ZSkgewojaWYgMAogICAgc3RydWN0IHRpbWV2YWwgdG0xOwogICAgZ2V0dGltZW9mZGF5ICgmdG0xLCBOVUxMKTsKI2VuZGlmCiAgICBpZiAoIXBsYXlpbmdfdHJhY2spIHsKICAgICAgICByZXR1cm4gLTE7CiAgICB9CiAgICBEQl9vdXRwdXRfdCAqb3V0cHV0ID0gcGx1Z19nZXRfb3V0cHV0ICgpOwogICAgc3RyZWFtZXJfbG9jayAoKTsKICAgIGludCBzeiA9IG1pbiAoc2l6ZSwgc3RyZWFtZXJfcmluZ2J1Zi5yZW1haW5pbmcpOwogICAgaWYgKHN6KSB7CiAgICAgICAgcmluZ2J1Zl9yZWFkICgmc3RyZWFtZXJfcmluZ2J1ZiwgYnl0ZXMsIHN6KTsKICAgICAgICBwbGF5cG9zICs9IChmbG9hdClzei9vdXRwdXQtPmZtdC5zYW1wbGVyYXRlLygob3V0cHV0LT5mbXQuYnBzPj4zKSpvdXRwdXQtPmZtdC5jaGFubmVscykgKiBkc3BfcmF0aW87CiAgICAgICAgcGxheXRpbWUgKz0gKGZsb2F0KXN6L291dHB1dC0-Zm10LnNhbXBsZXJhdGUvKChvdXRwdXQtPmZtdC5icHM-PjMpKm91dHB1dC0-Zm10LmNoYW5uZWxzKTsKICAgICAgICBpZiAoYnl0ZXNfdW50aWxfbmV4dF9zb25nID4gMCkgewogICAgICAgICAgICBieXRlc191bnRpbF9uZXh0X3NvbmcgLT0gc3o7CiAgICAgICAgICAgIGlmIChieXRlc191bnRpbF9uZXh0X3NvbmcgPCAwKSB7CiAgICAgICAgICAgICAgICBieXRlc191bnRpbF9uZXh0X3NvbmcgPSAwOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgc3RyZWFtZXJfdW5sb2NrICgpOwoKICAgIC8vIGFwcHJveGltYXRlIGJpdHJhdGUKICAgIGlmIChsYXN0X2JpdHJhdGUgIT0gLTEpIHsKICAgICAgICBpZiAoYXZnX2JpdHJhdGUgPT0gLTEpIHsKICAgICAgICAgICAgYXZnX2JpdHJhdGUgPSBsYXN0X2JpdHJhdGU7CiAgICAgICAgfQogICAgICAgIGVsc2UgewogICAgICAgICAgICBpZiAoYXZnX2JpdHJhdGUgPCBsYXN0X2JpdHJhdGUpIHsKICAgICAgICAgICAgICAgIGF2Z19iaXRyYXRlICs9IDU7CiAgICAgICAgICAgICAgICBpZiAoYXZnX2JpdHJhdGUgPiBsYXN0X2JpdHJhdGUpIHsKICAgICAgICAgICAgICAgICAgICBhdmdfYml0cmF0ZSA9IGxhc3RfYml0cmF0ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChhdmdfYml0cmF0ZSA-IGxhc3RfYml0cmF0ZSkgewogICAgICAgICAgICAgICAgYXZnX2JpdHJhdGUgLT0gNTsKICAgICAgICAgICAgICAgIGlmIChhdmdfYml0cmF0ZSA8IGxhc3RfYml0cmF0ZSkgewogICAgICAgICAgICAgICAgICAgIGF2Z19iaXRyYXRlID0gbGFzdF9iaXRyYXRlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQovLyAgICAgICAgcHJpbnRmICgiYXB4IGJpdHJhdGU6ICVkIChsYXN0ICVkKVxuIiwgYXZnX2JpdHJhdGUsIGxhc3RfYml0cmF0ZSk7CiAgICB9CiAgICBlbHNlIHsKICAgICAgICBhdmdfYml0cmF0ZSA9IC0xOwogICAgfQoKI2lmIDAKICAgIHN0cnVjdCB0aW1ldmFsIHRtMjsKICAgIGdldHRpbWVvZmRheSAoJnRtMiwgTlVMTCk7CgogICAgaW50IG1zID0gKHRtMi50dl9zZWMqMTAwMCt0bTIudHZfdXNlYy8xMDAwKSAtICh0bTEudHZfc2VjKjEwMDArdG0xLnR2X3VzZWMvMTAwMCk7CiAgICBwcmludGYgKCJzdHJlYW1lcl9yZWFkIHRvb2sgJWQgbXNcbiIsIG1zKTsKI2VuZGlmCgogICAgaWYgKHdhdmVmb3JtX2xpc3RlbmVycyB8fCBzcGVjdHJ1bV9saXN0ZW5lcnMpIHsKICAgICAgICBpbnQgaW5fZnJhbWVfc2l6ZSA9IChvdXRwdXQtPmZtdC5icHMgPj4gMykgKiBvdXRwdXQtPmZtdC5jaGFubmVsczsKICAgICAgICBpbnQgaW5fZnJhbWVzID0gc3ogLyBpbl9mcmFtZV9zaXplOwogICAgICAgIGRkYl93YXZlZm9ybWF0X3Qgb3V0X2ZtdCA9IHsKICAgICAgICAgICAgLmJwcyA9IDMyLAogICAgICAgICAgICAuY2hhbm5lbHMgPSBvdXRwdXQtPmZtdC5jaGFubmVscywKICAgICAgICAgICAgLnNhbXBsZXJhdGUgPSBvdXRwdXQtPmZtdC5zYW1wbGVyYXRlLAogICAgICAgICAgICAuY2hhbm5lbG1hc2sgPSBvdXRwdXQtPmZtdC5jaGFubmVsbWFzaywKICAgICAgICAgICAgLmlzX2Zsb2F0ID0gMSwKICAgICAgICAgICAgLmlzX2JpZ2VuZGlhbiA9IDAKICAgICAgICB9OwoKICAgICAgICBmbG9hdCB0ZW1wX2F1ZGlvX2RhdGFbaW5fZnJhbWVzICogb3V0X2ZtdC5jaGFubmVsc107CiAgICAgICAgcGNtX2NvbnZlcnQgKCZvdXRwdXQtPmZtdCwgYnl0ZXMsICZvdXRfZm10LCAoY2hhciAqKXRlbXBfYXVkaW9fZGF0YSwgc3opOwogICAgICAgIGRkYl9hdWRpb19kYXRhX3QgZGF0YTsKICAgICAgICBkYXRhLmZtdCA9ICZvdXRfZm10OwogICAgICAgIGRhdGEuZGF0YSA9IHRlbXBfYXVkaW9fZGF0YTsKICAgICAgICBkYXRhLm5mcmFtZXMgPSBpbl9mcmFtZXM7CiAgICAgICAgbXV0ZXhfbG9jayAod2RsX211dGV4KTsKICAgICAgICBmb3IgKHdhdmVkYXRhX2xpc3RlbmVyX3QgKmwgPSB3YXZlZm9ybV9saXN0ZW5lcnM7IGw7IGwgPSBsLT5uZXh0KSB7CiAgICAgICAgICAgIGwtPmNhbGxiYWNrIChsLT5jdHgsICZkYXRhKTsKICAgICAgICB9CiAgICAgICAgbXV0ZXhfdW5sb2NrICh3ZGxfbXV0ZXgpOwoKICAgICAgICBpZiAob3V0X2ZtdC5jaGFubmVscyAhPSBhdWRpb19kYXRhX2NoYW5uZWxzIHx8ICFzcGVjdHJ1bV9saXN0ZW5lcnMpIHsKICAgICAgICAgICAgYXVkaW9fZGF0YV9maWxsID0gMDsKICAgICAgICAgICAgYXVkaW9fZGF0YV9jaGFubmVscyA9IG91dF9mbXQuY2hhbm5lbHM7CiAgICAgICAgfQoKICAgICAgICBpZiAoc3BlY3RydW1fbGlzdGVuZXJzKSB7CiAgICAgICAgICAgIGludCByZW1haW5pbmcgPSBpbl9mcmFtZXM7CiAgICAgICAgICAgIGRvIHsKICAgICAgICAgICAgICAgIGludCBzeiA9IEREQl9GUkVRX0JBTkRTICogMiAtYXVkaW9fZGF0YV9maWxsOwogICAgICAgICAgICAgICAgc3ogPSBtaW4gKHN6LCByZW1haW5pbmcpOwogICAgICAgICAgICAgICAgZm9yIChpbnQgYyA9IDA7IGMgPCBhdWRpb19kYXRhX2NoYW5uZWxzOyBjKyspIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKGludCBzID0gMDsgcyA8IHN6OyBzKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXVkaW9fZGF0YVtEREJfRlJFUV9CQU5EUyAqIDIgKiBjICsgYXVkaW9fZGF0YV9maWxsICsgc10gPSB0ZW1wX2F1ZGlvX2RhdGFbKGluX2ZyYW1lcy1yZW1haW5pbmcgKyBzKSAqIGF1ZGlvX2RhdGFfY2hhbm5lbHMgKyBjXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyAgICAgICAgICAgIG1lbWNweSAoJmF1ZGlvX2RhdGFbYXVkaW9fZGF0YV9maWxsXSwgJnRlbXBfYXVkaW9fZGF0YVtpbl9mcmFtZXMtcmVtYWluaW5nXSwgc3ogKiBzaXplb2YgKGZsb2F0KSk7CiAgICAgICAgICAgICAgICBhdWRpb19kYXRhX2ZpbGwgKz0gc3o7CiAgICAgICAgICAgICAgICByZW1haW5pbmcgLT0gc3o7CiAgICAgICAgICAgICAgICBpZiAoYXVkaW9fZGF0YV9maWxsID09IEREQl9GUkVRX0JBTkRTICogMikgewogICAgICAgICAgICAgICAgICAgIGZvciAoaW50IGMgPSAwOyBjIDwgYXVkaW9fZGF0YV9jaGFubmVsczsgYysrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNhbGNfZnJlcSAoJmF1ZGlvX2RhdGFbRERCX0ZSRVFfQkFORFMgKiAyICogY10sICZmcmVxX2RhdGFbRERCX0ZSRVFfQkFORFMgKiBjXSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGRkYl9hdWRpb19kYXRhX3QgZGF0YTsKICAgICAgICAgICAgICAgICAgICBkYXRhLmZtdCA9ICZvdXRfZm10OwogICAgICAgICAgICAgICAgICAgIGRhdGEuZGF0YSA9IGZyZXFfZGF0YTsKICAgICAgICAgICAgICAgICAgICBkYXRhLm5mcmFtZXMgPSBEREJfRlJFUV9CQU5EUzsKICAgICAgICAgICAgICAgICAgICBtdXRleF9sb2NrICh3ZGxfbXV0ZXgpOwogICAgICAgICAgICAgICAgICAgIGZvciAod2F2ZWRhdGFfbGlzdGVuZXJfdCAqbCA9IHNwZWN0cnVtX2xpc3RlbmVyczsgbDsgbCA9IGwtPm5leHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbC0-Y2FsbGJhY2sgKGwtPmN0eCwgJmRhdGEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBtdXRleF91bmxvY2sgKHdkbF9tdXRleCk7CiAgICAgICAgICAgICAgICAgICAgYXVkaW9fZGF0YV9maWxsID0gMDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSB3aGlsZSAocmVtYWluaW5nID4gMCk7CiAgICAgICAgfQogICAgfQoKICAgIGlmICghb3V0cHV0LT5oYXNfdm9sdW1lKSB7CiAgICAgICAgaW50IG11bHQgPSAxLWF1ZGlvX2lzX211dGUgKCk7CiAgICAgICAgY2hhciAqc3RyZWFtID0gYnl0ZXM7CiAgICAgICAgaW50IGJ5dGVzcmVhZCA9IHN6OwogICAgICAgIGlmIChvdXRwdXQtPmZtdC5icHMgPT0gMTYpIHsKICAgICAgICAgICAgbXVsdCAqPSAxMDAwOwogICAgICAgICAgICBpbnQxNl90IGl2b2x1bWUgPSB2b2x1bWVfZ2V0X2FtcCAoKSAqIG11bHQ7CiAgICAgICAgICAgIGlmIChpdm9sdW1lICE9IDEwMDApIHsKICAgICAgICAgICAgICAgIGludCBoYWxmID0gYnl0ZXNyZWFkLzI7CiAgICAgICAgICAgICAgICBmb3IgKGludCBpID0gMDsgaSA8IGhhbGY7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGludDE2X3Qgc2FtcGxlID0gKigoaW50MTZfdCopc3RyZWFtKTsKICAgICAgICAgICAgICAgICAgICAqKChpbnQxNl90KilzdHJlYW0pID0gKGludDE2X3QpKCgoaW50MzJfdClzYW1wbGUpICogaXZvbHVtZSAvIDEwMDApOwogICAgICAgICAgICAgICAgICAgIHN0cmVhbSArPSAyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKG91dHB1dC0-Zm10LmJwcyA9PSA4KSB7CiAgICAgICAgICAgIG11bHQgKj0gMjU1OwogICAgICAgICAgICBpbnQxNl90IGl2b2x1bWUgPSB2b2x1bWVfZ2V0X2FtcCAoKSAqIG11bHQ7CiAgICAgICAgICAgIGlmIChpdm9sdW1lICE9IDI1NSkgewogICAgICAgICAgICAgICAgZm9yIChpbnQgaSA9IDA7IGkgPCBieXRlc3JlYWQ7IGkrKykgewogICAgICAgICAgICAgICAgICAgICpzdHJlYW0gPSAoaW50OF90KSgoKGludDMyX3QpKCpzdHJlYW0pKSAqIGl2b2x1bWUgLyAxMDAwKTsKICAgICAgICAgICAgICAgICAgICBzdHJlYW0rKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlIGlmIChvdXRwdXQtPmZtdC5icHMgPT0gMjQpIHsKICAgICAgICAgICAgbXVsdCAqPSAxMDAwOwogICAgICAgICAgICBpbnQxNl90IGl2b2x1bWUgPSB2b2x1bWVfZ2V0X2FtcCAoKSAqIG11bHQ7CiAgICAgICAgICAgIGlmIChpdm9sdW1lICE9IDEwMDApIHsKICAgICAgICAgICAgICAgIGludCB0aGlyZCA9IGJ5dGVzcmVhZC8zOwogICAgICAgICAgICAgICAgZm9yIChpbnQgaSA9IDA7IGkgPCB0aGlyZDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgICAgaW50MzJfdCBzYW1wbGUgPSAoKHVuc2lnbmVkIGNoYXIpc3RyZWFtWzBdKSB8ICgodW5zaWduZWQgY2hhcilzdHJlYW1bMV08PDgpIHwgKHN0cmVhbVsyXTw8MTYpOwogICAgICAgICAgICAgICAgICAgIGludDMyX3QgbmV3c2FtcGxlID0gKGludDY0X3Qpc2FtcGxlICogaXZvbHVtZSAvIDEwMDA7CiAgICAgICAgICAgICAgICAgICAgc3RyZWFtWzBdID0gKG5ld3NhbXBsZSYweDAwMDBmZik7CiAgICAgICAgICAgICAgICAgICAgc3RyZWFtWzFdID0gKG5ld3NhbXBsZSYweDAwZmYwMCk-Pjg7CiAgICAgICAgICAgICAgICAgICAgc3RyZWFtWzJdID0gKG5ld3NhbXBsZSYweGZmMDAwMCk-PjE2OwogICAgICAgICAgICAgICAgICAgIHN0cmVhbSArPSAzOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGVsc2UgaWYgKG91dHB1dC0-Zm10LmJwcyA9PSAzMiAmJiAhb3V0cHV0LT5mbXQuaXNfZmxvYXQpIHsKICAgICAgICAgICAgbXVsdCAqPSAxMDAwOwogICAgICAgICAgICBpbnQxNl90IGl2b2x1bWUgPSB2b2x1bWVfZ2V0X2FtcCAoKSAqIG11bHQ7CiAgICAgICAgICAgIGlmIChpdm9sdW1lICE9IDEwMDApIHsKICAgICAgICAgICAgICAgIGZvciAoaW50IGkgPSAwOyBpIDwgYnl0ZXNyZWFkLzQ7IGkrKykgewogICAgICAgICAgICAgICAgICAgIGludDMyX3Qgc2FtcGxlID0gKigoaW50MzJfdCopc3RyZWFtKTsKICAgICAgICAgICAgICAgICAgICBpbnQzMl90IG5ld3NhbXBsZSA9IChpbnQ2NF90KXNhbXBsZSAqIGl2b2x1bWUgLyAxMDAwOwogICAgICAgICAgICAgICAgICAgICooKGludDMyX3QqKXN0cmVhbSkgPSBuZXdzYW1wbGU7CiAgICAgICAgICAgICAgICAgICAgc3RyZWFtICs9IDQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZWxzZSBpZiAob3V0cHV0LT5mbXQuYnBzID09IDMyICYmIG91dHB1dC0-Zm10LmlzX2Zsb2F0KSB7CiAgICAgICAgICAgIGZsb2F0IGZ2b2x1bWUgPSB2b2x1bWVfZ2V0X2FtcCAoKSAqICgxLWF1ZGlvX2lzX211dGUgKCkpOwogICAgICAgICAgICBpZiAoZnZvbHVtZSAhPSAxLmYpIHsKICAgICAgICAgICAgICAgIGZvciAoaW50IGkgPSAwOyBpIDwgYnl0ZXNyZWFkLzQ7IGkrKykgewogICAgICAgICAgICAgICAgICAgICooKGZsb2F0KilzdHJlYW0pID0gKCooKGZsb2F0KilzdHJlYW0pKSAqIGZ2b2x1bWU7CiAgICAgICAgICAgICAgICAgICAgc3RyZWFtICs9IDQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuIHN6Owp9CgpzdGF0aWMgaW50CnN0cmVhbWVyX2dldF9maWxsICh2b2lkKSB7CiAgICByZXR1cm4gc3RyZWFtZXJfcmluZ2J1Zi5yZW1haW5pbmc7Cn0KCmludApzdHJlYW1lcl9va190b19yZWFkIChpbnQgbGVuKSB7CiAgICBEQl9vdXRwdXRfdCAqb3V0cHV0ID0gcGx1Z19nZXRfb3V0cHV0ICgpOwogICAgaWYgKGZvcm1hdGNoYW5nZWQgJiYgYnl0ZXNfdW50aWxfbmV4dF9zb25nIDw9IDAgJiYgbGVuID49IDApIHsKICAgICAgICBzdHJlYW1lcl9zZXRfb3V0cHV0X2Zvcm1hdCAoKTsKICAgICAgICBmb3JtYXRjaGFuZ2VkID0gMDsKICAgIH0KICAgIGlmIChsZW4gPj0gMCAmJiAoYnl0ZXNfdW50aWxfbmV4dF9zb25nID4gMCB8fCBzdHJlYW1lcl9yaW5nYnVmLnJlbWFpbmluZyA-PSAobGVuKjIpKSkgewogICAgICAgIHJldHVybiAxOwogICAgfQogICAgZWxzZSB7CiAgICAgICAgcmV0dXJuIDEtc3RyZWFtZXJfYnVmZmVyaW5nOwogICAgfQogICAgcmV0dXJuIDA7Cn0KCnZvaWQKc3RyZWFtZXJfY29uZmlnY2hhbmdlZCAodm9pZCkgewogICAgcmVwbGF5Z2Fpbl9zZXQgKGNvbmZfZ2V0X2ludCAoInJlcGxheWdhaW5fbW9kZSIsIDApLCBjb25mX2dldF9pbnQgKCJyZXBsYXlnYWluX3NjYWxlIiwgMSksIGNvbmZfZ2V0X2Zsb2F0ICgicmVwbGF5Z2Fpbl9wcmVhbXAiLCAwKSwgY29uZl9nZXRfZmxvYXQgKCJnbG9iYWxfcHJlYW1wIiwgMCkpOwogICAgcGxfc2V0X29yZGVyIChjb25mX2dldF9pbnQgKCJwbGF5YmFjay5vcmRlciIsIDApKTsKICAgIGlmIChwbGF5aW5nX3RyYWNrKSB7CiAgICAgICAgcGxheWluZ190cmFjay0-cGxheWVkID0gMTsKICAgIH0KICAgIGludCBjb25mX2F1dG9jb252XzhfdG9fMTYgPSBjb25mX2dldF9pbnQgKCJzdHJlYW1lci44X3RvXzE2IiwgMSk7CiAgICBpZiAoY29uZl9hdXRvY29udl84X3RvXzE2ICE9IGF1dG9jb252XzhfdG9fMTYpIHsKICAgICAgICBhdXRvY29udl84X3RvXzE2ID0gY29uZl9hdXRvY29udl84X3RvXzE2OwogICAgICAgIGZvcm1hdGNoYW5nZWQgPSAxOwogICAgICAgIHN0cmVhbWVyX3Jlc2V0ICgxKTsKICAgIH0KICAgIGludCBjb25mX2F1dG9jb252XzE2X3RvXzI0ID0gY29uZl9nZXRfaW50ICgic3RyZWFtZXIuMTZfdG9fMjQiLDApOwogICAgaWYgKGNvbmZfYXV0b2NvbnZfMTZfdG9fMjQgIT0gYXV0b2NvbnZfMTZfdG9fMjQpIHsKICAgICAgICBhdXRvY29udl8xNl90b18yNCA9IGNvbmZfYXV0b2NvbnZfMTZfdG9fMjQ7CiAgICAgICAgZm9ybWF0Y2hhbmdlZCA9IDE7CiAgICAgICAgc3RyZWFtZXJfcmVzZXQgKDEpOwogICAgfQoKICAgIHRyYWNlX2J1ZmZlcmZpbGwgPSBjb25mX2dldF9pbnQgKCJzdHJlYW1lci50cmFjZV9idWZmZXJfZmlsbCIsMCk7CgogICAgc3RvcF9hZnRlcl9jdXJyZW50ID0gY29uZl9nZXRfaW50ICgicGxheWxpc3Quc3RvcF9hZnRlcl9jdXJyZW50IiwgMCk7CiAgICBzdG9wX2FmdGVyX2FsYnVtID0gY29uZl9nZXRfaW50ICgicGxheWxpc3Quc3RvcF9hZnRlcl9hbGJ1bSIsIDApOwoKICAgIGNoYXIgbWFwc3RyWzIwNDhdOwogICAgZGVhZGJlZWYtPmNvbmZfZ2V0X3N0ciAoIm5ldHdvcmsuY3RtYXBwaW5nIiwgRERCX0RFRkFVTFRfQ1RNQVBQSU5HLCBtYXBzdHIsIHNpemVvZiAobWFwc3RyKSk7CiAgICBpZiAoc3RyY21wIChtYXBzdHIsIGNvbmZfbmV0d29ya19jdG1hcHBpbmcpKSB7CiAgICAgICAgY3RtYXBfaW5pdCAoKTsKICAgIH0KCiAgICBjb25mX3N0cmVhbWVyX25vc2xlZXAgPSBjb25mX2dldF9pbnQgKCJzdHJlYW1lci5ub3NsZWVwIiwgMCk7Cn0KCnN0YXRpYyB2b2lkCnN0cmVhbWVyX3BsYXlfY3VycmVudF90cmFja19yZWFsICh2b2lkKSB7CiAgICBwbGF5bGlzdF90ICpwbHQgPSBwbHRfZ2V0X2N1cnIgKCk7CiAgICBEQl9vdXRwdXRfdCAqb3V0cHV0ID0gcGx1Z19nZXRfb3V0cHV0ICgpOwogICAgaWYgKG91dHB1dC0-c3RhdGUgKCkgPT0gT1VUUFVUX1NUQVRFX1BBVVNFRCAmJiBwbGF5aW5nX3RyYWNrKSB7CiAgICAgICAgaWYgKGlzX3JlbW90ZV9zdHJlYW0gKHBsYXlpbmdfdHJhY2spICYmIHBsX2dldF9pdGVtX2R1cmF0aW9uIChwbGF5aW5nX3RyYWNrKSA8IDApIHsKICAgICAgICAgICAgc3RyZWFtZXJfcmVzZXQgKDEpOwogICAgICAgICAgICBzdHJlYW1lcl9zZXRfY3VycmVudCAoTlVMTCk7CiAgICAgICAgICAgIHN0cmVhbWVyX3NldF9jdXJyZW50IChwbGF5aW5nX3RyYWNrKTsKICAgICAgICAgICAgaWYgKGZpbGVpbmZvICYmIG1lbWNtcCAoJm9yaWdfb3V0cHV0X2Zvcm1hdCwgJmZpbGVpbmZvLT5mbXQsIHNpemVvZiAoZGRiX3dhdmVmb3JtYXRfdCkpKSB7CiAgICAgICAgICAgICAgICBtZW1jcHkgKCZvdXRwdXRfZm9ybWF0LCAmZmlsZWluZm8tPmZtdCwgc2l6ZW9mIChkZGJfd2F2ZWZvcm1hdF90KSk7CiAgICAgICAgICAgICAgICBtZW1jcHkgKCZvcmlnX291dHB1dF9mb3JtYXQsICZmaWxlaW5mby0-Zm10LCBzaXplb2YgKGRkYl93YXZlZm9ybWF0X3QpKTsKICAgICAgICAgICAgICAgIHN0cmVhbWVyX3NldF9vdXRwdXRfZm9ybWF0ICgpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIC8vIHVucGF1c2UgY3VycmVudGx5IHBhdXNlZCB0cmFjawogICAgICAgIG91dHB1dC0-dW5wYXVzZSAoKTsKICAgICAgICBtZXNzYWdlcHVtcF9wdXNoIChEQl9FVl9QQVVTRUQsIDAsIDAsIDApOwogICAgfQogICAgZWxzZSBpZiAocGx0LT5jdXJyZW50X3Jvd1tQTF9NQUlOXSAhPSAtMSkgewogICAgICAgIC8vIHBsYXkgY3VycmVudGx5IHNlbGVjdGVkIHRyYWNrIGluIGN1cnJlbnQgcGxheWxpc3QKICAgICAgICBvdXRwdXQtPnN0b3AgKCk7CiAgICAgICAgLy8gZ2V0IG5leHQgc29uZyBpbiBxdWV1ZQogICAgICAgIGludCBpZHggPSAtMTsKICAgICAgICBwbGF5SXRlbV90ICpuZXh0ID0gcGxheXF1ZXVlX2dldG5leHQgKCk7CiAgICAgICAgaWYgKG5leHQpIHsKICAgICAgICAgICAgaWR4ID0gc3RyX2dldF9pZHhfb2YgKG5leHQpOwogICAgICAgICAgICBwbGF5cXVldWVfcG9wICgpOwogICAgICAgICAgICBwbF9pdGVtX3VucmVmIChuZXh0KTsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIGlkeCA9IHBsdC0-Y3VycmVudF9yb3dbUExfTUFJTl07CiAgICAgICAgfQoKICAgICAgICBzdHJlYW1lcl9zZXRfbmV4dHNvbmdfcmVhbCAoaWR4LCAxKTsKICAgICAgICBwbF9sb2NrICgpOwogICAgICAgIGlmIChzdHJlYW1lcl9wbGF5bGlzdCkgewogICAgICAgICAgICBwbHRfdW5yZWYgKHN0cmVhbWVyX3BsYXlsaXN0KTsKICAgICAgICB9CiAgICAgICAgc3RyZWFtZXJfcGxheWxpc3QgPSBwbHQ7CiAgICAgICAgcGxfdW5sb2NrICgpOwogICAgICAgIHJldHVybjsKICAgIH0KICAgIGVsc2UgewogICAgICAgIG91dHB1dC0-c3RvcCAoKTsKICAgICAgICBzdHJlYW1lcl9tb3ZlX3RvX25leHRzb25nICgxKTsKICAgIH0KICAgIGlmIChwbHQpIHsKICAgICAgICBwbHRfdW5yZWYgKHBsdCk7CiAgICB9Cn0KCnZvaWQKc3RyZWFtZXJfcGxheV9jdXJyZW50X3RyYWNrICh2b2lkKSB7CiAgICBoYW5kbGVyX3B1c2ggKGhhbmRsZXIsIFNUUl9FVl9QTEFZX0NVUlIsIDAsIDAsIDApOwp9CgpzdHJ1Y3QgREJfZmlsZWluZm9fcyAqCnN0cmVhbWVyX2dldF9jdXJyZW50X2ZpbGVpbmZvICh2b2lkKSB7CiAgICByZXR1cm4gZmlsZWluZm87Cn0KCnN0YXRpYyB2b2lkCnN0cmVhbWVyX3NldF9jdXJyZW50X3BsYXlsaXN0X3JlYWwgKGludCBwbHQpIHsKICAgIHBsX2xvY2sgKCk7CiAgICBpZiAoc3RyZWFtZXJfcGxheWxpc3QpIHsKICAgICAgICBwbHRfdW5yZWYgKHN0cmVhbWVyX3BsYXlsaXN0KTsKICAgIH0KICAgIHN0cmVhbWVyX3BsYXlsaXN0ID0gcGx0X2dldF9mb3JfaWR4IChwbHQpOwogICAgcGxfdW5sb2NrICgpOwp9Cgp2b2lkCnN0cmVhbWVyX3NldF9jdXJyZW50X3BsYXlsaXN0IChpbnQgcGx0KSB7CiAgICBoYW5kbGVyX3B1c2ggKGhhbmRsZXIsIFNUUl9FVl9TRVRfQ1VSUl9QTFQsIDAsIHBsdCwgMCk7Cn0KCmludApzdHJlYW1lcl9nZXRfY3VycmVudF9wbGF5bGlzdCAodm9pZCkgewogICAgcGxfbG9jayAoKTsKICAgIGlmICghc3RyZWFtZXJfcGxheWxpc3QpIHsKICAgICAgICBzdHJlYW1lcl9wbGF5bGlzdCA9IHBsdF9nZXRfY3VyciAoKTsKICAgIH0KICAgIGludCBpZHggPSBwbHRfZ2V0X2lkeF9vZiAoc3RyZWFtZXJfcGxheWxpc3QpOwogICAgcGxfdW5sb2NrICgpOwogICAgcmV0dXJuIGlkeDsKfQoKdm9pZApzdHJlYW1lcl9ub3RpZnlfcGxheWxpc3RfZGVsZXRlZCAocGxheWxpc3RfdCAqcGx0KSB7CiAgICAvLyB0aGlzIGlzIG9ubHkgY2FsbGVkIGZyb20gcGxheWxpc3QgY29kZSwgbm8gbG9jayByZXF1aXJlZAogICAgaWYgKHBsdCA9PSBzdHJlYW1lcl9wbGF5bGlzdCkgewogICAgICAgIHBsdF91bnJlZiAoc3RyZWFtZXJfcGxheWxpc3QpOwogICAgICAgIHN0cmVhbWVyX3BsYXlsaXN0ID0gTlVMTDsKICAgIH0KfQoKZGRiX2RzcF9jb250ZXh0X3QgKgpzdHJlYW1lcl9nZXRfZHNwX2NoYWluICh2b2lkKSB7CiAgICByZXR1cm4gZHNwX2NoYWluOwp9CgpzdGF0aWMgZGRiX2RzcF9jb250ZXh0X3QgKgpkc3BfY2xvbmUgKGRkYl9kc3BfY29udGV4dF90ICpmcm9tKSB7CiAgICBkZGJfZHNwX2NvbnRleHRfdCAqZHNwID0gZnJvbS0-cGx1Z2luLT5vcGVuICgpOwogICAgY2hhciBwYXJhbVsyMDAwXTsKICAgIGlmIChmcm9tLT5wbHVnaW4tPm51bV9wYXJhbXMpIHsKICAgICAgICBpbnQgbiA9IGZyb20tPnBsdWdpbi0-bnVtX3BhcmFtcyAoKTsKICAgICAgICBmb3IgKGludCBpID0gMDsgaSA8IG47IGkrKykgewogICAgICAgICAgICBmcm9tLT5wbHVnaW4tPmdldF9wYXJhbSAoZnJvbSwgaSwgcGFyYW0sIHNpemVvZiAocGFyYW0pKTsKICAgICAgICAgICAgZHNwLT5wbHVnaW4tPnNldF9wYXJhbSAoZHNwLCBpLCBwYXJhbSk7CiAgICAgICAgfQogICAgfQogICAgZHNwLT5lbmFibGVkID0gZnJvbS0-ZW5hYmxlZDsKICAgIHJldHVybiBkc3A7Cn0KCnN0YXRpYyB2b2lkCnN0cmVhbWVyX3NldF9kc3BfY2hhaW5fcmVhbCAoZGRiX2RzcF9jb250ZXh0X3QgKmNoYWluKSB7CiAgICBzdHJlYW1lcl9kc3BfY2hhaW5fZnJlZSAoZHNwX2NoYWluKTsKICAgIGRzcF9jaGFpbiA9IGNoYWluOwogICAgZXEgPSBOVUxMOwogICAgc3RyZWFtZXJfZHNwX3Bvc3Rpbml0ICgpOwogICAgaWYgKGZpbGVpbmZvKSB7CiAgICAgICAgbWVtY3B5ICgmb3JpZ19vdXRwdXRfZm9ybWF0LCAmZmlsZWluZm8tPmZtdCwgc2l6ZW9mIChkZGJfd2F2ZWZvcm1hdF90KSk7CiAgICAgICAgbWVtY3B5ICgmb3V0cHV0X2Zvcm1hdCwgJmZpbGVpbmZvLT5mbXQsIHNpemVvZiAoZGRiX3dhdmVmb3JtYXRfdCkpOwogICAgICAgIGZvcm1hdGNoYW5nZWQgPSAxOwogICAgfQoKICAgIHN0cmVhbWVyX2RzcF9jaGFpbl9zYXZlKCk7CiAgICBzdHJlYW1lcl9yZXNldCAoMSk7CgogICAgREJfb3V0cHV0X3QgKm91dHB1dCA9IHBsdWdfZ2V0X291dHB1dCAoKTsKICAgIGlmIChwbGF5aW5nX3RyYWNrICYmIG91dHB1dC0-c3RhdGUgKCkgIT0gT1VUUFVUX1NUQVRFX1NUT1BQRUQpIHsKICAgICAgICBzdHJlYW1lcl9zZXRfc2VlayAocGxheXBvcyk7CiAgICB9CiAgICBtZXNzYWdlcHVtcF9wdXNoIChEQl9FVl9EU1BDSEFJTkNIQU5HRUQsIDAsIDAsIDApOwp9Cgp2b2lkCnN0cmVhbWVyX3NldF9kc3BfY2hhaW4gKGRkYl9kc3BfY29udGV4dF90ICpjaGFpbikgewogICAgZGRiX2RzcF9jb250ZXh0X3QgKm5ld19jaGFpbiA9IE5VTEw7CiAgICBkZGJfZHNwX2NvbnRleHRfdCAqdGFpbCA9IE5VTEw7CiAgICB3aGlsZSAoY2hhaW4pIHsKICAgICAgICBkZGJfZHNwX2NvbnRleHRfdCAqbmV3ID0gZHNwX2Nsb25lIChjaGFpbik7CiAgICAgICAgaWYgKHRhaWwpIHsKICAgICAgICAgICAgdGFpbC0-bmV4dCA9IG5ldzsKICAgICAgICAgICAgdGFpbCA9IG5ldzsKICAgICAgICB9CiAgICAgICAgZWxzZSB7CiAgICAgICAgICAgIG5ld19jaGFpbiA9IHRhaWwgPSBuZXc7CiAgICAgICAgfQogICAgICAgIGNoYWluID0gY2hhaW4tPm5leHQ7CiAgICB9CgogICAgaGFuZGxlcl9wdXNoIChoYW5kbGVyLCBTVFJfRVZfU0VUX0RTUF9DSEFJTiwgKHVpbnRwdHJfdCluZXdfY2hhaW4sIDAsIDApOwp9Cgp2b2lkCnN0cmVhbWVyX2dldF9vdXRwdXRfZm9ybWF0IChkZGJfd2F2ZWZvcm1hdF90ICpmbXQpIHsKICAgIG1lbWNweSAoZm10LCAmb3V0cHV0X2Zvcm1hdCwgc2l6ZW9mIChkZGJfd2F2ZWZvcm1hdF90KSk7Cn0KCnN0YXRpYyB2b2lkCnN0cmVhbWVyX25vdGlmeV9vcmRlcl9jaGFuZ2VkX3JlYWwgKGludCBwcmV2X29yZGVyLCBpbnQgbmV3X29yZGVyKSB7CiAgICBpZiAocHJldl9vcmRlciAhPSBQTEFZQkFDS19PUkRFUl9TSFVGRkxFX0FMQlVNUyAmJiBuZXdfb3JkZXIgPT0gUExBWUJBQ0tfT1JERVJfU0hVRkZMRV9BTEJVTVMpIHsKICAgICAgICBzdHJlYW1lcl9sb2NrICgpOwogICAgICAgIHBsYXlJdGVtX3QgKmN1cnIgPSBwbGF5aW5nX3RyYWNrOwogICAgICAgIGlmIChjdXJyKSB7CgogICAgICAgICAgICBwbF9sb2NrICgpOwogICAgICAgICAgICBjb25zdCBjaGFyICphbGIgPSBwbF9maW5kX21ldGFfcmF3IChjdXJyLCAiYWxidW0iKTsKICAgICAgICAgICAgY29uc3QgY2hhciAqYXJ0ID0gcGxfZmluZF9tZXRhX3JhdyAoY3VyciwgImFydGlzdCIpOwogICAgICAgICAgICBwbGF5SXRlbV90ICpuZXh0ID0gY3Vyci0-cHJldltQTF9NQUlOXTsKICAgICAgICAgICAgd2hpbGUgKG5leHQpIHsKICAgICAgICAgICAgICAgIGlmIChhbGIgPT0gcGxfZmluZF9tZXRhX3JhdyAobmV4dCwgImFsYnVtIikgJiYgYXJ0ID09IHBsX2ZpbmRfbWV0YV9yYXcgKG5leHQsICJhcnRpc3QiKSkgewogICAgICAgICAgICAgICAgICAgIG5leHQtPnBsYXllZCA9IDE7CiAgICAgICAgICAgICAgICAgICAgbmV4dCA9IG5leHQtPnByZXZbUExfTUFJTl07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBwbF91bmxvY2sgKCk7CiAgICAgICAgfQogICAgICAgIHN0cmVhbWVyX3VubG9jayAoKTsKICAgIH0KfQoKdm9pZApzdHJlYW1lcl9ub3RpZnlfb3JkZXJfY2hhbmdlZCAoaW50IHByZXZfb3JkZXIsIGludCBuZXdfb3JkZXIpIHsKICAgIGhhbmRsZXJfcHVzaCAoaGFuZGxlciwgU1RSX0VWX09SREVSX0NIQU5HRUQsIDAsIHByZXZfb3JkZXIsIG5ld19vcmRlcik7Cn0KCnZvaWQKdmlzX3dhdmVmb3JtX2xpc3RlbiAodm9pZCAqY3R4LCB2b2lkICgqY2FsbGJhY2spKHZvaWQgKmN0eCwgZGRiX2F1ZGlvX2RhdGFfdCAqZGF0YSkpIHsKICAgIG11dGV4X2xvY2sgKHdkbF9tdXRleCk7CiAgICB3YXZlZGF0YV9saXN0ZW5lcl90ICpsID0gbWFsbG9jIChzaXplb2YgKHdhdmVkYXRhX2xpc3RlbmVyX3QpKTsKICAgIG1lbXNldCAobCwgMCwgc2l6ZW9mICh3YXZlZGF0YV9saXN0ZW5lcl90KSk7CiAgICBsLT5jdHggPSBjdHg7CiAgICBsLT5jYWxsYmFjayA9IGNhbGxiYWNrOwogICAgbC0-bmV4dCA9IHdhdmVmb3JtX2xpc3RlbmVyczsKICAgIHdhdmVmb3JtX2xpc3RlbmVycyA9IGw7CiAgICBtdXRleF91bmxvY2sgKHdkbF9tdXRleCk7Cn0KCnZvaWQKdmlzX3dhdmVmb3JtX3VubGlzdGVuICh2b2lkICpjdHgpIHsKICAgIG11dGV4X2xvY2sgKHdkbF9tdXRleCk7CiAgICB3YXZlZGF0YV9saXN0ZW5lcl90ICpsLCAqcHJldiA9IE5VTEw7CiAgICBmb3IgKGwgPSB3YXZlZm9ybV9saXN0ZW5lcnM7IGw7IHByZXYgPSBsLCBsID0gbC0-bmV4dCkgewogICAgICAgIGlmIChsLT5jdHggPT0gY3R4KSB7CiAgICAgICAgICAgIGlmIChwcmV2KSB7CiAgICAgICAgICAgICAgICBwcmV2LT5uZXh0ID0gbC0-bmV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHdhdmVmb3JtX2xpc3RlbmVycyA9IGwtPm5leHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZnJlZSAobCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgIH0KICAgIG11dGV4X3VubG9jayAod2RsX211dGV4KTsKfQoKdm9pZAp2aXNfc3BlY3RydW1fbGlzdGVuICh2b2lkICpjdHgsIHZvaWQgKCpjYWxsYmFjaykodm9pZCAqY3R4LCBkZGJfYXVkaW9fZGF0YV90ICpkYXRhKSkgewogICAgbXV0ZXhfbG9jayAod2RsX211dGV4KTsKICAgIHdhdmVkYXRhX2xpc3RlbmVyX3QgKmwgPSBtYWxsb2MgKHNpemVvZiAod2F2ZWRhdGFfbGlzdGVuZXJfdCkpOwogICAgbWVtc2V0IChsLCAwLCBzaXplb2YgKHdhdmVkYXRhX2xpc3RlbmVyX3QpKTsKICAgIGwtPmN0eCA9IGN0eDsKICAgIGwtPmNhbGxiYWNrID0gY2FsbGJhY2s7CiAgICBsLT5uZXh0ID0gc3BlY3RydW1fbGlzdGVuZXJzOwogICAgc3BlY3RydW1fbGlzdGVuZXJzID0gbDsKICAgIG11dGV4X3VubG9jayAod2RsX211dGV4KTsKfQoKdm9pZAp2aXNfc3BlY3RydW1fdW5saXN0ZW4gKHZvaWQgKmN0eCkgewogICAgbXV0ZXhfbG9jayAod2RsX211dGV4KTsKICAgIHdhdmVkYXRhX2xpc3RlbmVyX3QgKmwsICpwcmV2ID0gTlVMTDsKICAgIGZvciAobCA9IHNwZWN0cnVtX2xpc3RlbmVyczsgbDsgcHJldiA9IGwsIGwgPSBsLT5uZXh0KSB7CiAgICAgICAgaWYgKGwtPmN0eCA9PSBjdHgpIHsKICAgICAgICAgICAgaWYgKHByZXYpIHsKICAgICAgICAgICAgICAgIHByZXYtPm5leHQgPSBsLT5uZXh0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgc3BlY3RydW1fbGlzdGVuZXJzID0gbC0-bmV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICBmcmVlIChsKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgfQogICAgbXV0ZXhfdW5sb2NrICh3ZGxfbXV0ZXgpOwp9Cgp2b2lkCnN0cmVhbWVyX3NldF9zdHJlYW1lcl9wbGF5bGlzdCAocGxheWxpc3RfdCAqcGx0KSB7CiAgICBpZiAoc3RyZWFtZXJfcGxheWxpc3QpIHsKICAgICAgICBwbHRfdW5yZWYgKHN0cmVhbWVyX3BsYXlsaXN0KTsKICAgIH0KICAgIHN0cmVhbWVyX3BsYXlsaXN0ID0gcGx0OwogICAgaWYgKHN0cmVhbWVyX3BsYXlsaXN0KSB7CiAgICAgICAgcGx0X3JlZiAoc3RyZWFtZXJfcGxheWxpc3QpOwogICAgfQp9CgpzdHJ1Y3QgaGFuZGxlcl9zICoKc3RyZWFtZXJfZ2V0X2hhbmRsZXIgKHZvaWQpIHsKICAgIHJldHVybiBoYW5kbGVyOwp9Cgp2b2lkCnN0cmVhbWVyX3NldF9wbGF5aW5nX3RyYWNrIChwbGF5SXRlbV90ICppdCkgewogICAgaWYgKHBsYXlpbmdfdHJhY2spIHsKICAgICAgICBwbF9pdGVtX3VucmVmIChwbGF5aW5nX3RyYWNrKTsKICAgIH0KICAgIHBsYXlpbmdfdHJhY2sgPSBpdDsKICAgIGlmIChwbGF5aW5nX3RyYWNrKSB7CiAgICAgICAgcGxfaXRlbV9yZWYgKHBsYXlpbmdfdHJhY2spOwogICAgfQp9Cg=="}